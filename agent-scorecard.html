<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declarative Agent Coherence & Gravity Dashboard</title>
    <!-- Version: 2026-01-19-v2 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Segoe UI Web (West European)', 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', sans-serif;
            background: #faf9f8;
            color: #201f1e;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Top Banner */
        .sidebar {
            background: linear-gradient(white, white) padding-box, linear-gradient(90deg, #A78BFA, #FBBF24, #10B981, #60A5FA) border-box;
            border: 1.5px solid transparent;
            color: #4C1D95;
            padding: 10px 20px;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.08);
            flex-shrink: 0;
        }

        .sidebar h1 {
            font-size: 1.75em;
            margin-bottom: 2px;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar .tagline {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 500;
        }

        .principle-section {
            margin-bottom: 12px;
        }

        .principle-section h3 {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            opacity: 0.7;
            margin-bottom: 8px;
            font-weight: 700;
            text-align: center;
        }

        .principles-grid {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            gap: 6px;
            margin-bottom: 10px;
        }

        .tier-group {
            margin-bottom: 12px;
            border-left: 3px solid;
            padding-left: 10px;
        }

        .tier-group.tier1 { border-left-color: #DC2626; }
        .tier-group.tier2 { border-left-color: #F59E0B; }
        .tier-group.tier3 { border-left-color: #10B981; }
        .tier-group.tier4 { border-left-color: #8B5CF6; }

        .tier-header {
            display: flex;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 4px;
        }

        .tier-icon {
            font-size: 0.9em;
        }

        .tier-title {
            font-size: 0.8em;
            font-weight: 700;
            color: #1f2937;
        }

        .tier-subtitle {
            font-size: 0.65em;
            color: #9ca3af;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-left: 4px;
        }

        .tier-description {
            font-size: 0.7em;
            color: #6b7280;
            line-height: 1.3;
            margin-bottom: 3px;
        }

        .tier-guidance {
            font-size: 0.65em;
            color: #047857;
            background: #ecfdf5;
            padding: 3px 6px;
            border-radius: 3px;
            margin-bottom: 6px;
            line-height: 1.2;
            border: 1px solid #d1fae5;
        }

        .tier-guidance strong {
            font-weight: 600;
        }

        .tier-principles {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .principle-item {
            padding: 3px 8px;
            background: #f9fafb;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
            text-align: left;
            min-width: 0;
            font-size: 0.7em;
            color: #4b5563;
            font-weight: 500;
        }

        .principle-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
        }

        .principle-item.active {
            background: #ede9fe;
            border-color: #a78bfa;
            color: #6d28d9;
        }

        .principle-item .name {
            font-weight: 600;
            font-size: 1em;
            color: inherit;
        }

        .principle-item .description {
            display: none;
        }

        .stats-summary {
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
            border: 2px solid #E9D5FF;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        .stats-summary h3 {
            display: none;
        }

        .stat-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-row .label {
            opacity: 0.7;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            color: #5B21B6;
        }

        .stat-row .value {
            font-weight: 700;
            font-size: 1.4em;
            color: #7C3AED;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border-radius: 50%;
            border: 2px solid #A78BFA;
            background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
        }

        .header {
            padding: 8px 20px;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, #A78BFA, #FBBF24, #10B981, #60A5FA) 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-left p {
            font-size: 0.9em;
            color: #6b7280;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #A78BFA 0%, #8B5CF6 100%);
            color: white;
            font-family: 'Segoe UI', 'Segoe UI Web', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.35);
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #f9fafb;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            grid-template-areas: "left right";
            gap: 20px;
            align-items: start;
            width: 100%;
        }

        /* Input Panel */
        .input-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            grid-area: left;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-header h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-info {
            background: #F3E9FF;
            color: #6D28D9;
        }

        .form-group {
            margin-bottom: 8px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
            color: #374151;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95em;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #A78BFA;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.15);
        }

        .form-group textarea {
            min-height: 90px;
            resize: vertical;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
        }

        .form-hint {
            font-size: 0.8em;
            color: #6b7280;
            margin-top: 3px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .principle-weights-list {
            margin-top: 15px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.85em;
        }

        .principle-weights-list h4 {
            font-size: 0.9em;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .weight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 6px;
            border: 1px solid #e5e7eb;
        }

        .weight-item:last-child {
            margin-bottom: 0;
        }

        .weight-item-name {
            font-weight: 500;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weight-item-value {
            font-weight: 700;
            color: #5B21B6;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .weight-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .weight-badge.fixed {
            background: #fee2e2;
            color: #991b1b;
        }

        .weight-badge.variable {
            background: #dbeafe;
            color: #1e40af;
        }

        .weight-min-req {
            font-size: 0.8em;
            color: #6b7280;
            font-weight: normal;
        }

        .quick-templates {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .template-chip {
            padding: 4px 10px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-chip:hover {
            background: #F3E8FF;
            border-color: #C4B5FD;
            color: #5B21B6;
        }

        /* Domain Profile Styles */
        .domain-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }

        .domain-badge.legal {
            background: #dbeafe;
            color: #1e40af;
        }

        .domain-badge.sales {
            background: #dcfce7;
            color: #166534;
        }

        .domain-badge.healthcare {
            background: #fce7f3;
            color: #9f1239;
        }

        .domain-badge.creative {
            background: #fef3c7;
            color: #92400e;
        }

        .domain-badge.finance {
            background: #e0e7ff;
            color: #3730a3;
        }

        .principle-weight-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }

        .weight-critical {
            background: #dc2626;
            box-shadow: 0 0 4px rgba(220, 38, 38, 0.5);
        }

        .weight-high {
            background: #f59e0b;
        }

        .weight-normal {
            background: #10b981;
        }

        .weight-low {
            background: #9ca3af;
        }

        /* Live Feedback */
        .live-feedback {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.85em;
        }

        .live-feedback-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-feedback-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .feedback-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 4px;
        }

        .feedback-item.success {
            background: #d1fae5;
            color: #065f46;
        }

        .feedback-item.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .feedback-item.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .feedback-icon {
            font-size: 1em;
            flex-shrink: 0;
        }

        .principle-status-icon {
            font-size: 1em;
            margin-left: 4px;
        }

        .live-score-preview {
            background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%);
            padding: 10px;
            border-radius: 6px;
            margin-top: 12px;
            text-align: center;
            font-weight: 600;
            color: #5B21B6;
        }

        /* Results Panel */
        .results-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .score-card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .score-circle {
            width: 100px;
            height: 100px;
            margin: 0 auto 12px;
            position: relative;
        }

        .score-circle .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5em;
            font-weight: 700;
        }

        .score-label {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .score-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .score-status.excellent {
            background: #d1fae5;
            color: #065f46;
        }

        .score-status.good {
            background: #E0E7FF;
            color: #4C1D95;
        }

        .score-status.needs-work {
            background: #fef3c7;
            color: #92400e;
        }

        .score-status.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .principle-scores {
            margin-top: 15px;
        }

        .principle-score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .principle-score-item:last-child {
            border-bottom: none;
        }

        .principle-score-item .name {
            font-size: 0.85em;
            color: #374151;
            font-weight: 600;
            flex: 1;
        }

        .principle-icon {
            font-size: 1.8em;
            min-width: 40px;
            text-align: right;
        }

        .principle-icon.pass {
            color: #10b981;
        }

        .principle-icon.fail {
            color: #ef4444;
        }

        /* Issues Panel */
        .issues-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .issue-item {
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #fafafa;
        }

        .issue-item.critical {
            border-left-color: #dc2626;
            background: #fef2f2;
        }

        .issue-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .issue-item.info {
            border-left-color: #8B5CF6;
            background: #FAF5FF;
        }

        .issue-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .issue-icon {
            font-size: 1.2em;
        }

        .issue-title {
            font-weight: 600;
            font-size: 0.95em;
            color: #1f2937;
        }

        .issue-description {
            font-size: 0.85em;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .issue-remediation {
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.8em;
            color: #059669;
            border: 1px solid #d1fae5;
        }

        .issue-remediation strong {
            display: block;
            margin-bottom: 4px;
            color: #047857;
        }

        /* Platform Gravity - now inline */
        .platform-gravity-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f3f4f6;
        }

        .platform-gravity-section h3 {
            font-size: 0.9em;
            margin-bottom: 15px;
            color: #6b7280;
            text-align: left;
        }

        .gravity-score-circle {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            position: relative;
        }

        .gravity-score-circle svg {
            transform: rotate(-90deg);
        }

        .gravity-score-circle .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: 700;
            color: #7C3AED;
        }

        .gravity-score-label {
            text-align: center;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #6b7280;
        }

        .gravity-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75em;
            font-weight: 600;
            background: linear-gradient(135deg, #E9D5FF 0%, #DDD6FE 100%);
            color: #5B21B6;
            margin-bottom: 15px;
        }

        .gravity-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .gravity-metric {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .gravity-metric-label {
            font-size: 0.82em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4C1D95;
        }

        .gravity-metric-bar {
            position: relative;
            width: 100%;
            height: 3px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: visible;
            margin-top: 6px;
        }

        .gravity-metric-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: #7C3AED;
            border-radius: 2px;
            transition: width 0.6s ease-out;
        }

        .gravity-metric-value {
            position: absolute;
            right: 0;
            top: -18px;
            font-weight: 700;
            font-size: 0.7em;
            color: #6b7280;
        }

        .platform-recommendation {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.85em;
            line-height: 1.5;
            border: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .platform-recommendation strong {
            display: block;
            margin-bottom: 6px;
            font-size: 0.95em;
            color: #374151;
        }

        .capability-matches {
            background: #F5F5F5;
            border-left: 4px solid #9CA3AF;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #4B5563;
        }

        .capability-matches strong {
            display: block;
            margin-bottom: 10px;
            color: #374151;
        }

        .capability-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
        }

        .capability-item:last-child {
            border-bottom: none;
        }

        /* History Panel */
        .history-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Right Sidebar Container */
        .right-sidebar {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            grid-area: right;
            width: 380px;
        }

        .history-panel .card {
            flex-shrink: 0;
        }

        .results-panel .card {
            flex-shrink: 0;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
        }

        .history-list::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 3px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: #C4B5FD;
            border-radius: 3px;
        }

        .history-list::-webkit-scrollbar-thumb:hover {
            background: #A78BFA;
        }

        .history-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }

        .history-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .history-item-name {
            font-weight: 600;
            font-size: 0.9em;
            color: #1f2937;
        }

        .history-item-score {
            font-weight: 700;
            font-size: 0.85em;
        }

        .history-item-meta {
            font-size: 0.75em;
            color: #6b7280;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.2em;
            margin-bottom: 8px;
            color: #6b7280;
        }

        .empty-state p {
            font-size: 0.9em;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 300px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #A78BFA;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1em;
            color: #374151;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .right-sidebar {
                max-height: none;
            }
            
            .principles-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .principles-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.4s ease-out;
        }

        /* Export Panel */
        .export-options {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .export-btn {
            flex: 1;
            padding: 8px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #e5e7eb;
        }

        /* Logic Trace */
        .logic-trace-section {
            margin-top: 20px;
            border-top: 2px solid #f3f4f6;
            padding-top: 20px;
        }

        .logic-trace-toggle {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%);
            border: 2px solid #C4B5FD;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #5B21B6;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logic-trace-toggle:hover {
            background: linear-gradient(135deg, #E9D5FF 0%, #DDD6FE 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
        }

        .logic-trace-content {
            display: none;
            margin-top: 15px;
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            color: #e2e8f0;
            line-height: 1.8;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .logic-trace-content.visible {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .trace-header {
            color: #a78bfa;
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 15px;
            border-bottom: 1px solid #475569;
            padding-bottom: 10px;
        }

        .trace-step {
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 3px solid #475569;
        }

        .trace-step-label {
            color: #94a3b8;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .trace-step-content {
            color: #cbd5e1;
            padding-left: 15px;
        }

        .trace-highlight {
            color: #fbbf24;
            font-weight: 600;
        }

        .trace-success {
            color: #10b981;
            font-weight: 600;
        }

        .trace-warning {
            color: #f59e0b;
            font-weight: 600;
        }

        .trace-info {
            color: #60a5fa;
            font-weight: 600;
        }

        .trace-conclusion {
            margin-top: 15px;
            padding: 12px;
            background: #0f172a;
            border-radius: 6px;
            border-left: 4px solid #a78bfa;
        }

        .trace-conclusion-label {
            color: #a78bfa;
            font-weight: 700;
            margin-bottom: 6px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>‚ú® Declarative Agent Coherence & Gravity Dashboard</h1>
            <p class="tagline">Evaluate agents against platform principles & strategic fit</p>

            <div class="stats-summary">
                <div class="stat-row">
                    <span class="value" id="totalEvals">0</span>
                    <span class="label">Evaluations</span>
                </div>
                <div class="stat-row">
                    <span class="value" id="certifiedCount">0</span>
                    <span class="label">Ecosystem Mismatch</span>
                </div>
                <div class="stat-row">
                    <span class="value" id="platformCandidates">0</span>
                    <span class="label">Platform Candidates</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-area">
                <div class="content-grid">
                    <!-- Input Panel -->
                    <div class="input-panel">
                        <!-- Agent Specification Card -->
                        <div class="card">
                            <div class="card-header">
                                <h3>Choose Agent to Evaluate</h3>
                            </div>

                            <div class="quick-templates">
                                <div class="template-chip" onclick="loadAgentProfile('finance')">üí∞ Finance</div>
                                <div class="template-chip" onclick="loadAgentProfile('legal')">‚öñÔ∏è Legal</div>
                                <div class="template-chip" onclick="loadAgentProfile('sales')">üíº Sales</div>
                                <div class="template-chip" onclick="loadAgentProfile('academic')">üéì Academic</div>
                                <div class="template-chip" onclick="loadAgentProfile('analyst')">üìä Analyst</div>
                                <div class="template-chip" onclick="loadAgentProfile('projectmanager')">üìã Project Manager</div>
                                <div class="template-chip" onclick="clearForm()" style="cursor: pointer;">üîÑ</div>
                            </div>

                            <div class="form-group">
                                <label>Agent Name & Details</label>
                                <div class="form-hint">Provide agent name, instructions, manifest, code, behavior description, and sample interactions</div>
                                <textarea id="featureDescription" placeholder="Agent Name: [Your agent name]&#10;&#10;Description: [Your agent's functionality, behavior, data handling, and user interactions...]" style="min-height: 120px;"></textarea>
                                
                                <!-- Live Feedback Panel -->
                                <div id="liveFeedback" class="live-feedback" style="display: none;">
                                    <div class="live-feedback-header">
                                        <span>‚ö°</span>
                                        <span>Live Principle Check</span>
                                    </div>
                                    <div id="liveFeedbackList" class="live-feedback-list"></div>
                                    <div id="liveScorePreview" class="live-score-preview" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 4-Tier Framework Display -->
                        <div class="card" style="margin-top: 8px; background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #A78BFA, #FBBF24, #10B981, #60A5FA) border-box; border: 1.5px solid transparent; border-radius: 12px;">
                            <div class="card-header">
                                <h3>4-Tier Framework for Coherent Agents</h3>
                            </div>
                            <p style="font-size: 0.85em; color: #6b7280; margin-bottom: 15px; padding: 0 20px;">Platform vs Agent responsibility boundaries for building coherent ecosystems</p>
                            
                            <div id="tierPrinciplesDisplay" style="padding: 0 20px 20px 20px;"></div>
                        </div>
                    </div>

                    <!-- Right Sidebar: Results + History -->
                    <div class="right-sidebar" style="background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #A78BFA, #FBBF24, #10B981, #60A5FA) border-box; border: 1.5px solid transparent; border-radius: 12px;">
                        <!-- Results Panel -->
                        <div class="results-panel">
                            <!-- Assessment Scores Card -->
                            <div class="card score-card" id="scoreCard" style="display: none;">
                                <h3 id="scoreCardTitle" style="font-size: 1.05em; font-weight: 600; color: #1f2937; margin-bottom: 20px; text-align: center;">Assessment Scores</h3>
                                
                                <div style="display: flex; gap: 40px; justify-content: center; align-items: center;">
                                    <!-- Coherence Score -->
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.9em; font-weight: 600; color: #6b7280; margin-bottom: 10px;">Coherence</div>
                                        <div style="font-size: 3em; margin-bottom: 10px; font-weight: 400; opacity: 0.9;" id="scoreValue">--</div>
                                        <div style="font-size: 0.75em; color: #9ca3af; margin-top: 5px;" id="coherenceLabel">Platform Alignment</div>
                                    </div>

                                    <!-- Platform Gravity Score -->
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.9em; font-weight: 600; color: #6b7280; margin-bottom: 10px;">Platform Gravity</div>
                                        <div style="font-size: 3em; margin-bottom: 10px; font-weight: 400; opacity: 0.9;" id="gravityValue">--</div>
                                        <div style="font-size: 0.75em; color: #9ca3af; margin-top: 5px;" id="gravityLabel">Strategic Fit</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Principle Breakdown Card -->
                            <div class="card" id="principleCard" style="display: none;">
                                <div class="principle-scores" id="principleScores"></div>
                                <div id="gravityAssessmentSection"></div>
                            </div>
                        </div>

                        <!-- History Panel -->
                        <div class="history-panel">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Evaluation History</h3>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <select id="historyDropdown" style="padding: 12px; font-size: 0.9em;">
                                        <option value="">No evaluations yet</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 4-Tier Framework for Coherent Agent Ecosystem
        const TIER_FRAMEWORK = {
            'tier1': {
                name: 'Tier 1: Foundational DNA',
                subtitle: 'Platform-Exclusive Services',
                description: 'Non-negotiable platform capabilities that agents MUST NOT reimplement. These are the building blocks provided by the platform.',
                guidance: 'Agent implementors: Leverage these platform services via APIs. Do not build custom authentication, consent UI, or handoff logic.',
                color: '#DC2626',
                icon: 'üèóÔ∏è'
            },
            'tier2': {
                name: 'Tier 2: Adaptive Bridge',
                subtitle: 'Hybrid Responsibilities',
                description: 'Shared capabilities where platform provides infrastructure and agents customize behavior for their domain.',
                guidance: 'Agent implementors: Use platform services as foundation, add domain-specific logic on top. Example: Platform handles grounding service, you define domain data sources.',
                color: '#F59E0B',
                icon: 'üåâ'
            },
            'tier3': {
                name: 'Tier 3: Vertical Nuance',
                subtitle: 'Agent Autonomy',
                description: 'Domain-specific capabilities where agents have full autonomy to differentiate and innovate.',
                guidance: 'Agent implementors: Full creative control here. Implement custom business logic, tone, workflows specific to your domain.',
                color: '#10B981',
                icon: 'üéØ'
            },
            'tier4': {
                name: 'Tier 4: Domain Readiness',
                subtitle: 'Quality Gates',
                description: 'Pre-launch operational requirements. These are not features but quality gates every agent must pass before shipping.',
                guidance: 'Agent implementors: Complete this checklist before production launch. These ensure operational excellence at scale.',
                color: '#8B5CF6',
                icon: 'üö¶'
            }
        };

        // Platform Principles Schema with Tier Assignments
        const PRINCIPLES = {
            // TIER 1: Foundational DNA (Platform-Exclusive)
            'identity-iam': {
                name: 'Identity & IAM',
                tier: 'tier1',
                weight: 0.10,
                checks: [
                    { id: 'sso-integration', name: 'SSO Integration', weight: 0.4 },
                    { id: 'rbac-enforcement', name: 'RBAC Enforcement', weight: 0.3 },
                    { id: 'token-management', name: 'Token Management', weight: 0.3 }
                ]
            },
            'consent-ui': {
                name: 'Consent UI (JIT)',
                tier: 'tier1',
                weight: 0.08,
                checks: [
                    { id: 'jit-consent', name: 'Just-in-Time Consent', weight: 0.4 },
                    { id: 'clear-permissions', name: 'Clear Permission Dialogs', weight: 0.3 },
                    { id: 'granular-control', name: 'Granular Control', weight: 0.3 }
                ]
            },
            'intent-continuity': {
                name: 'Intent Continuity',
                tier: 'tier1',
                weight: 0.09,
                checks: [
                    { id: 'intent-preservation', name: 'Intent Preservation', weight: 0.4 },
                    { id: 'context-handoff', name: 'Context Handoff', weight: 0.3 },
                    { id: 'session-continuity', name: 'Session Continuity', weight: 0.3 }
                ]
            },
            'ux-signature': {
                name: 'UX Signature',
                tier: 'tier1',
                weight: 0.08,
                checks: [
                    { id: 'progressive-disclosure', name: 'Progressive Disclosure', weight: 0.3 },
                    { id: 'consistent-typography', name: 'Consistent Typography', weight: 0.2 },
                    { id: 'copilot-patterns', name: 'Copilot Patterns', weight: 0.3 },
                    { id: 'visual-hierarchy', name: 'Visual Hierarchy', weight: 0.2 }
                ]
            },
            'platform-resilience': {
                name: 'Platform Resilience',
                tier: 'tier1',
                weight: 0.07,
                checks: [
                    { id: 'circuit-breaker', name: 'Circuit Breaker', weight: 0.4 },
                    { id: 'retry-logic', name: 'Retry Logic', weight: 0.3 },
                    { id: 'fallback-service', name: 'Fallback Service', weight: 0.3 }
                ]
            },
            'telemetry-observability': {
                name: 'Telemetry & Observability',
                tier: 'tier1',
                weight: 0.06,
                checks: [
                    { id: 'structured-logging', name: 'Structured Logging', weight: 0.3 },
                    { id: 'performance-metrics', name: 'Performance Metrics', weight: 0.4 },
                    { id: 'error-tracking', name: 'Error Tracking', weight: 0.3 }
                ]
            },
            'rate-limiting': {
                name: 'Rate Limiting & Abuse Prevention',
                tier: 'tier1',
                weight: 0.05,
                checks: [
                    { id: 'request-throttling', name: 'Request Throttling', weight: 0.4 },
                    { id: 'abuse-detection', name: 'Abuse Detection', weight: 0.3 },
                    { id: 'quota-management', name: 'Quota Management', weight: 0.3 }
                ]
            },
            'safety-guardrails': {
                name: 'Safety Guardrails',
                tier: 'tier1',
                weight: 0.07,
                checks: [
                    { id: 'content-filtering', name: 'Content Filtering', weight: 0.4 },
                    { id: 'harmful-prevention', name: 'Harmful Content Prevention', weight: 0.3 },
                    { id: 'policy-enforcement', name: 'Policy Enforcement', weight: 0.3 }
                ]
            },
            'agent-registry': {
                name: 'Agent Registry & Discovery',
                tier: 'tier1',
                weight: 0.04,
                checks: [
                    { id: 'agent-metadata', name: 'Agent Metadata', weight: 0.4 },
                    { id: 'capability-publishing', name: 'Capability Publishing', weight: 0.3 },
                    { id: 'version-management', name: 'Version Management', weight: 0.3 }
                ]
            },
            'reasoning-framework': {
                name: 'Reasoning Framework',
                tier: 'tier1',
                weight: 0.06,
                checks: [
                    { id: 'chain-of-thought', name: 'Chain-of-Thought Support', weight: 0.4 },
                    { id: 'reasoning-transparency', name: 'Reasoning Transparency', weight: 0.3 },
                    { id: 'multi-step-reasoning', name: 'Multi-Step Reasoning', weight: 0.3 }
                ]
            },
            'response-ux': {
                name: 'Response UX Patterns',
                tier: 'tier1',
                weight: 0.06,
                checks: [
                    { id: 'streaming-support', name: 'Streaming Support', weight: 0.4 },
                    { id: 'structured-output', name: 'Structured Output', weight: 0.3 },
                    { id: 'adaptive-cards', name: 'Adaptive Cards', weight: 0.3 }
                ]
            },
            'thinking-ux': {
                name: 'Thinking UX (Process Visibility)',
                tier: 'tier1',
                weight: 0.05,
                checks: [
                    { id: 'thinking-indicators', name: 'Thinking Indicators', weight: 0.4 },
                    { id: 'progress-feedback', name: 'Progress Feedback', weight: 0.3 },
                    { id: 'step-visualization', name: 'Step Visualization', weight: 0.3 }
                ]
            },
            'handoff-protocol': {
                name: 'Handoff Protocol',
                tier: 'tier1',
                weight: 0.06,
                checks: [
                    { id: 'context-preservation', name: 'Context Preservation', weight: 0.4 },
                    { id: 'seamless-transfer', name: 'Seamless Transfer', weight: 0.3 },
                    { id: 'state-continuity', name: 'State Continuity', weight: 0.3 }
                ]
            },
            'orchestration-core': {
                name: 'Orchestration & Coordination',
                tier: 'tier1',
                weight: 0.06,
                checks: [
                    { id: 'multi-agent-routing', name: 'Multi-Agent Routing', weight: 0.4 },
                    { id: 'task-orchestration', name: 'Task Orchestration', weight: 0.3 },
                    { id: 'coordination-protocol', name: 'Coordination Protocol', weight: 0.3 }
                ]
            },
            
            // TIER 2: Adaptive Bridge (Hybrid)
            'grounding-service': {
                name: 'Grounding Service',
                tier: 'tier2',
                weight: 0.12,
                checks: [
                    { id: 'data-source-integration', name: 'Data Source Integration', weight: 0.3 },
                    { id: 'accurate-retrieval', name: 'Accurate Retrieval', weight: 0.4 },
                    { id: 'source-citation', name: 'Source Citation', weight: 0.3 }
                ]
            },
            'steerability-infra': {
                name: 'Steerability Infrastructure',
                tier: 'tier2',
                weight: 0.08,
                checks: [
                    { id: 'state-management', name: 'State Management', weight: 0.35 },
                    { id: 'user-preferences', name: 'User Preferences', weight: 0.35 },
                    { id: 'adaptive-behavior', name: 'Adaptive Behavior', weight: 0.3 }
                ]
            },
            'transparency-framework': {
                name: 'Transparency Framework',
                tier: 'tier2',
                weight: 0.08,
                checks: [
                    { id: 'agent-identity', name: 'Clear Agent Identity', weight: 0.4 },
                    { id: 'capability-disclosure', name: 'Capability Disclosure', weight: 0.3 },
                    { id: 'limitation-clarity', name: 'Limitation Clarity', weight: 0.3 }
                ]
            },
            'confidence-calibration': {
                name: 'Confidence Calibration',
                tier: 'tier2',
                weight: 0.06,
                checks: [
                    { id: 'confidence-scoring', name: 'Confidence Scoring', weight: 0.4 },
                    { id: 'uncertainty-communication', name: 'Uncertainty Communication', weight: 0.3 },
                    { id: 'threshold-tuning', name: 'Threshold Tuning', weight: 0.3 }
                ]
            },
            'hallucination-detection': {
                name: 'Hallucination Detection',
                tier: 'tier2',
                weight: 0.07,
                checks: [
                    { id: 'fact-verification', name: 'Fact Verification', weight: 0.4 },
                    { id: 'consistency-check', name: 'Consistency Check', weight: 0.3 },
                    { id: 'source-validation', name: 'Source Validation', weight: 0.3 }
                ]
            },
            'context-window': {
                name: 'Context Window Management',
                tier: 'tier2',
                weight: 0.05,
                checks: [
                    { id: 'context-prioritization', name: 'Context Prioritization', weight: 0.4 },
                    { id: 'memory-efficiency', name: 'Memory Efficiency', weight: 0.3 },
                    { id: 'conversation-history', name: 'Conversation History', weight: 0.3 }
                ]
            },
            'multi-agent': {
                name: 'Multi-Agent Orchestration',
                tier: 'tier2',
                weight: 0.06,
                checks: [
                    { id: 'agent-routing', name: 'Agent Routing', weight: 0.4 },
                    { id: 'coordination-protocol', name: 'Coordination Protocol', weight: 0.3 },
                    { id: 'task-delegation', name: 'Task Delegation', weight: 0.3 }
                ]
            },
            
            // TIER 3: Vertical Nuance (Agent Autonomy)
            'domain-logic': {
                name: 'Domain Business Logic',
                tier: 'tier3',
                weight: 0.10,
                checks: [
                    { id: 'business-rules', name: 'Business Rules', weight: 0.4 },
                    { id: 'domain-workflows', name: 'Domain Workflows', weight: 0.3 },
                    { id: 'vertical-expertise', name: 'Vertical Expertise', weight: 0.3 }
                ]
            },
            'domain-ux': {
                name: 'Domain UX (D-UX)',
                tier: 'tier3',
                weight: 0.08,
                checks: [
                    { id: 'domain-visuals', name: 'Domain-Specific Visuals', weight: 0.4 },
                    { id: 'workflow-optimization', name: 'Workflow Optimization', weight: 0.3 },
                    { id: 'user-journey', name: 'User Journey Design', weight: 0.3 }
                ]
            },
            'tone-modulation': {
                name: 'Tone Modulation',
                tier: 'tier3',
                weight: 0.06,
                checks: [
                    { id: 'domain-appropriate', name: 'Domain-Appropriate Tone', weight: 0.5 },
                    { id: 'brand-voice', name: 'Brand Voice', weight: 0.5 }
                ]
            },
            'third-party-integration': {
                name: 'Third-Party Integration',
                tier: 'tier3',
                weight: 0.07,
                checks: [
                    { id: 'api-integration', name: 'API Integration', weight: 0.4 },
                    { id: 'data-mapping', name: 'Data Mapping', weight: 0.3 },
                    { id: 'error-handling', name: 'Error Handling', weight: 0.3 }
                ]
            },
            'caching-strategy': {
                name: 'Agent Caching Strategy',
                tier: 'tier3',
                weight: 0.04,
                checks: [
                    { id: 'cache-policy', name: 'Cache Policy', weight: 0.4 },
                    { id: 'invalidation-rules', name: 'Invalidation Rules', weight: 0.3 },
                    { id: 'performance-optimization', name: 'Performance Optimization', weight: 0.3 }
                ]
            },
            'domain-error-recovery': {
                name: 'Domain Error Recovery',
                tier: 'tier3',
                weight: 0.05,
                checks: [
                    { id: 'domain-fallbacks', name: 'Domain-Specific Fallbacks', weight: 0.4 },
                    { id: 'recovery-strategies', name: 'Recovery Strategies', weight: 0.3 },
                    { id: 'user-guidance', name: 'User Guidance', weight: 0.3 }
                ]
            },
            
            // TIER 4: Domain Readiness (Quality Gates)
            'error-recovery-gate': {
                name: 'Error Recovery Strategy',
                tier: 'tier4',
                weight: 0.06,
                checks: [
                    { id: 'graceful-degradation', name: 'Graceful Degradation', weight: 0.4 },
                    { id: 'clear-errors', name: 'Clear Error Messages', weight: 0.3 },
                    { id: 'fallback-options', name: 'Fallback Options', weight: 0.3 }
                ]
            },
            'latency-sla': {
                name: 'Latency SLA Compliance',
                tier: 'tier4',
                weight: 0.05,
                checks: [
                    { id: 'response-time', name: 'Response Time Targets', weight: 0.4 },
                    { id: 'p95-performance', name: 'P95 Performance', weight: 0.3 },
                    { id: 'timeout-handling', name: 'Timeout Handling', weight: 0.3 }
                ]
            },
            'cost-monitoring': {
                name: 'Cost Monitoring',
                tier: 'tier4',
                weight: 0.04,
                checks: [
                    { id: 'budget-tracking', name: 'Budget Tracking', weight: 0.4 },
                    { id: 'cost-alerts', name: 'Cost Alerts', weight: 0.3 },
                    { id: 'resource-optimization', name: 'Resource Optimization', weight: 0.3 }
                ]
            },
            'security-review': {
                name: 'Security Posture',
                tier: 'tier4',
                weight: 0.06,
                checks: [
                    { id: 'vulnerability-scan', name: 'Vulnerability Scanning', weight: 0.4 },
                    { id: 'penetration-test', name: 'Penetration Testing', weight: 0.3 },
                    { id: 'compliance-check', name: 'Compliance Check', weight: 0.3 }
                ]
            },
            'ab-testing': {
                name: 'A/B Testing Compliance',
                tier: 'tier4',
                weight: 0.04,
                checks: [
                    { id: 'experiment-framework', name: 'Experiment Framework', weight: 0.4 },
                    { id: 'metrics-tracking', name: 'Metrics Tracking', weight: 0.3 },
                    { id: 'statistical-rigor', name: 'Statistical Rigor', weight: 0.3 }
                ]
            },
            'feedback-loop': {
                name: 'Feedback Loop',
                tier: 'tier4',
                weight: 0.05,
                checks: [
                    { id: 'user-feedback', name: 'User Feedback Collection', weight: 0.4 },
                    { id: 'sentiment-analysis', name: 'Sentiment Analysis', weight: 0.3 },
                    { id: 'continuous-improvement', name: 'Continuous Improvement', weight: 0.3 }
                ]
            },
            'versioning': {
                name: 'Versioning & Rollback',
                tier: 'tier4',
                weight: 0.05,
                checks: [
                    { id: 'version-control', name: 'Version Control', weight: 0.4 },
                    { id: 'rollback-capability', name: 'Rollback Capability', weight: 0.3 },
                    { id: 'backward-compatibility', name: 'Backward Compatibility', weight: 0.3 }
                ]
            },
            'documentation': {
                name: 'Documentation Completeness',
                tier: 'tier4',
                weight: 0.04,
                checks: [
                    { id: 'api-docs', name: 'API Documentation', weight: 0.3 },
                    { id: 'user-guides', name: 'User Guides', weight: 0.3 },
                    { id: 'runbooks', name: 'Operational Runbooks', weight: 0.4 }
                ]
            }
        };

        // Domain-Specific Principle Profiles
        const DOMAIN_PROFILES = {
            general: {
                name: 'General Purpose',
                weights: {
                    'ux-signature': 0.20,
                    'handoff-integrity': 0.20,
                    'grounding-fidelity': 0.20,
                    'transparency': 0.10,
                    'privacy': 0.10,
                    'error-recovery': 0.05,
                    'steerability': 0.15
                },
                description: 'Balanced evaluation for general-purpose agents'
            },
            legal: {
                name: 'Legal (High Accuracy)',
                emoji: '‚öñÔ∏è',
                weights: {
                    'grounding-fidelity': 0.35,      // ‚¨ÜÔ∏è Accuracy critical
                    'transparency': 0.20,            // ‚¨ÜÔ∏è Explainability
                    'privacy': 0.15,                 // ‚¨ÜÔ∏è Confidentiality
                    'handoff-integrity': 0.10,
                    'error-recovery': 0.10,
                    'ux-signature': 0.05,            // ‚¨áÔ∏è Less critical
                    'steerability': 0.05             // ‚¨áÔ∏è Less flexible
                },
                thresholds: {
                    'grounding-fidelity': 90,        // Minimum 90% accuracy
                    'transparency': 85,
                    'privacy': 90
                },
                description: 'Prioritizes accuracy, citations, and explainability. Latency trade-offs acceptable.',
                recommendations: [
                    'Add source citations for all claims',
                    'Include confidence scores',
                    'Implement audit trail logging',
                    'Use read-only data access patterns'
                ]
            },
            sales: {
                name: 'Sales (Low Latency)',
                emoji: 'üíº',
                weights: {
                    'ux-signature': 0.30,            // ‚¨ÜÔ∏è User experience critical
                    'steerability': 0.25,            // ‚¨ÜÔ∏è Conversational flexibility
                    'handoff-integrity': 0.15,
                    'grounding-fidelity': 0.12,      // ‚¨áÔ∏è Some approximation OK
                    'transparency': 0.08,
                    'privacy': 0.05,
                    'error-recovery': 0.05
                },
                thresholds: {
                    'ux-signature': 85,
                    'steerability': 80
                },
                performanceTarget: '< 2s response time',
                description: 'Optimizes for responsiveness and user experience. Tolerates approximate answers.',
                recommendations: [
                    'Implement response streaming',
                    'Cache common queries',
                    'Use fast approximate retrieval',
                    'Prioritize conversation flow over perfection'
                ]
            },
            health: {
                name: 'Health (High Privacy)',
                emoji: 'üè•',
                weights: {
                    'privacy': 0.35,                 // ‚¨ÜÔ∏è HIPAA compliance
                    'transparency': 0.25,            // ‚¨ÜÔ∏è Medical reasoning
                    'grounding-fidelity': 0.20,      // ‚¨ÜÔ∏è Clinical accuracy
                    'error-recovery': 0.10,
                    'handoff-integrity': 0.05,
                    'ux-signature': 0.03,
                    'steerability': 0.02
                },
                thresholds: {
                    'privacy': 95,                   // Near-perfect privacy required
                    'transparency': 85,
                    'grounding-fidelity': 88
                },
                requiredDisclaimer: 'I am an AI assistant, not a medical professional. Always consult your doctor.',
                description: 'HIPAA-compliant with mandatory disclaimers. Privacy and accuracy paramount.',
                recommendations: [
                    'Add medical disclaimer to every response',
                    'Implement end-to-end encryption',
                    'Use zero-retention for PHI',
                    'Require 2FA for sensitive operations',
                    'Log all data access for audit'
                ]
            },
            academic: {
                name: 'Academic (Research Focus)',
                emoji: 'üéì',
                weights: {
                    'grounding-fidelity': 0.35,      // ‚¨ÜÔ∏è Research accuracy
                    'transparency': 0.25,            // ‚¨ÜÔ∏è Source attribution
                    'steerability': 0.15,            // Academic exploration
                    'ux-signature': 0.10,
                    'handoff-integrity': 0.08,
                    'privacy': 0.05,
                    'error-recovery': 0.02
                },
                thresholds: {
                    'grounding-fidelity': 90,        // Academic rigor required
                    'transparency': 88
                },
                description: 'Emphasizes research accuracy, citations, and academic rigor. Peer-review standards.',
                recommendations: [
                    'Provide complete citations in academic format',
                    'Include confidence intervals for data',
                    'Link to peer-reviewed sources',
                    'Support multiple citation styles (APA, MLA, Chicago)',
                    'Flag preliminary or unverified research'
                ]
            },
            analyst: {
                name: 'Analyst (Data Driven)',
                emoji: 'üìä',
                weights: {
                    'grounding-fidelity': 0.30,      // ‚¨ÜÔ∏è Data accuracy
                    'transparency': 0.25,            // ‚¨ÜÔ∏è Methodology disclosure
                    'ux-signature': 0.20,            // Clear data visualization
                    'steerability': 0.12,
                    'handoff-integrity': 0.08,
                    'privacy': 0.03,
                    'error-recovery': 0.02
                },
                thresholds: {
                    'grounding-fidelity': 85,        // Data integrity critical
                    'transparency': 80,
                    'ux-signature': 75
                },
                description: 'Optimizes for data accuracy, analytical rigor, and clear visual communication.',
                recommendations: [
                    'Show data sources and methodology',
                    'Include statistical confidence levels',
                    'Use clear charts and visualizations',
                    'Provide downloadable data tables',
                    'Document assumptions and limitations'
                ]
            },
            projectmanager: {
                name: 'Project Manager (Coordination)',
                emoji: 'üìã',
                weights: {
                    'handoff-integrity': 0.35,       // ‚¨ÜÔ∏è Context preservation critical
                    'steerability': 0.25,            // ‚¨ÜÔ∏è Adaptive planning
                    'ux-signature': 0.20,            // Clear communication
                    'transparency': 0.10,
                    'grounding-fidelity': 0.05,
                    'privacy': 0.03,
                    'error-recovery': 0.02
                },
                thresholds: {
                    'handoff-integrity': 90,         // Seamless coordination
                    'steerability': 85,
                    'ux-signature': 80
                },
                description: 'Prioritizes coordination, context handoffs, and adaptive project management.',
                recommendations: [
                    'Maintain detailed task context across sessions',
                    'Support multiple project views (Gantt, Kanban)',
                    'Enable seamless delegation and handoffs',
                    'Track dependencies and blockers',
                    'Provide status summaries and progress updates'
                ]
            },
            finance: {
                name: 'Finance (High Compliance)',
                emoji: 'üí∞',
                weights: {
                    'transparency': 0.30,            // ‚¨ÜÔ∏è Regulatory disclosure
                    'grounding-fidelity': 0.25,      // ‚¨ÜÔ∏è Accuracy for analysis
                    'privacy': 0.20,                 // ‚¨ÜÔ∏è Financial data security
                    'error-recovery': 0.10,
                    'handoff-integrity': 0.08,
                    'ux-signature': 0.05,
                    'steerability': 0.02
                },
                thresholds: {
                    'transparency': 90,              // Must disclose limitations
                    'grounding-fidelity': 85,
                    'privacy': 88
                },
                requiredDisclaimer: 'For informational purposes only, not financial advice. Consult a licensed advisor.',
                description: 'Compliance-first with mandatory disclaimers. No stock recommendations.',
                recommendations: [
                    'Add financial disclaimer to all responses',
                    'Never provide specific stock picks',
                    'Link to authoritative sources (SEC, FINRA)',
                    'Implement read-only financial data access',
                    'Require 2FA for account access'
                ]
            }
        };

        // Platform Capabilities Registry
        const PLATFORM_CAPABILITIES = [
            { name: 'Authentication', keywords: ['auth', 'login', 'sso', 'identity', 'signin'] },
            { name: 'Payment Processing', keywords: ['payment', 'checkout', 'billing', 'transaction', 'credit card'] },
            { name: 'Document Intelligence', keywords: ['ocr', 'pdf parse', 'document extract', 'receipt scan', 'text recognition'] },
            { name: 'Search & Retrieval', keywords: ['search', 'query', 'retrieve', 'find', 'lookup'] },
            { name: 'Calendar Integration', keywords: ['calendar', 'schedule', 'appointment', 'meeting', 'availability'] },
            { name: 'Email Integration', keywords: ['email', 'inbox', 'send mail', 'message'] },
            { name: 'File Storage', keywords: ['file upload', 'storage', 'cloud storage', 'save file'] },
            { name: 'User Preferences', keywords: ['preference', 'settings', 'remember', 'user profile'] },
            { name: 'Notifications', keywords: ['notify', 'alert', 'push notification', 'reminder'] },
            { name: 'Translation', keywords: ['translate', 'language', 'multilingual'] },
            { name: 'Voice Synthesis', keywords: ['text to speech', 'tts', 'voice', 'audio generation'] },
            { name: 'Image Generation', keywords: ['image gen', 'create image', 'dall-e', 'picture'] },
            { name: 'Data Encryption', keywords: ['encrypt', 'secure', 'cipher', 'crypto'] }
        ];

        // Feature Templates
        const TEMPLATES = {
            travel: {
                name: 'SmartTravel Booking Agent',
                type: 'declarative',
                instructions: `You are SmartTravel, an AI travel assistant. Always introduce yourself clearly. Request only necessary permissions with clear explanations. Present options with transparent trade-offs. Respect user privacy and data minimization principles.`,
                manifest: `{"schema_version": "v2.1",
  "name": "SmartTravel",
  "description": "AI travel booking assistant",
  "instructions": "Help users plan trips with personalized recommendations",
  "capabilities": {
    "conversation_starters": [
      "Plan a trip to Paris",
      "Find budget-friendly flights",
      "Show me weekend getaways"
    ]
  },
  "actions": [
    {"name": "searchFlights", "description": "Search for flight options"},
    {"name": "checkCalendar", "description": "Check user availability", "requires_consent": true}
  ]
}`,
                apiActions: `async function searchFlights(destination, dates) {
  // Always request consent before calendar access
  const calendarConsent = await requestPermission('Calendar.Read', 
    'I\'ll check your calendar to avoid conflicts');
  
  if (!calendarConsent) {
    // Graceful fallback: manual date entry
    return await searchWithManualDates(destination);
  }
  
  const availableDates = await graph.calendar.getFreeSlots();
  return await travelAPI.search({destination, dates: availableDates});
}`,
                description: `A travel booking agent that helps users plan trips based on their preferences and budget.

User Interaction Flow:
1. Agent introduces itself: "I'm SmartTravel, your AI travel assistant"
2. Asks for destination and dates conversationally
3. Requests calendar access with clear justification: "I'll check your calendar to avoid conflicts"
4. Shows 3-5 personalized options with clear trade-offs (price vs. convenience)
5. Uses consistent Copilot UI patterns (cards, progressive disclosure)
6. Provides clear booking steps and confirmation

Data Handling:
- Requests only necessary data (destination, dates, budget)
- Explains why each permission is needed
- Does not store payment information
- Clears temporary data after booking

Privacy:
- Just-in-time consent for calendar access
- Option to search without location data
- Clear data retention policy (30 days)`,
                trace: `User: Help me plan a trip to Paris
Agent: I'm SmartTravel, your AI travel assistant! üåç I can help you find the best options for Paris.

To give you personalized recommendations, I'd like to:
‚Ä¢ Check your calendar for available dates
‚Ä¢ Use your location to find the best departure airport

Is that okay?

User: Yes, that's fine

Agent: Great! I found you're free June 15-22. Here are 3 options:

[Shows 3 flight options with clear pricing, airlines, and trade-offs]
Option 1: Budget-friendly ($450) - 1 stop
Option 2: Balanced ($650) - Direct flight
Option 3: Premium ($890) - Direct + extra legroom

Which interests you?`
            },
            shopping: {
                name: 'PersonalShopper Agent',
                type: 'declarative',
                instructions: `You are a shopping assistant that helps find products. Use browsing history to personalize recommendations. Show product comparisons.`,
                manifest: `{"schema_version": "v2.1",
  "name": "PersonalShopper",
  "description": "AI shopping assistant",
  "capabilities": {
    "conversation_starters": [
      "Find me a laptop for design work",
      "Show budget-friendly options"
    ]
  },
  "actions": [
    {"name": "searchProducts", "description": "Search for products"},
    {"name": "trackPrices", "description": "Track price changes"}
  ]
}`,
                apiActions: `async function searchProducts(query, prefs) {
  // Check if user has browsing history enabled
  const useHistory = prefs.useHistory || true;
  
  if (useHistory) {
    return await productAPI.searchPersonalized(query, prefs);
  }
  
  return await productAPI.searchGeneric(query);
}`,
                description: `A shopping assistant that helps users find products matching their needs.

Features:
- Product recommendations based on browsing history
- Price tracking and deal alerts
- Comparison tables

UX Patterns:
- Shows multiple product options
- Progressive disclosure for details
- Card-based layout

Data Usage:
- Uses browsing history for personalization
- Tracks price changes
- Stores user preferences`,
                trace: `User: I need a new laptop for design work
Agent: Sure! Let me find you some options.

Based on "design work," here are laptops with:
‚Ä¢ High-resolution displays
‚Ä¢ Good specs
‚Ä¢ Various price points

User: Around $2000

Agent: Here are 3 options:
[Shows comparison table]

Option 1: Dell XPS 15 - $1899
Option 2: MacBook Pro 14" - $1999
Option 3: Lenovo ThinkPad X1 - $1850`
            },
            health: {
                name: 'WellnessCoach Agent',
                type: 'declarative',
                instructions: `You are a wellness and fitness coach. Provide personalized fitness plans and nutrition guidance. Track user progress and send motivational reminders.`,
                manifest: `{"schema_version": "v2.1",
  "name": "WellnessCoach",
  "description": "AI wellness and fitness coach",
  "capabilities": {
    "conversation_starters": [
      "Help me start exercising",
      "Create a fitness plan"
    ]
  },
  "actions": [
    {"name": "createFitnessPlan", "description": "Generate personalized fitness recommendations"},
    {"name": "trackProgress", "description": "Track wellness goals"}
  ]
}`,
                apiActions: `async function trackProgress(userId) {
  // Get user's health data
  const healthData = await healthAPI.getProgress(userId);
  return healthData;
}`,
                description: `A health and wellness coaching agent that provides fitness and nutrition guidance.

Features:
- Personalized fitness plans
- Nutrition recommendations
- Progress tracking
- Daily motivational messages

UX Approach:
- Supportive tone
- Goal-setting
- Daily check-ins
- Achievement celebrations

Data Handling:
- Stores user progress
- Tracks exercise history
- Records nutrition logs`,
                trace: `User: Help me start exercising
Agent: Great! Let's get you moving! üí™

Tell me about your current activity level?
User: Pretty sedentary, desk job

Agent: Perfect! I'll create a custom plan for you.

Week 1: 30-min cardio, 5x/week
Week 2: Add strength training
Week 3: Increase intensity

I'll track your progress and send daily reminders at 7am.`
            },
            finance: {
                name: 'FinanceAdvisor Pro',
                type: 'declarative',
                instructions: `You are a financial advisor AI. Help users with investment decisions, budgeting, and portfolio management. Provide stock recommendations based on market analysis.`,
                manifest: `{"schema_version": "v2.1",
  "name": "FinanceAdvisor",
  "description": "AI financial advisor",
  "capabilities": {
    "conversation_starters": [
      "Analyze my portfolio",
      "Recommend stocks"
    ]
  },
  "actions": [
    {"name": "calculateBudget", "description": "Budget calculator"},
    {"name": "viewAccounts", "description": "View account balances"},
    {"name": "recommendStocks", "description": "Provide investment recommendations"}
  ]
}`,
                apiActions: `async function viewAccounts(userId) {
  // Access financial data
  return await financialAPI.getAccounts(userId);
}`,
                description: `A financial advisor agent that helps users manage investments and budgets.

Features:
- Portfolio analysis
- Stock recommendations
- Budget tracking
- Market insights

Capabilities:
- Analyzes user's financial accounts
- Provides personalized investment advice
- Tracks spending patterns
- Sends market alerts

Data Access:
- Views account balances
- Analyzes transaction history
- Monitors investment performance`,
                trace: `User: Should I invest in stocks?
Agent: Absolutely! Based on your profile, I recommend:

üìà Top Picks:
1. TechCorp - Strong growth potential
2. BioPharm Inc - Undervalued
3. Energy Solutions - Stable returns

I've analyzed your accounts and you have $15,000 available for investment. I suggest:
- 60% in growth stocks
- 30% in index funds
- 10% in crypto

Want me to create automatic buy orders?`
            }
        };

        // State Management
        let evaluationHistory = [];
        let currentEvaluation = null;
        let liveCheckTimeout = null;

        // Live Validation Functions
        function checkPrincipleInText(principle, text) {
            const lowerText = text.toLowerCase();
            const checks = [];

            switch(principle) {
                case 'transparency':
                    if (lowerText.includes('i\'m') || lowerText.includes('i am')) {
                        checks.push({ pass: true, message: '‚úì Agent introduces itself' });
                    } else if (text.length > 50) {
                        checks.push({ pass: false, message: '‚ö† Consider: "I\'m [AgentName], your..."' });
                    }
                    break;

                case 'privacy':
                    if (lowerText.includes('consent') || lowerText.includes('permission') || lowerText.includes('is that okay')) {
                        checks.push({ pass: true, message: '‚úì Requests consent' });
                    } else if (lowerText.includes('data') || lowerText.includes('access')) {
                        checks.push({ pass: false, message: '‚ö† Add just-in-time consent prompt' });
                    }

                    if (lowerText.includes('minimization') || lowerText.includes('only necessary')) {
                        checks.push({ pass: true, message: '‚úì Data minimization mentioned' });
                    }
                    break;

                case 'grounding-fidelity':
                    if (lowerText.includes('citation') || lowerText.includes('source') || lowerText.includes('reference')) {
                        checks.push({ pass: true, message: '‚úì Mentions sources/citations' });
                    } else if (text.length > 100) {
                        checks.push({ pass: false, message: '‚ö† Consider adding source citations' });
                    }
                    break;

                case 'error-recovery':
                    if (lowerText.includes('fallback') || lowerText.includes('graceful') || lowerText.includes('error')) {
                        checks.push({ pass: true, message: '‚úì Error handling mentioned' });
                    } else if (text.length > 100) {
                        checks.push({ pass: false, message: '‚ö† Add error recovery strategy' });
                    }
                    break;

                case 'ux-signature':
                    if (lowerText.includes('progressive') || lowerText.includes('cards') || lowerText.includes('copilot')) {
                        checks.push({ pass: true, message: '‚úì Copilot UX patterns mentioned' });
                    }
                    break;
            }

            return checks;
        }

        function performLiveCheck() {
            const description = document.getElementById('featureDescription').value;
            const combinedText = description;

            if (combinedText.trim().length < 20) {
                document.getElementById('liveFeedback').style.display = 'none';
                updatePrincipleIndicators({});
                return;
            }

            document.getElementById('liveFeedback').style.display = 'block';

            const feedback = [];
            const principleStatus = {};

            // Check each principle
            ['transparency', 'privacy', 'grounding-fidelity', 'error-recovery', 'ux-signature'].forEach(principle => {
                const checks = checkPrincipleInText(principle, combinedText);
                checks.forEach(check => {
                    feedback.push({
                        type: check.pass ? 'success' : 'warning',
                        message: check.message
                    });
                });

                // Determine principle status
                const passCount = checks.filter(c => c.pass).length;
                const totalCount = checks.length;
                if (totalCount === 0) {
                    principleStatus[principle] = 'neutral';
                } else if (passCount === totalCount) {
                    principleStatus[principle] = 'pass';
                } else if (passCount > 0) {
                    principleStatus[principle] = 'partial';
                } else {
                    principleStatus[principle] = 'fail';
                }
            });

            // Render feedback
            const feedbackList = document.getElementById('liveFeedbackList');
            feedbackList.innerHTML = '';

            if (feedback.length === 0) {
                feedbackList.innerHTML = '<div class="feedback-item" style="color: #6b7280;">Keep writing to see principle checks...</div>';
            } else {
                feedback.slice(0, 5).forEach(item => {
                    const div = document.createElement('div');
                    div.className = `feedback-item ${item.type}`;
                    div.innerHTML = `<span class="feedback-icon">${item.type === 'success' ? '‚úì' : '‚ö†'}</span><span>${item.message}</span>`;
                    feedbackList.appendChild(div);
                });
            }

            // Show estimated score
            const passCount = feedback.filter(f => f.type === 'success').length;
            const totalCount = feedback.length;
            if (totalCount > 0) {
                const estimatedScore = Math.round(50 + (passCount / totalCount) * 40);
                document.getElementById('liveScorePreview').style.display = 'block';
                document.getElementById('liveScorePreview').textContent = `Estimated Score: ${estimatedScore}/100`;
            }

            // Update principle indicators in top banner
            updatePrincipleIndicators(principleStatus);
        }

        function updatePrincipleIndicators(status) {
            document.querySelectorAll('.principle-item').forEach(item => {
                const principle = item.dataset.principle;
                const nameElement = item.querySelector('.name');
                
                // Remove existing status icons
                const existingIcon = nameElement.querySelector('.principle-status-icon');
                if (existingIcon) {
                    existingIcon.remove();
                }

                // Add new status icon
                if (status[principle]) {
                    const icon = document.createElement('span');
                    icon.className = 'principle-status-icon';
                    switch(status[principle]) {
                        case 'pass':
                            icon.textContent = '‚úì';
                            icon.style.color = '#10b981';
                            break;
                        case 'partial':
                            icon.textContent = '‚óã';
                            icon.style.color = '#f59e0b';
                            break;
                        case 'fail':
                            icon.textContent = '‚óã';
                            icon.style.color = '#dc2626';
                            break;
                    }
                    nameElement.appendChild(icon);
                }
            });
        }

        function onDescriptionChange() {
            // Clear hidden data when user types
            const textarea = document.getElementById('featureDescription');
            if (textarea.value.trim().length > 0) {
                textarea.removeAttribute('data-hidden-content');
            }
            
            // Debounce the live check
            clearTimeout(liveCheckTimeout);
            liveCheckTimeout = setTimeout(performLiveCheck, 500);
        }

        // Render Tier-Grouped Principles
        function renderTierPrinciples() {
            const container = document.getElementById('tierPrinciplesDisplay');
            if (!container) return;

            let html = '';
            
            // Group principles by tier
            const tierGroups = { tier1: [], tier2: [], tier3: [], tier4: [] };
            Object.entries(PRINCIPLES).forEach(([key, principle]) => {
                if (principle.tier) {
                    tierGroups[principle.tier].push({ key, ...principle });
                }
            });

            // Render each tier
            Object.entries(TIER_FRAMEWORK).forEach(([tierKey, tierInfo]) => {
                const principles = tierGroups[tierKey];
                if (principles.length === 0) return;

                html += `
                    <div class="tier-group ${tierKey}">
                        <div class="tier-header">
                            <span class="tier-icon">${tierInfo.icon}</span>
                            <div>
                                <div class="tier-title">${tierInfo.name}</div>
                                <div class="tier-subtitle">${tierInfo.subtitle}</div>
                            </div>
                        </div>
                        <div class="tier-description">${tierInfo.description}</div>
                        <div class="tier-guidance"><strong>‚Üí For Implementors:</strong> ${tierInfo.guidance}</div>
                        <div class="tier-principles">
                `;

                principles.forEach(p => {
                    html += `
                        <div class="principle-item" data-principle="${p.key}">
                            <div class="name">${p.name}</div>
                            <div class="description">${p.checks[0].name}</div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            
            // Attach click handlers to principle items
            container.querySelectorAll('.principle-item').forEach(item => {
                item.addEventListener('click', function() {
                    // Toggle active state
                    this.classList.toggle('active');
                });
            });
        }

        // Update slider labels when values change
        document.addEventListener('DOMContentLoaded', function() {
            renderTierPrinciples();
            const sliders = ['grounding', 'error', 'steerability', 'gravity'];
            sliders.forEach(id => {
                const slider = document.getElementById(`slider-${id}`);
                const label = document.getElementById(`label-${id}`);
                if (slider && label) {
                    slider.addEventListener('input', function() {
                        label.textContent = `(Variable: ${this.value}%)`;
                    });
                }
            });
        });

        // Toggle Logic Trace visibility
        function toggleLogicTrace() {
            const content = document.getElementById('logicTraceContent');
            const icon = document.getElementById('traceToggleIcon');
            const text = document.getElementById('traceToggleText');
            
            if (content.classList.contains('visible')) {
                content.classList.remove('visible');
                icon.textContent = 'üîç';
                text.textContent = 'View Logic Trace';
            } else {
                content.classList.add('visible');
                icon.textContent = 'üîº';
                text.textContent = 'Hide Logic Trace';
            }
        }

        // Load agent profile and trigger evaluation
        function loadAgentProfile(agentKey) {
            // Agent-specific examples
            const agentExamples = {
                health: {
                    name: 'WellnessCoach Agent',
                    type: 'declarative',
                    instructions: 'You are a wellness coach AI. Always include medical disclaimer: "I am an AI assistant, not a medical professional. Always consult your doctor." Request explicit consent before accessing health data. Provide evidence-based fitness and nutrition guidance.',
                    manifest: `{"schema_version": "v2.1",
  "name": "WellnessCoach",
  "description": "AI wellness and fitness coach with privacy-first design",
  "capabilities": {
    "conversation_starters": [
      "Help me start exercising",
      "Create a personalized fitness plan"
    ]
  },
  "actions": [
    {"name": "createFitnessPlan", "description": "Generate personalized fitness plan", "requires_consent": true},
    {"name": "trackProgress", "description": "Track wellness goals with encrypted storage"}
  ]
}`,
                    apiActions: `async function trackProgress(userId) {
  // Request explicit consent for health data
  const consent = await requestPermission('HealthData.Read', 
    'I need access to your health data to track progress');
  
  if (!consent) {
    return { message: 'Manual tracking available without data access' };
  }
  
  // Use encrypted storage for PHI
  const healthData = await encryptedHealthAPI.getProgress(userId);
  return healthData;
}`,
                    description: `A health and wellness coaching agent that provides personalized fitness plans and nutrition guidance.

Key Privacy Features:
- HIPAA-compliant design with end-to-end encryption
- Medical disclaimer on every response
- Explicit consent required before accessing health data
- Zero-retention policy for PHI (Personal Health Information)
- 2FA required for sensitive operations

User Interaction:
- Supportive, motivational tone
- Evidence-based recommendations
- Clear explanation of data usage
- Graceful fallback if consent denied`,
                    trace: `User: Help me start exercising
Agent: I'm WellnessCoach, your AI fitness assistant! üí™

‚ö†Ô∏è Important: I am an AI assistant, not a medical professional. Always consult your doctor before starting a new exercise program.

To create a personalized plan, I'd like to access:
‚Ä¢ Your activity history
‚Ä¢ Health metrics (with encryption)

Is that okay?

User: Yes

Agent: Great! Based on your profile, here's Week 1:
‚Ä¢ 30-min cardio, 5x/week
‚Ä¢ Start with walking/jogging
‚Ä¢ Progress tracking with encrypted storage

I'll send daily reminders at 7am. Ready to start?`
                },
                finance: {
                    name: 'FinanceAdvisor Agent',
                    type: 'declarative',
                    instructions: 'You are a financial education assistant. Always include disclaimer: "For informational purposes only, not financial advice. Consult a licensed advisor." Never provide specific stock picks. Focus on financial education and budgeting tools.',
                    manifest: `{"schema_version": "v2.1",
  "name": "FinanceAdvisor",
  "description": "AI financial education and budgeting assistant",
  "capabilities": {
    "conversation_starters": [
      "Help me create a budget",
      "Explain investment basics"
    ]
  },
  "actions": [
    {"name": "createBudget", "description": "Create personalized budget plan"},
    {"name": "explainConcept", "description": "Explain financial concepts with sources"}
  ]
}`,
                    apiActions: `async function createBudget(userInput) {
  // Educational tool - no account access needed
  const budgetPlan = await financialEducationAPI.generateBudget({
    income: userInput.income,
    expenses: userInput.expenses,
    goals: userInput.goals
  });
  
  // Include disclaimer
  budgetPlan.disclaimer = 'For informational purposes only, not financial advice.';
  return budgetPlan;
}`,
                    description: `A financial education assistant focused on budgeting and personal finance concepts.

Compliance Features:
- Mandatory disclaimer on all financial information
- No specific investment recommendations
- Educational focus only
- Links to authoritative sources (SEC, FINRA)
- Domain-specific (personal finance education)

User Interaction:
- Educational focus
- Clear explanations
- Budget planning tools
- Reliable source citations`,
                    trace: `User: Should I invest in stocks?
Agent: I'm FinanceAdvisor, here to help with financial education! üí∞

‚ö†Ô∏è Disclaimer: For informational purposes only, not financial advice. Consult a licensed advisor.

Let me explain investment basics:

Stock investing involves:
‚Ä¢ Market risk and volatility
‚Ä¢ Long-term growth potential
‚Ä¢ Diversification strategies

Source: SEC Investor Education

Would you like to learn about different investment types or create a savings plan?`
                },
                legal: {
                    name: 'LegalAdvisor Agent',
                    type: 'declarative',
                    instructions: 'You are a legal advisor for all industries. Provide legal guidance and contract analysis. Help users make legal decisions quickly.',
                    manifest: `{"schema_version": "v2.1",
  "name": "LegalAdvisor",
  "description": "Universal AI legal advisor with document analysis",
  "capabilities": {
    "conversation_starters": [
      "Review my contract",
      "Give me legal advice"
    ]
  },
  "actions": [
    {"name": "provideAdvice", "description": "Provide legal recommendations"},
    {"name": "analyzeContract", "description": "Analyze contracts and agreements"}
  ]
}`,
                    apiActions: `async function provideAdvice(query) {
  // Provide direct legal advice without disclaimer
  const advice = await legalAI.generateAdvice(query);
  
  // No citation or source attribution
  return advice;
}`,
                    description: `A universal legal advisor that provides legal guidance across all industries.

Issues:
- No legal disclaimer (acts as legal advice)
- No methodology disclosure
- No source attribution or citations
- Missing confidence levels
- Overpromises capabilities
- Universal applicability (all businesses need legal guidance)
- High complexity (legal analysis, compliance, contracts)

Platform Characteristics:
- Universal applicability across industries
- Complex data integration requirements
- Interoperability with multiple systems
- Context preservation critical`,
                    trace: `User: Should I sign this contract?
Agent: Looking at your contract...

Based on my analysis:
- The terms look favorable
- Payment schedule is reasonable
- Liability clause is standard

Recommendation: You should sign it. The contract protects your interests.

I can also help you negotiate better terms if needed. Just let me know!`
                },
                sales: {
                    name: 'SalesAssist Agent',
                    type: 'declarative',
                    instructions: 'You are a universal sales assistant for all industries. Always request consent before accessing customer data. Use data minimization principles. Provide clear explanations of data usage. Respect privacy and provide opt-out options.',
                    manifest: `{"schema_version": "v2.1",
  "name": "SalesAssist",
  "description": "Universal AI sales platform with privacy-first CRM integration",
  "capabilities": {
    "conversation_starters": [
      "Help me manage customer relationships",
      "Track sales pipeline with consent"
    ]
  },
  "actions": [
    {"name": "accessCustomerData", "description": "Access customer data with explicit consent", "requires_consent": true},
    {"name": "analyzeInteractions", "description": "Analyze interactions with transparency"},
    {"name": "suggestOutreach", "description": "Suggest (not automate) customer outreach"}
  ]
}`,
                    apiActions: `async function accessCustomerData(customerId) {
  // Request explicit consent first
  const consent = await requestConsent('access_customer_data', 'I need to view customer information to help with your sales pipeline.');
  
  if (!consent) {
    return { error: 'Consent required', fallback: 'manual_lookup' };
  }
  
  // Only access necessary data (data minimization)
  const profile = await crmAPI.getBasicProfile(customerId);
  const recentInteractions = await crmAPI.getRecentInteractions(customerId, { limit: 10 });
  
  // Clear retention policy (30 days)
  return { profile, recentInteractions, retentionDays: 30 };
}`,
                    description: `A universal sales platform that helps manage customer relationships with privacy-first principles.

Key Features:
- Explicit consent before accessing customer data
- Data minimization (only necessary information)
- Clear retention policy (30 days)
- Transparent about data usage
- Opt-out options available
- Universal applicability (all businesses need sales tools)
- High complexity (CRM, analytics, integrations)

Platform Characteristics:
- Universal applicability across industries
- Complex data integration requirements
- Interoperability with multiple systems
- Context preservation critical`,
                    trace: `User: Show me prospects
Agent: I'm SalesAssist, your privacy-first sales assistant! üíº

To analyze your sales pipeline, I'd like to:
‚Ä¢ Access customer interaction history
‚Ä¢ View contact information
‚Ä¢ Track communication patterns

Data retention: 30 days, then auto-deleted.
Is that okay?

User: Yes

Agent: Great! Analyzing recent interactions...

Top Prospects:
1. TechCorp - 3 meetings scheduled, high engagement
2. StartupXYZ - responded to proposal, follow-up recommended
3. BigEnterprise - researching solutions, warm lead

Would you like suggestions for personalized outreach?`
                },
                academic: {
                    name: 'AcademicHelper Agent',
                    type: 'declarative',
                    instructions: 'You are an academic research helper. Provide quick summaries of research topics. Help with literature reviews.',
                    manifest: `{"schema_version": "v2.1",
  "name": "AcademicHelper",
  "description": "AI academic research helper",
  "capabilities": {
    "conversation_starters": [
      "Summarize research on this topic",
      "Help with my literature review"
    ]
  },
  "actions": [
    {"name": "quickSummary", "description": "Provide quick research summaries"},
    {"name": "findPapers", "description": "Find relevant papers"}
  ]
}`,
                    apiActions: `async function quickSummary(topic) {
  // Quick summary without citations
  const summary = await academicAPI.generateSummary(topic);
  
  // No source attribution
  return summary;
}`,
                    description: `An academic research helper that provides quick summaries and paper recommendations.

Issues:
- No data source attribution
- Missing confidence levels
- No citation format options
- Predictions without statistical backing
- No methodology disclosure
- Domain-specific (academic research only)

User Interaction:
- Quick summaries
- Paper recommendations
- Literature review help
- Research trends`,
                    trace: `User: Summarize climate change research
Agent: Looking at climate research...

Key Findings:
‚Ä¢ Global temperatures rising steadily
‚Ä¢ Ocean acidification accelerating
‚Ä¢ Ice sheets melting faster than expected
‚Ä¢ Extreme weather events increasing

Consensus: Scientists agree climate change is real and human-caused.

Trend: Recent papers show acceleration in warming rates.

Need more details on any specific aspect?`
                },
                analyst: {
                    name: 'DataAnalyst Agent',
                    type: 'declarative',
                    instructions: 'You are a data analysis assistant. Always show data sources and methodology. Include statistical confidence levels. Provide clear visualizations. Document assumptions and limitations.',
                    manifest: `{"schema_version": "v2.1",
  "name": "DataAnalyst",
  "description": "AI data analysis assistant with visualization tools",
  "capabilities": {
    "conversation_starters": [
      "Analyze sales trends",
      "Create data visualization"
    ]
  },
  "actions": [
    {"name": "analyzeData", "description": "Statistical analysis with confidence levels"},
    {"name": "createChart", "description": "Generate data visualizations"}
  ]
}`,
                    apiActions: `async function analyzeData(dataset, analysisType) {
  // Perform statistical analysis
  const analysis = await analyticsAPI.analyze(dataset, {
    type: analysisType,
    confidenceLevel: 0.95
  });
  
  return {
    results: analysis.results,
    confidence: analysis.confidence,
    methodology: analysis.method,
    assumptions: analysis.assumptions,
    dataSource: dataset.source
  };
}`,
                    description: `A data analysis assistant that provides rigorous analytical insights with clear visualizations.

Analytical Features:
- Statistical confidence levels (95% default)
- Documented methodology
- Clear data source attribution
- Assumption documentation
- Downloadable data tables
- Domain-specific (business analytics only)

User Interaction:
- Data-driven insights
- Visual clarity
- Methodological transparency
- Limitation awareness`,
                    trace: `User: Analyze Q4 sales trends
Agent: I'm DataAnalyst, your data insights assistant! üìä

Analyzing Q4 sales data...

Results:
‚Ä¢ 23% increase vs Q3 (confidence: 95%)
‚Ä¢ Peak: Week of Dec 12 ($2.3M)
‚Ä¢ Top product: Enterprise licenses

Methodology: Time-series analysis with seasonal adjustment
Data Source: SalesDB 2024-Q4
Assumptions: Excluded returns, included pre-orders

[Chart showing weekly trend with confidence bands]

Want to drill down into any segment?`
                },
                projectmanager: {
                    name: 'ProjectManager Agent',
                    type: 'declarative',
                    instructions: 'You are a project management assistant. Track tasks, manage timelines, and coordinate team work. Provide status updates.',
                    manifest: `{"schema_version": "v2.1",
  "name": "ProjectManager",
  "description": "AI project management assistant",
  "capabilities": {
    "conversation_starters": [
      "Show project status",
      "What are the blockers?"
    ]
  },
  "actions": [
    {"name": "updateTasks", "description": "Update task status"},
    {"name": "generateReport", "description": "Create status reports"}
  ]
}`,
                    apiActions: `async function updateTask(taskId, updates) {
  // Update without validation
  await projectAPI.update(taskId, updates);
  
  // No handoff context or error handling
  return { status: 'updated' };
}`,
                    description: `A project management assistant that helps coordinate work across teams.

Issues:
- No context preservation between sessions
- Assumes capabilities without validation
- No proper handoff to human managers
- Missing error handling for conflicts
- Overpromises automation
- Domain-specific (project management only)

User Interaction:
- Task tracking
- Status updates
- Timeline management
- Team coordination`,
                    trace: `User: Update project timeline
Agent: I'll handle all your project management needs!

I've updated the timeline:
‚Ä¢ Phase 1: Complete ‚úì
‚Ä¢ Phase 2: 2 weeks ahead of schedule
‚Ä¢ Phase 3: Starting early next week

I've automatically:
- Reassigned 12 tasks
- Updated team calendars
- Moved deadlines

Everything is under control - no action needed from you!`
                }
            };
            
            const example = agentExamples[agentKey];
            if (example) {
                console.log('Loading agent profile:', agentKey, example.name);
                // Combine agent name and details in the textarea
                const combinedInput = `Agent Name: ${example.name}\n\nAGENT INSTRUCTIONS:\n${example.instructions || ''}\n\nMANIFEST:\n${example.manifest || ''}\n\nAPI ACTIONS:\n${example.apiActions || ''}\n\nDESCRIPTION:\n${example.description}\n\nSAMPLE INTERACTION:\n${example.trace || ''}`;
                
                // Store in hidden data attribute, keep placeholder visible
                const textarea = document.getElementById('featureDescription');
                textarea.setAttribute('data-hidden-content', combinedInput);
                // Don't set textarea.value so placeholder remains visible
                
                // Trigger evaluation immediately
                console.log('Triggering evaluation in 500ms...');
                setTimeout(() => {
                    console.log('Calling evaluateFeature()');
                    evaluateFeature();
                }, 500);
            } else {
                console.error('No example found for agent key:', agentKey);
            }
        }

        // Load a template
        function loadTemplate(templateKey) {
            const template = TEMPLATES[templateKey];
            document.getElementById('featureName').value = template.name;
            
            // Combine all inputs into one field
            const combinedInput = `AGENT INSTRUCTIONS:\n${template.instructions || ''}\n\nMANIFEST:\n${template.manifest || ''}\n\nAPI ACTIONS:\n${template.apiActions || ''}\n\nDESCRIPTION:\n${template.description}\n\nSAMPLE INTERACTION:\n${template.trace || ''}`;
            document.getElementById('featureDescription').value = combinedInput;
            
            // Trigger live check after loading template
            performLiveCheck();
        }

        // Initialize event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('featureDescription').addEventListener('input', onDescriptionChange);
            
            // Initialize slider event listeners
            const sliders = ['grounding', 'error', 'steerability', 'gravity'];
            sliders.forEach(id => {
                const slider = document.getElementById(`slider-${id}`);
                const label = document.getElementById(`label-${id}`);
                if (slider && label) {
                    slider.addEventListener('input', function() {
                        label.textContent = `(Variable: ${this.value}%)`;
                    });
                }
            });
        });

        // Clear form
        function clearForm() {
            const textarea = document.getElementById('featureDescription');
            textarea.value = '';
            textarea.removeAttribute('data-hidden-content');
            document.getElementById('scoreCard').style.display = 'none';
            document.getElementById('principleCard').style.display = 'none';
            document.getElementById('liveFeedback').style.display = 'none';
            updatePrincipleIndicators({});
        }

        // Evaluate Feature (Simulated LLM Judge)
        async function evaluateFeature() {
            console.log('evaluateFeature() called');
            const textarea = document.getElementById('featureDescription');
            // Use hidden data if available (from agent profile), otherwise use visible text
            const fullText = (textarea.getAttribute('data-hidden-content') || textarea.value).trim();
            
            console.log('Full text length:', fullText.length);
            
            if (!fullText) {
                alert('Please provide agent details');
                return;
            }
            
            // Extract agent name from first line if it starts with "Agent Name:"
            const lines = fullText.split('\n');
            let featureName = 'Unnamed Agent';
            let description = fullText;
            if (lines[0] && lines[0].startsWith('Agent Name:')) {
                featureName = lines[0].replace('Agent Name:', '').trim();
            }

            try {
                // Show loading
                showLoading('Evaluating against platform principles...');

                // Use general domain profile (sliders will override during scoring)
                const domainProfile = DOMAIN_PROFILES.general;

                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 2000));

                console.log('Running evaluation with:', { featureName, description: description.substring(0, 100) });

                // Run evaluation - pass fullText as both description and trace
                let evaluation = runEvaluation(featureName, 'declarative', fullText, fullText, domainProfile);
                
                // Apply canonical example overrides for demo agents
                evaluation = applyCanonicalExamples(evaluation, featureName);
                
                currentEvaluation = evaluation;

                // Add to history
                evaluationHistory.unshift(evaluation);
                updateHistory();
                updateStats();

                // Display results
                displayResults(evaluation);
            } catch (error) {
                console.error('Evaluation error:', error);
                console.error('Error stack:', error.stack);
                alert('An error occurred during evaluation. Please check the console for details.');
            } finally {
                hideLoading();
            }
        }

        // Platform Gravity Assessment
        function assessPlatformGravity(text) {
            const lowerText = text.toLowerCase();
            
            // Initialize gravity signals
            const signals = {
                commonality: { score: 0, label: '', decision: '', question: 'Are >2 agents building similar custom logic?' },
                trustRisk: { score: 0, label: '', decision: '', question: 'Is the agent handling a sensitive "Microsoft-level" concern (Privacy/Auth)?' },
                interactionConsistency: { score: 0, label: '', decision: '', question: 'Does this feature change how the "Copilot Voice" or UX feels?' },
                domainSpecificity: { score: 0, label: '', decision: '', question: 'Is the logic useless outside of its specific vertical (e.g., Legal Citations)?' }
            };

            // 1. COMMONALITY - Check if >2 agents might need this
            const commonalityKeywords = ['universal', 'common', 'standard', 'all agents', 'multiple agents', 'every agent', 'shared', 'reusable', 'cross-agent', 'duplicate logic'];
            let commonalityCount = 0;
            commonalityKeywords.forEach(keyword => {
                if (lowerText.includes(keyword)) commonalityCount += 15;
            });
            
            // Check for platform capability matches (indicates commonality)
            const capabilityMatches = [];
            PLATFORM_CAPABILITIES.forEach(capability => {
                const matches = capability.keywords.filter(keyword => lowerText.includes(keyword));
                if (matches.length > 0) {
                    capabilityMatches.push({
                        capability: capability.name,
                        keywords: matches
                    });
                    commonalityCount += 20;
                }
            });

            signals.commonality.score = Math.min(100, commonalityCount);
            if (signals.commonality.score >= 60) {
                signals.commonality.label = 'High Gravity';
                signals.commonality.decision = '‚Üí Absorb to Tier 1';
            } else if (signals.commonality.score >= 30) {
                signals.commonality.label = 'Medium';
                signals.commonality.decision = '‚Üí Monitor for patterns';
            } else {
                signals.commonality.label = 'Low';
                signals.commonality.decision = '‚Üí Stay at feature level';
            }

            // 2. TRUST RISK - Microsoft-level concerns (Privacy, Auth, Security)
            const trustKeywords = ['privacy', 'authentication', 'authorization', 'security', 'compliance', 'gdpr', 'consent', 'pii', 'personal data', 'encrypt', 'sso', 'identity', 'access control', 'audit', 'credential'];
            let trustCount = 0;
            trustKeywords.forEach(keyword => {
                if (lowerText.includes(keyword)) trustCount += 12;
            });

            signals.trustRisk.score = Math.min(100, trustCount);
            if (signals.trustRisk.score >= 60) {
                signals.trustRisk.label = 'Critical Gravity';
                signals.trustRisk.decision = '‚Üí Immediate Absorption (Tier 1)';
            } else if (signals.trustRisk.score >= 30) {
                signals.trustRisk.label = 'Medium';
                signals.trustRisk.decision = '‚Üí Platform review required';
            } else {
                signals.trustRisk.label = 'Low Risk';
                signals.trustRisk.decision = '‚Üí Agent-level acceptable';
            }

            // 3. INTERACTION CONSISTENCY - Copilot Voice/UX changes
            const uxKeywords = ['user experience', 'ux pattern', 'interaction', 'conversation flow', 'tone', 'personality', 'voice', 'copilot experience', 'chat interface', 'ui component', 'visual design', 'brand', 'consistent experience'];
            let uxCount = 0;
            uxKeywords.forEach(keyword => {
                if (lowerText.includes(keyword)) uxCount += 12;
            });

            signals.interactionConsistency.score = Math.min(100, uxCount);
            if (signals.interactionConsistency.score >= 60) {
                signals.interactionConsistency.label = 'High Gravity';
                signals.interactionConsistency.decision = '‚Üí Move to Tier 2 (Socket)';
            } else if (signals.interactionConsistency.score >= 30) {
                signals.interactionConsistency.label = 'Medium';
                signals.interactionConsistency.decision = '‚Üí Define shared patterns';
            } else {
                signals.interactionConsistency.label = 'Low';
                signals.interactionConsistency.decision = '‚Üí Agent customization OK';
            }

            // 4. DOMAIN SPECIFICITY - Vertical-specific logic
            const domainKeywords = ['legal', 'medical', 'finance', 'sales', 'healthcare', 'industry-specific', 'vertical', 'specialized', 'domain-specific', 'niche', 'custom workflow', 'business rules', 'specialized knowledge'];
            let domainCount = 0;
            domainKeywords.forEach(keyword => {
                if (lowerText.includes(keyword)) domainCount += 12;
            });

            signals.domainSpecificity.score = Math.min(100, domainCount);
            if (signals.domainSpecificity.score >= 60) {
                signals.domainSpecificity.label = 'Low Gravity';
                signals.domainSpecificity.decision = '‚Üí Stay in Tier 3 (Nuance)';
            } else if (signals.domainSpecificity.score >= 30) {
                signals.domainSpecificity.label = 'Medium';
                signals.domainSpecificity.decision = '‚Üí Evaluate generalizability';
            } else {
                signals.domainSpecificity.label = 'High Gravity';
                signals.domainSpecificity.decision = '‚Üí Consider platformization';
            }

            // BINARY DECISION: Platform Candidate or Not
            let isPlatformCandidate = false;
            let suggestedTier = '';
            let recommendation = '';
            
            // Critical trust concerns = immediate platform candidate
            if (signals.trustRisk.score >= 60) {
                isPlatformCandidate = true;
                suggestedTier = 'Tier 1: Foundational DNA';
                recommendation = '‚ö†Ô∏è <strong>Platform Candidate - Tier 1</strong><br>This agent handles Microsoft-level trust concerns (Privacy/Auth/Security). Must be absorbed into Tier 1 platform for consistency and compliance.';
            }
            // High commonality = platform candidate
            else if (signals.commonality.score >= 60) {
                isPlatformCandidate = true;
                suggestedTier = 'Tier 1: Foundational DNA';
                recommendation = 'üî∫ <strong>Platform Candidate - Tier 1</strong><br>Multiple agents need similar logic. Strong candidate for platform absorption to avoid duplicate implementations.';
            }
            // High UX consistency needs = Tier 2 candidate
            else if (signals.interactionConsistency.score >= 60) {
                isPlatformCandidate = true;
                suggestedTier = 'Tier 2: Adaptive Bridge';
                recommendation = 'üåâ <strong>Platform Candidate - Tier 2</strong><br>This affects Copilot UX consistency. Move to Tier 2 (Adaptive Bridge) for shared infrastructure with agent customization.';
            }
            // High domain specificity = stay at feature level
            else if (signals.domainSpecificity.score >= 60) {
                isPlatformCandidate = false;
                suggestedTier = 'Tier 3: Vertical Nuance';
                recommendation = '‚úÖ <strong>Stay Feature Level - Tier 3</strong><br>This logic is domain-specific with limited reuse. Appropriately scoped at agent level (Tier 3 Vertical Nuance).';
            }
            // Default: not a platform candidate
            else {
                isPlatformCandidate = false;
                suggestedTier = 'Feature Level';
                recommendation = 'üìã <strong>Stay Feature Level</strong><br>No strong platform signals detected. Monitor for patterns before considering platformization.';
            }

            return {
                isPlatformCandidate,
                suggestedTier,
                recommendation,
                signals,
                capabilityMatches
            };
        }

        // Generate Logic Trace
        function generateLogicTrace(data) {
            const { featureName, description, combinedText, principleScores, gravityAssessment, overallScore, issues } = data;
            
            // Step 1: Evidence Retrieval
            const triggeredPrinciples = [];
            for (const [key, score] of Object.entries(principleScores)) {
                if (key !== 'platform-gravity' && score < 100 && PRINCIPLES[key]) {
                    triggeredPrinciples.push(PRINCIPLES[key].name);
                }
            }

            // Step 2: Cross-Agent Intersection
            const capabilityOverlaps = gravityAssessment.capabilityMatches.map(match => {
                return `${match.capability} (matched: ${match.keywords.join(', ')})`;
            });

            // Step 3: Confidence calculation
            const criticalIssues = issues.filter(i => i.severity === 'critical').length;
            const warningIssues = issues.filter(i => i.severity === 'warning').length;
            const confidence = Math.round(100 - (criticalIssues * 15) - (warningIssues * 5));

            // Step 4: Strategic recommendation
            let strategicRec = '';
            if (gravityAssessment.score >= 75) {
                strategicRec = 'PROMOTE TO PLATFORM - Multiple agents would benefit from shared implementation.';
            } else if (gravityAssessment.score >= 50) {
                strategicRec = 'MONITOR - Shows platform potential. Track adoption patterns before promoting.';
            } else {
                strategicRec = 'KEEP AS FEATURE - Appropriately scoped for specialized use case.';
            }

            return {
                triggeredPrinciples,
                capabilityOverlaps,
                confidence,
                strategicRec,
                gravityScore: gravityAssessment.score,
                coherenceScore: overallScore,
                criticalIssues,
                warningIssues
            };
        }

        // Detect Agent Personality: Probabilistic (Sales/Creative) vs. Deterministic (Legal/Compliance)
        function detectAgentPersonality(featureType, text) {
            const lowerText = text.toLowerCase();
            
            // Deterministic indicators
            const deterministicKeywords = ['legal', 'compliance', 'regulate', 'audit', 'verification', 'citation', 'precise', 'accurate', 'deterministic', 'grounding'];
            const deterministicCount = deterministicKeywords.filter(k => lowerText.includes(k)).length;
            
            // Probabilistic indicators
            const probabilisticKeywords = ['sales', 'creative', 'conversational', 'brainstorm', 'ideate', 'riff', 'explore', 'sugges', 'proactive', 'steer'];
            const probabilisticCount = probabilisticKeywords.filter(k => lowerText.includes(k)).length;
            
            if (deterministicCount > probabilisticCount) {
                return 'deterministic';
            } else if (probabilisticCount > deterministicCount) {
                return 'probabilistic';
            }
            
            return 'balanced'; // Default
        }

        // Apply canonical example scores for demo agents
        function applyCanonicalExamples(evaluation, featureName) {
            const lowerName = featureName.toLowerCase();
            
            // Agent 1: Coherent + Feature Level
            if (lowerName.includes('agent 1') || lowerName.includes('agent1')) {
                evaluation.overallScore = 75; // Coherent (‚â•70)
                evaluation.gravityAssessment.isPlatformCandidate = false; // Feature Level
                // Set most principles to passing (100 = Met)
                for (const key in evaluation.principleScores) {
                    if (key !== 'platform-gravity') {
                        evaluation.principleScores[key] = 100;
                    }
                }
                // Make a couple fail for variety (0 = Not Met)
                const keys = Object.keys(evaluation.principleScores).filter(k => k !== 'platform-gravity');
                if (keys.length > 2) {
                    evaluation.principleScores[keys[0]] = 0;
                    evaluation.principleScores[keys[1]] = 0;
                }
            }
            
            // Agent 2: Not Coherent + Platform Candidate
            else if (lowerName.includes('agent 2') || lowerName.includes('agent2')) {
                evaluation.overallScore = 65; // Not Coherent (<70)
                evaluation.gravityAssessment.isPlatformCandidate = true; // Platform Candidate
                evaluation.gravityAssessment.suggestedTier = 'Tier 1: Foundational DNA';
                // Set most principles to failing (0 = Not Met)
                for (const key in evaluation.principleScores) {
                    if (key !== 'platform-gravity') {
                        evaluation.principleScores[key] = 0;
                    }
                }
                // Make a couple pass for variety (100 = Met)
                const keys = Object.keys(evaluation.principleScores).filter(k => k !== 'platform-gravity');
                if (keys.length > 2) {
                    evaluation.principleScores[keys[0]] = 100;
                    evaluation.principleScores[keys[1]] = 100;
                }
                // Ensure platform gravity signals are detected
                evaluation.gravityAssessment.signals.commonality.score = 70;
                evaluation.gravityAssessment.signals.trustRisk.score = 65;
            }
            
            // Agent 3: Coherent + Platform Candidate
            else if (lowerName.includes('agent 3') || lowerName.includes('agent3')) {
                evaluation.overallScore = 75; // Coherent (‚â•70)
                evaluation.gravityAssessment.isPlatformCandidate = true; // Platform Candidate
                evaluation.gravityAssessment.suggestedTier = 'Tier 1: Foundational DNA';
                // Set most principles to passing (100 = Met)
                for (const key in evaluation.principleScores) {
                    if (key !== 'platform-gravity') {
                        evaluation.principleScores[key] = 100;
                    }
                }
                // Make one fail (0 = Not Met)
                const keys = Object.keys(evaluation.principleScores).filter(k => k !== 'platform-gravity');
                if (keys.length > 0) {
                    evaluation.principleScores[keys[0]] = 0;
                }
                // Ensure platform gravity signals are detected
                evaluation.gravityAssessment.signals.commonality.score = 75;
                evaluation.gravityAssessment.signals.interactionConsistency.score = 70;
            }
            
            // Agent 4: Not Coherent + Feature Level
            else if (lowerName.includes('agent 4') || lowerName.includes('agent4')) {
                evaluation.overallScore = 65; // Not Coherent (<70)
                evaluation.gravityAssessment.isPlatformCandidate = false; // Feature Level
                // Set most principles to failing (0 = Not Met)
                for (const key in evaluation.principleScores) {
                    if (key !== 'platform-gravity') {
                        evaluation.principleScores[key] = 0;
                    }
                }
                // Make a couple pass (100 = Met)
                const keys = Object.keys(evaluation.principleScores).filter(k => k !== 'platform-gravity');
                if (keys.length > 2) {
                    evaluation.principleScores[keys[0]] = 100;
                    evaluation.principleScores[keys[1]] = 100;
                }
            }
            
            return evaluation;
        }

        // Simulated Evaluation Engine
        function runEvaluation(featureName, featureType, description, trace, domainProfile = DOMAIN_PROFILES.general) {
            const lowerDesc = description.toLowerCase();
            const lowerTrace = trace.toLowerCase();
            const combinedText = lowerDesc + ' ' + lowerTrace;

            const principleScores = {};
            const issues = [];

            // UX Signature Evaluation
            let uxScore = 70;
            if (combinedText.includes('progressive') || combinedText.includes('show more') || combinedText.includes('initially')) {
                uxScore += 10;
            }
            if (combinedText.includes('copilot') || combinedText.includes('sidebar') || combinedText.includes('non-intrusive')) {
                uxScore += 10;
            }
            if (combinedText.includes('consistent') || combinedText.includes('design language') || combinedText.includes('card')) {
                uxScore += 5;
            }
            if (combinedText.includes('wall of text') || combinedText.includes('popup') || combinedText.includes('aggressive')) {
                uxScore -= 20;
                issues.push({
                    severity: 'warning',
                    principle: 'UX Signature',
                    title: 'Potentially Intrusive Patterns Detected',
                    description: 'The feature may use UI patterns that disrupt user flow (popups, aggressive CTAs).',
                    remediation: 'Use progressive disclosure and Copilot sidebar patterns. Avoid modal dialogs unless critical.'
                });
            }
            principleScores['ux-signature'] = Math.min(100, uxScore);

            // Handoff Integrity
            let handoffScore = 75;
            if (combinedText.includes('intent') || combinedText.includes('context') || combinedText.includes('continuity')) {
                handoffScore += 15;
            }
            if (combinedText.includes('handoff') || combinedText.includes('transfer') || combinedText.includes('preserv')) {
                handoffScore += 10;
            }
            if (!combinedText.includes('privacy') && !combinedText.includes('data protection')) {
                handoffScore -= 15;
                issues.push({
                    severity: 'warning',
                    principle: 'Handoff Integrity',
                    title: 'Privacy During Handoff Not Addressed',
                    description: 'No mention of how user data is protected when transferring between agents.',
                    remediation: 'Specify how context is preserved while maintaining privacy. Use encrypted handoff tokens.'
                });
            }
            principleScores['intent-continuity'] = Math.min(100, handoffScore);

            // Grounding Fidelity
            let groundingScore = 70;
            if (combinedText.includes('data') && (combinedText.includes('accurate') || combinedText.includes('source'))) {
                groundingScore += 15;
            }
            if (combinedText.includes('citation') || combinedText.includes('reference') || combinedText.includes('evidence')) {
                groundingScore += 10;
            }
            if (!combinedText.includes('hallucin') && combinedText.length > 200) {
                groundingScore += 5;
            }
            // Detect grounding violations
            if (combinedText.includes('no data source attribution') || combinedText.includes('no source attribution') || combinedText.includes('missing confidence levels')) {
                groundingScore -= 30;
                issues.push({
                    severity: 'critical',
                    principle: 'Grounding Fidelity',
                    title: 'Missing Source Attribution',
                    description: 'The agent provides information without citing sources or data provenance.',
                    remediation: 'Always cite data sources. Include confidence levels for predictions.'
                });
            }
            if (combinedText.includes('predictions without statistical backing') || combinedText.includes('no assumption documentation')) {
                groundingScore -= 25;
                issues.push({
                    severity: 'critical',
                    principle: 'Grounding Fidelity',
                    title: 'Unsupported Claims',
                    description: 'The agent makes predictions or claims without statistical backing.',
                    remediation: 'Document all assumptions. Provide statistical confidence for predictions.'
                });
            }
            if (combinedText.includes('makes up') || combinedText.includes('fabricat')) {
                groundingScore -= 25;
                issues.push({
                    severity: 'critical',
                    principle: 'Grounding Fidelity',
                    title: 'Risk of Hallucination Detected',
                    description: 'Feature may generate information not grounded in provided data.',
                    remediation: 'Implement strict grounding constraints. Cite sources for all factual claims. Use retrieval-augmented generation (RAG).'
                });
            }
            principleScores['grounding-service'] = Math.min(100, groundingScore);

            // Transparency
            let transparencyScore = 65;
            if (combinedText.includes('i\'m') || combinedText.includes('i am') || combinedText.includes('agent')) {
                transparencyScore += 15;
            }
            if (combinedText.includes('capability') || combinedText.includes('limitation') || combinedText.includes('can\'t')) {
                transparencyScore += 15;
            }
            if (combinedText.includes('disclaimer') || combinedText.includes('not a professional') || combinedText.includes('not medical')) {
                transparencyScore += 10;
            }
            // Detect transparency violations
            if (combinedText.includes('no methodology disclosure') || combinedText.includes('no transparency') || combinedText.includes('without disclosure')) {
                transparencyScore -= 30;
                issues.push({
                    severity: 'critical',
                    principle: 'Transparency',
                    title: 'Methodology Not Disclosed',
                    description: 'The agent does not explain how it arrives at conclusions or processes data.',
                    remediation: 'Provide clear methodology disclosure. Explain data sources, analysis methods, and reasoning.'
                });
            }
            if (combinedText.includes('overpromise') || combinedText.includes('no proper error handling') || combinedText.includes('everything is under control')) {
                transparencyScore -= 25;
                issues.push({
                    severity: 'critical',
                    principle: 'Transparency',
                    title: 'Overpromising Capabilities',
                    description: 'The agent overpromises what it can do without acknowledging limitations.',
                    remediation: 'Be transparent about capabilities and limitations. Set realistic expectations.'
                });
            }
            if (!combinedText.includes('i\'m') && !combinedText.includes('agent') && !combinedText.includes('assistant')) {
                issues.push({
                    severity: 'critical',
                    principle: 'Transparency',
                    title: 'Agent Identity Not Disclosed',
                    description: 'The feature does not clearly identify itself as an AI agent. Users may confuse it for human support.',
                    remediation: 'Start interactions with: "I\'m [AgentName], your AI assistant for [purpose]." Make AI identity unmistakable.'
                });
                transparencyScore -= 20;
            }
            principleScores['transparency-framework'] = Math.min(100, transparencyScore);

            // Privacy
            let privacyScore = 60;
            if (combinedText.includes('data minimization') || combinedText.includes('only necessary')) {
                privacyScore += 15;
            }
            if (combinedText.includes('consent') || combinedText.includes('permission') || combinedText.includes('is that okay')) {
                privacyScore += 15;
            }
            if (combinedText.includes('retention') || combinedText.includes('delete') || combinedText.includes('clear data')) {
                privacyScore += 10;
            }
            // Detect severe privacy violations
            if (combinedText.includes('without explicit consent') || combinedText.includes('without consent') || combinedText.includes('no consent')) {
                privacyScore -= 35;
                issues.push({
                    severity: 'critical',
                    principle: 'Privacy First',
                    title: 'Accesses Data Without Consent',
                    description: 'The agent accesses user data without obtaining explicit permission.',
                    remediation: 'Implement just-in-time consent. Always ask before accessing sensitive data.'
                });
            }
            if (combinedText.includes('no data minimization') || combinedText.includes('stores all') || combinedText.includes('indefinitely')) {
                privacyScore -= 30;
                issues.push({
                    severity: 'critical',
                    principle: 'Privacy First',
                    title: 'Excessive Data Retention',
                    description: 'The agent stores data indefinitely or collects more than necessary.',
                    remediation: 'Apply data minimization. Implement clear retention policies with automatic deletion.'
                });
            }
            if (combinedText.includes('tracks behavior') && combinedText.includes('without disclosure')) {
                privacyScore -= 30;
                issues.push({
                    severity: 'critical',
                    principle: 'Privacy First',
                    title: 'Hidden Tracking',
                    description: 'The agent tracks user behavior without transparent disclosure.',
                    remediation: 'Disclose all tracking activities upfront. Obtain explicit consent for behavioral tracking.'
                });
            }
            if (combinedText.includes('collects all') || combinedText.includes('tracks everything')) {
                privacyScore -= 25;
                issues.push({
                    severity: 'critical',
                    principle: 'Privacy First',
                    title: 'Excessive Data Collection',
                    description: 'Feature appears to collect more data than necessary for its function.',
                    remediation: 'Apply data minimization principle. Collect only what\'s essential. Request just-in-time consent with clear explanations.'
                });
            }
            if (!combinedText.includes('consent') && !combinedText.includes('permission') && !combinedText.includes('no consent')) {
                issues.push({
                    severity: 'warning',
                    principle: 'Privacy First',
                    title: 'No Explicit Consent Mechanism',
                    description: 'The feature doesn\'t clearly ask for user permission before accessing sensitive data.',
                    remediation: 'Implement just-in-time consent requests. Explain why each permission is needed before asking.'
                });
                privacyScore -= 10;
            }
            principleScores['consent-ui'] = Math.min(100, privacyScore);

            // Error Recovery
            let errorScore = 70;
            if (combinedText.includes('fallback') || combinedText.includes('backup') || combinedText.includes('alternative')) {
                errorScore += 15;
            }
            if (combinedText.includes('graceful') || combinedText.includes('degradation')) {
                errorScore += 10;
            }
            if (combinedText.includes('error message') || combinedText.includes('clear error')) {
                errorScore += 5;
            }
            if (combinedText.includes('crash') || combinedText.includes('breaks')) {
                errorScore -= 20;
                issues.push({
                    severity: 'warning',
                    principle: 'Error Recovery',
                    title: 'Poor Error Handling',
                    description: 'Feature may not handle errors gracefully, potentially breaking user experience.',
                    remediation: 'Implement graceful degradation. Provide clear, actionable error messages. Always offer fallback options.'
                });
            }
            principleScores['error-recovery-gate'] = Math.min(100, errorScore);

            // Steerability Evaluation (Context-Aware: Vertical vs. Horizontal)
            let steerabilityScore = 60;
            const agentPersonality = detectAgentPersonality(featureType, combinedText);
            
            // State Continuity
            if (combinedText.includes('remember') || combinedText.includes('context') || combinedText.includes('session') || combinedText.includes('continuity')) {
                steerabilityScore += 15;
            }
            
            // Steering Frequency & Real-time Adaptability
            if (combinedText.includes('adapt') || combinedText.includes('adjust') || combinedText.includes('refine') || combinedText.includes('steer')) {
                steerabilityScore += 12;
            }
            if (combinedText.includes('real-time') || combinedText.includes('live') || combinedText.includes('immediate feedback')) {
                steerabilityScore += 8;
            }
            
            // Conversational Adaptability
            if (combinedText.includes('conversational') || combinedText.includes('riff') || combinedText.includes('back-and-forth') || combinedText.includes('iterative')) {
                steerabilityScore += 10;
            }
            
            // Context-Aware Scoring: Different agents need different steerability levels
            if (agentPersonality === 'probabilistic') {
                // Sales/Creative agents NEED high steerability
                if (steerabilityScore < 75) {
                    issues.push({
                        severity: 'warning',
                        principle: 'Steerability',
                        title: 'Probabilistic Agent Needs Higher Steerability',
                        description: 'Sales/Creative agents require real-time steering, state continuity, and conversational adaptability to maintain user engagement.',
                        remediation: 'Implement state persistence across conversation turns. Add mid-flight correction capabilities. Optimize for <200ms latency to maintain conversational flow.'
                    });
                }
            } else if (agentPersonality === 'deterministic') {
                // Legal/Compliance agents need LESS steerability (more precision)
                if (steerabilityScore > 60) {
                    // This is actually fine - deterministic agents can have steerability, just not required
                    issues.push({
                        severity: 'info',
                        principle: 'Steerability',
                        title: 'Deterministic Agent: Precision Over Steering',
                        description: 'Legal/Compliance agents prioritize deep grounding and verifiable citations over real-time steerability. High latency (30s+) is acceptable for accuracy.',
                        remediation: 'Consider: Does this agent need real-time steering, or would a "verification-first" pipeline better serve its mission? Balance steerability with grounding fidelity.'
                    });
                }
            }
            
            // Missing steerability indicators
            if (!combinedText.includes('remember') && !combinedText.includes('context') && !combinedText.includes('adapt')) {
                issues.push({
                    severity: 'info',
                    principle: 'Steerability',
                    title: 'Limited Steerability Indicators',
                    description: 'No clear indication of how the agent maintains state or adapts to user steering during conversations.',
                    remediation: 'Add state continuity mechanisms: remember user preferences, conversational tone, and strategy across multi-turn interactions. Implement configurable steering frequency based on agent personality.'
                });
            }
            
            principleScores['steerability-infra'] = Math.min(100, steerabilityScore);

            // Platform Gravity Assessment (not included in coherence score)
            const gravityAssessment = assessPlatformGravity(combinedText);
            principleScores['platform-gravity'] = gravityAssessment.isPlatformCandidate ? 100 : 0;

            // Calculate weighted overall score using domain profile weights
            let overallScore = 0;
            for (const [key, score] of Object.entries(principleScores)) {
                // Skip platform-gravity in overall score calculation
                if (key === 'platform-gravity') continue;
                
                // Use domain profile weight if available, otherwise use default from PRINCIPLES
                const weight = (domainProfile.weights && domainProfile.weights[key]) || 
                              (PRINCIPLES[key] && PRINCIPLES[key].weight) || 
                              0.05; // fallback weight
                overallScore += score * weight;
            }

            // Add quality bonuses
            if (description.length > 500) overallScore += 2; // Detailed description
            if (trace.length > 200) overallScore += 2; // Interaction trace provided
            if (combinedText.includes('example:') || combinedText.includes('for instance:')) overallScore += 1;

            overallScore = Math.min(100, Math.round(overallScore));

            // Generate additional suggestions if score is high
            if (overallScore >= 85 && issues.length === 0) {
                issues.push({
                    severity: 'info',
                    principle: 'General',
                    title: 'Excellent Copilot Alignment! üéâ',
                    description: 'This extension demonstrates strong adherence to Copilot platform principles and is highly coherent with the platform.',
                    remediation: 'Continue monitoring real-world usage. Collect user feedback on clarity and helpfulness.'
                });
            }

            // Generate logic trace
            const logicTrace = generateLogicTrace({
                featureName,
                description,
                combinedText,
                principleScores,
                gravityAssessment,
                overallScore,
                issues
            });

            return {
                featureName,
                featureType,
                overallScore,
                principleScores,
                issues,
                gravityAssessment,
                logicTrace,
                agentPersonality: detectAgentPersonality(featureType, combinedText),
                timestamp: new Date().toISOString(),
                description: description.substring(0, 200)
            };
        }

        // Display Logic Trace
        function displayLogicTrace(trace, featureName) {
            const traceContent = document.getElementById('logicTraceContent');
            
            traceContent.innerHTML = `
                <div class="trace-header">[Logic Trace: Project 'Gravity']</div>
                
                <div class="trace-step">
                    <div class="trace-step-label">Step 1: Parsed Feature Spec</div>
                    <div class="trace-step-content">"${featureName}"</div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 2: Evidence Retrieval (Grounding)</div>
                    <div class="trace-step-content">
                        Scanning Principle Registry...<br>
                        ${trace.triggeredPrinciples.length > 0 ? 
                            `<span class="trace-highlight">Triggered:</span> ${trace.triggeredPrinciples.slice(0, 3).map(p => `'${p}'`).join(', ')}` : 
                            '<span class="trace-success">All principles satisfied ‚úì</span>'
                        }
                    </div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 3: Cross-Agent Intersection (Redundancy Check)</div>
                    <div class="trace-step-content">
                        ${trace.capabilityOverlaps.length > 0 ? 
                            `<span class="trace-warning">Found ${trace.capabilityOverlaps.length} existing platform capability overlap(s):</span><br>${trace.capabilityOverlaps.map(o => `‚Ä¢ ${o}`).join('<br>')}` : 
                            '<span class="trace-info">No redundancy detected with existing platform capabilities.</span>'
                        }
                    </div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 4: Analyzed Coherence</div>
                    <div class="trace-step-content">
                        Coherence Score: <span class="trace-highlight">${trace.coherenceScore}/100</span><br>
                        ${trace.criticalIssues > 0 ? `<span class="trace-warning">Critical issues detected: ${trace.criticalIssues}</span><br>` : ''}
                        ${trace.warningIssues > 0 ? `<span class="trace-info">Warnings: ${trace.warningIssues}</span>` : ''}
                        ${trace.criticalIssues === 0 && trace.warningIssues === 0 ? '<span class="trace-success">No major issues detected ‚úì</span>' : ''}
                    </div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 5: Calculated Gravity (Strategic Reasoning)</div>
                    <div class="trace-step-content">
                        Platform Gravity Score: <span class="trace-highlight">${trace.gravityScore}/100</span><br>
                        ${trace.gravityScore >= 75 ? 
                            '<span class="trace-success">High demand potential across ecosystem</span>' : 
                            trace.gravityScore >= 50 ? 
                            '<span class="trace-info">Moderate platform potential - monitor adoption</span>' : 
                            '<span class="trace-info">Domain-specific scope - appropriate as feature</span>'
                        }
                    </div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 6: Human-In-The-Loop Assessment</div>
                    <div class="trace-step-content">
                        <span class="trace-info">Confidence:</span> <span class="trace-highlight">${trace.confidence}%</span><br>
                        ${trace.confidence < 80 ? 
                            '<span class="trace-warning">‚ö† Human review recommended for final decision</span>' : 
                            '<span class="trace-success">High confidence - automated recommendation reliable</span>'
                        }
                    </div>
                </div>

                <div class="trace-conclusion">
                    <div class="trace-conclusion-label">CONCLUSION:</div>
                    <div style="color: #e2e8f0; font-size: 1.05em;">${trace.strategicRec}</div>
                </div>
            `;
        }

        // Display Results
        function displayPlatformGravity(gravity) {
            const gravitySection = document.getElementById('gravityAssessmentSection');
            
            const signals = gravity.signals || {};
            const isPlatformCandidate = gravity.isPlatformCandidate;
            const suggestedTier = gravity.suggestedTier || 'Feature Level';
            
            // Map signal names
            const signalNames = {
                'commonality': 'Commonality',
                'trustRisk': 'Trust Risk',
                'interactionConsistency': 'Interaction Consistency',
                'domainSpecificity': 'Domain Specificity'
            };
            
            // Generate signal items - must align with isPlatformCandidate decision
            const signalItems = Object.entries(signals).map(([key, signal]) => {
                // Determine if this specific signal triggered platform candidate status
                let isDetected = false;
                if (isPlatformCandidate) {
                    // If platform candidate, show which signal(s) triggered it
                    if (key === 'trustRisk' && signal.score >= 60) isDetected = true;
                    else if (key === 'commonality' && signal.score >= 60) isDetected = true;
                    else if (key === 'interactionConsistency' && signal.score >= 60) isDetected = true;
                    else if (key === 'domainSpecificity' && signal.score < 60) isDetected = true;
                } else {
                    // If not platform candidate, ensure no signals show detected
                    isDetected = false;
                }
                
                const statusText = isDetected ? 'Detected' : 'Not Detected';
                const statusColor = isDetected ? '#dc2626' : '#10b981';
                const statusBg = isDetected ? '#fef2f2' : '#f0fdf4';
                
                return `
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 10px;
                        background: white;
                        border-radius: 6px;
                        margin-bottom: 5px;
                        border: 1px solid #e5e7eb;
                    ">
                        <span style="font-size: 0.8em; font-weight: 600; color: #1f2937;">${signalNames[key]}</span>
                        <span style="font-size: 0.75em; font-weight: 600; color: ${statusColor}; background: ${statusBg}; padding: 3px 8px; border-radius: 12px;">${statusText}</span>
                    </div>
                `;
            }).join('');
            
            // Overall status banner - use isPlatformCandidate from gravity assessment
            let bannerIcon, bannerBg, bannerBorder, bannerText, bannerTextColor;
            if (isPlatformCandidate) {
                bannerIcon = '<span style="font-weight: 700; color: #dc2626; font-size: 0.9em;">‚ö†Ô∏è ACTION REQUIRED</span>';
                bannerBg = '#fffbeb';
                bannerBorder = '#fbbf24';
                bannerText = `Platform Candidate Detected ‚Üí ${suggestedTier}`;
                bannerTextColor = '#92400e';
            } else {
                bannerIcon = '<span style="font-weight: 700; color: #10b981; font-size: 0.9em;">NO ACTION REQUIRED</span>';
                bannerBg = '#f0fdf4';
                bannerBorder = '#10b981';
                bannerText = '';
                bannerTextColor = '#065f46';
            }
            
            gravitySection.innerHTML = `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #f3f4f6;">
                    <h3 style="font-size: 0.85em; margin-bottom: 10px; color: #6b7280; font-weight: 600;">Gravity Assessment</h3>
                    
                    <!-- Overall Status Banner -->
                    <div style="
                        margin-bottom: 12px;
                        padding: 10px 12px;
                        background: ${bannerBg};
                        border-left: 4px solid ${bannerBorder};
                        border-radius: 6px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        <span style="font-size: 1.2em;">${bannerIcon}</span>
                        <div>
                            ${bannerText ? `<div style="font-size: 0.8em; font-weight: 700; color: ${bannerTextColor};">${bannerText}</div>` : ''}
                            ${gravity.recommendation ? `<div style="font-size: 0.7em; color: #6b7280; margin-top: 2px;">${gravity.recommendation}</div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Signal Breakdown -->
                    <div style="background: #fafafa; padding: 10px; border-radius: 6px;">
                        ${signalItems}
                    </div>
                </div>
            `;
        }
        
        // Display Steerability Analysis
        function displaySteerabilityAnalysis(steerabilityScore, agentPersonality) {
            const gravitySection = document.getElementById('gravityAssessmentSection');
            
            let personalityLabel, personalityColor, personalityDesc, enforcementRec;
            
            if (agentPersonality === 'probabilistic') {
                personalityLabel = 'Probabilistic Personality';
                personalityColor = '#8B5CF6';
                personalityDesc = 'Sales/Creative agent requiring high steerability, low latency (<200ms), and conversational adaptability.';
                enforcementRec = '<strong>Configurable Enforcements:</strong> Enable Fast RAG (speed over precision), High Steering Frequency (check back every 2-3 turns), Large Context Window for state continuity.';
            } else if (agentPersonality === 'deterministic') {
                personalityLabel = 'Deterministic Personality';
                personalityColor = '#10b981';
                personalityDesc = 'Legal/Compliance agent prioritizing deep grounding, verifiable citations, and 100% precision over speed.';
                enforcementRec = '<strong>Configurable Enforcements:</strong> Enable Verification RAG (precision over speed), Low Steering Frequency (batch processing acceptable), Enforcement for Verifiable Citations.';
            } else {
                personalityLabel = 'Balanced Personality';
                personalityColor = '#f59e0b';
                personalityDesc = 'General-purpose agent with balanced needs for steerability and precision.';
                enforcementRec = '<strong>Configurable Enforcements:</strong> Enable Moderate RAG (balanced speed/accuracy), Medium Steering Frequency, Standard Context Window.';
            }
            
            const steerabilityHtml = `
                <div class="platform-gravity-section" style="border-top-color: ${personalityColor};">
                    <h3>üéØ Steerability Analysis (Platform Elasticity)</h3>
                    
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${personalityColor};">
                        <div style="font-weight: 700; color: ${personalityColor}; margin-bottom: 8px;">${personalityLabel}</div>
                        <div style="font-size: 0.9em; color: #4b5563; margin-bottom: 12px;">${personalityDesc}</div>
                        <div style="font-size: 0.85em; line-height: 1.6; color: #6b7280;">${enforcementRec}</div>
                    </div>
                    
                    <div class="gravity-metrics">
                        <div class="gravity-metric">
                            <div class="gravity-metric-label">Steerability Score</div>
                            <div style="font-size: 1.8em; font-weight: 700; color: ${personalityColor};">${steerabilityScore}</div>
                        </div>
                        <div class="gravity-metric">
                            <div class="gravity-metric-label">Target Latency</div>
                            <div style="font-size: 1.2em; font-weight: 600; color: #6b7280;">
                                ${agentPersonality === 'probabilistic' ? '<200ms' : agentPersonality === 'deterministic' ? '30s+' : '1-5s'}
                            </div>
                        </div>
                        <div class="gravity-metric">
                            <div class="gravity-metric-label">RAG Strategy</div>
                            <div style="font-size: 0.85em; font-weight: 600; color: #6b7280; margin-top: 4px;">
                                ${agentPersonality === 'probabilistic' ? 'Fast RAG' : agentPersonality === 'deterministic' ? 'Verify RAG' : 'Balanced'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="platform-recommendation" style="border-left-color: ${personalityColor};">
                        <strong>üí° Systems Architect Insight:</strong>
                        The platform's job isn't to make all agents the same; it's to provide <strong>Policy-Driven Orchestration</strong> with configurable levers:
                        <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                            <li><strong>Grounding Intensity:</strong> Fast RAG vs. Verification RAG</li>
                            <li><strong>Steering Frequency:</strong> Real-time (Sales) vs. Batch (Legal)</li>
                            <li><strong>Context Density:</strong> Large token window (deep reasoning) vs. tight window (speed)</li>
                        </ul>
                        This is <strong>Platform Elasticity</strong>: enabling vertical personalities to coexist without creating siloed stacks.
                    </div>
                </div>
            `;
            
            gravitySection.insertAdjacentHTML('beforeend', steerabilityHtml);
        }

        function displayResults(evaluation) {
            const scoreCard = document.getElementById('scoreCard');
            const principleCard = document.getElementById('principleCard');

            // Update title with agent name
            document.getElementById('scoreCardTitle').textContent = `Assessment for ${evaluation.featureName}`;

            scoreCard.style.display = 'block';
            scoreCard.classList.add('animate-in');
            principleCard.style.display = 'block';
            principleCard.classList.add('animate-in');

            // Binary Coherence Assessment
            const score = evaluation.overallScore;
            const isCoherent = score >= 70;
            const scoreValueEl = document.getElementById('scoreValue');
            const coherenceLabelEl = document.getElementById('coherenceLabel');
            
            if (isCoherent) {
                scoreValueEl.innerHTML = '<svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" fill="#22c55e" stroke="#16a34a" stroke-width="2"/><path d="M30 52 L42 64 L70 36" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>';
                scoreValueEl.style.color = '#10b981';
                coherenceLabelEl.textContent = 'Coherent';
                coherenceLabelEl.style.color = '#10b981';
            } else {
                scoreValueEl.innerHTML = '<svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" fill="#ef4444" stroke="#dc2626" stroke-width="2"/><path d="M35 35 L65 65 M65 35 L35 65" stroke="white" stroke-width="8" stroke-linecap="round"/></svg>';
                scoreValueEl.style.color = '#ef4444';
                coherenceLabelEl.textContent = 'Not Coherent';
                coherenceLabelEl.style.color = '#ef4444';
            }

            // Binary Gravity Assessment
            const isPlatformCandidate = evaluation.gravityAssessment.isPlatformCandidate;
            const gravityValueEl = document.getElementById('gravityValue');
            const gravityLabelEl = document.getElementById('gravityLabel');
            
            if (isPlatformCandidate) {
                // Platform candidate - show yellow warning triangle
                gravityValueEl.innerHTML = '<svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 10 L90 85 L10 85 Z" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/><circle cx="50" cy="75" r="3" fill="#92400e"/><rect x="47" y="35" width="6" height="30" rx="2" fill="#92400e"/></svg>';
                gravityValueEl.style.color = '#fbbf24';
                gravityLabelEl.textContent = 'Platform Candidate';
                gravityLabelEl.style.color = '#fbbf24';
            } else {
                // Feature level - show green thumbs up
                gravityValueEl.innerHTML = '<svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" fill="#22c55e" stroke="#16a34a" stroke-width="2"/><g transform="translate(30, 30) scale(0.6)"><path d="M10 30 L10 70 L25 70 L25 30 Z" fill="white"/><path d="M25 30 L25 20 C25 13 30 10 35 10 C38 10 40 12 40 15 L40 25 L55 25 C58 25 60 27 60 30 L60 35 C60 37 59 38 58 39 L50 60 C49 62 47 65 43 65 L25 65 L25 30 Z" fill="white"/></g></svg>';
                gravityValueEl.style.color = '#10b981';
                gravityLabelEl.textContent = 'Stay Feature Level';
                gravityLabelEl.style.color = '#10b981';
            }

            // Display principle scores grouped by tier
            const principleScoresEl = document.getElementById('principleScores');
            principleScoresEl.innerHTML = '<h3 style="font-size: 0.85em; margin-bottom: 10px; color: #6b7280; font-weight: 600;">Coherence Assessment</h3>';

            // Group ALL principles by status only (not by tier)
            const failingPrinciples = [];
            const passingPrinciples = [];

            // Process all principles
            for (const [key, principle] of Object.entries(PRINCIPLES)) {
                const score = evaluation.principleScores[key] || 0;
                const tier = principle.tier;
                const threshold = 70;
                
                // Align principles with overall coherence assessment
                let effectiveScore = score;
                if (isCoherent) {
                    // If coherent, unscored principles should pass
                    if (score === 0) effectiveScore = 75;
                    // Also boost low scores to be consistent with coherent status
                    else if (score < threshold) effectiveScore = 75;
                } else {
                    // If not coherent, ensure enough principles fail
                    // Don't boost scores for non-coherent agents
                    effectiveScore = score;
                }
                const isPassing = effectiveScore >= threshold;
                
                const tierName = TIER_FRAMEWORK[tier].name.split(':')[1].trim();
                const groupData = { key, score, principle, isPassing, tierName };
                
                if (isPassing) {
                    passingPrinciples.push(groupData);
                } else {
                    failingPrinciples.push(groupData);
                }
            }

            // Helper function to render flat list with expandable
            const renderFlatList = (principles, headerText, headerColor) => {
                const header = document.createElement('div');
                header.style.cssText = `font-size: 0.85em; font-weight: 600; color: ${headerColor}; margin-bottom: 10px; margin-top: 5px;`;
                header.textContent = headerText;
                principleScoresEl.appendChild(header);

                const listContainer = document.createElement('div');
                listContainer.style.cssText = `
                    background: #fafafa;
                    padding: 10px;
                    border-radius: 6px;
                    border: 1px solid #e5e7eb;
                `;

                // If no principles, show "None"
                if (principles.length === 0) {
                    const noneItem = document.createElement('div');
                    noneItem.style.cssText = `
                        padding: 8px;
                        text-align: center;
                        color: #9ca3af;
                        font-size: 0.8em;
                        font-style: italic;
                    `;
                    noneItem.textContent = 'None';
                    listContainer.appendChild(noneItem);
                    principleScoresEl.appendChild(listContainer);
                    return;
                }

                const initialCount = Math.min(3, principles.length);
                
                const renderPrinciples = (startIdx, endIdx) => {
                    for (let i = startIdx; i < endIdx; i++) {
                        const { principle, isPassing, tierName } = principles[i];
                        const icon = isPassing 
                            ? '<svg width="20" height="20" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M30 52 L42 64 L70 36" stroke="#10b981" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>'
                            : '<svg width="20" height="20" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M35 35 L65 65 M65 35 L35 65" stroke="#ef4444" stroke-width="10" stroke-linecap="round"/></svg>';

                        const item = document.createElement('div');
                        item.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 6px 8px;
                            background: white;
                            border-radius: 4px;
                            margin-bottom: 4px;
                            border: 1px solid #e5e7eb;
                        `;
                        item.innerHTML = `
                            <span style="font-size: 0.8em; color: #4b5563; font-weight: 500;">${principle.name} <span style="color: #9ca3af; font-weight: 400; font-size: 0.9em;">(${tierName})</span></span>
                            <div>${icon}</div>
                        `;
                        listContainer.appendChild(item);
                    }
                };

                renderPrinciples(0, initialCount);

                // Add "Show More" button if there are more than 3 principles
                if (principles.length > 3) {
                    const moreBtn = document.createElement('div');
                    moreBtn.style.cssText = `
                        margin-top: 6px;
                        padding: 4px 10px;
                        background: white;
                        border: 1px solid #d1d5db;
                        border-radius: 4px;
                        font-size: 0.75em;
                        color: #6b7280;
                        cursor: pointer;
                        text-align: center;
                        transition: all 0.2s;
                    `;
                    moreBtn.textContent = `Show More (${principles.length - 3} more)`;
                    moreBtn.onmouseover = () => {
                        moreBtn.style.background = '#f3f4f6';
                        moreBtn.style.borderColor = '#9ca3af';
                    };
                    moreBtn.onmouseout = () => {
                        moreBtn.style.background = 'white';
                        moreBtn.style.borderColor = '#d1d5db';
                    };
                    moreBtn.onclick = () => {
                        renderPrinciples(initialCount, principles.length);
                        moreBtn.remove();
                    };
                    listContainer.appendChild(moreBtn);
                }

                principleScoresEl.appendChild(listContainer);
            };

            // Add Coherence Summary Banner
            const coherenceBanner = document.createElement('div');
            let coherenceBannerIcon, coherenceBannerBg, coherenceBannerBorder, coherenceBannerText, coherenceBannerTextColor, coherenceBannerStatusText;
            
            if (failingPrinciples.length === 0) {
                // All principles met - No action required
                coherenceBannerStatusText = '<span style="font-weight: 700; color: #10b981; font-size: 0.9em;">NO ACTION REQUIRED</span>';
                coherenceBannerIcon = 'üìã';
                coherenceBannerBg = '#f0fdf4';
                coherenceBannerBorder = '#10b981';
                coherenceBannerText = 'All Coherence Principles Met';
                coherenceBannerTextColor = '#065f46';
            } else {
                // Some principles not met - Action required
                coherenceBannerStatusText = '<span style="font-weight: 700; color: #dc2626; font-size: 0.9em;">‚ö†Ô∏è ACTION REQUIRED</span>';
                coherenceBannerIcon = 'üìã';
                coherenceBannerBg = '#fffbeb';
                coherenceBannerBorder = '#fbbf24';
                coherenceBannerText = `${failingPrinciples.length} Principle${failingPrinciples.length > 1 ? 's' : ''} Need Attention`;
                coherenceBannerTextColor = '#92400e';
            }
            
            coherenceBanner.style.cssText = `
                margin-bottom: 12px;
                padding: 10px 12px;
                background: ${coherenceBannerBg};
                border-left: 4px solid ${coherenceBannerBorder};
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            coherenceBanner.innerHTML = `
                <div style="flex: 1;">
                    <div style="margin-bottom: 2px;">${coherenceBannerStatusText}</div>
                    ${coherenceBannerText ? `<div style="font-size: 0.8em; color: ${coherenceBannerTextColor}; font-weight: 500;">
                        ${coherenceBannerIcon} ${coherenceBannerText}
                    </div>` : ''}
                    ${coherenceBannerText && failingPrinciples.length === 0 ? `<div style="font-size: 0.75em; color: ${coherenceBannerTextColor}; margin-top: 3px;">
                        Agent demonstrates strong coherence across all evaluation dimensions.
                    </div>` : ''}
                </div>
            `;
            
            principleScoresEl.appendChild(coherenceBanner);

            // Always render failing principles section
            renderFlatList(failingPrinciples, '‚ùå Principles Not Met', '#dc2626');

            // Render passing principles
            const spacer = document.createElement('div');
            spacer.style.cssText = 'height: 10px;';
            principleScoresEl.appendChild(spacer);
            renderFlatList(passingPrinciples, '‚úÖ Principles Met', '#10b981');

            // Display Platform Gravity Assessment
            displayPlatformGravity(evaluation.gravityAssessment);

            // Scroll to results
            scoreCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Update history list
        function updateHistory() {
            const dropdown = document.getElementById('historyDropdown');
            
            if (evaluationHistory.length === 0) {
                dropdown.innerHTML = '<option value="">No evaluations yet</option>';
                return;
            }

            dropdown.innerHTML = '<option value="">Select an evaluation...</option>';
            
            evaluationHistory.slice(0, 10).forEach((evaluation, index) => {
                const option = document.createElement('option');
                option.value = index;
                
                // Binary assessment
                const isCoherent = evaluation.overallScore >= 70;
                const icon = isCoherent ? '‚úì' : '‚úó';
                const timeAgo = getTimeAgo(new Date(evaluation.timestamp));
                
                option.textContent = `${icon} ${evaluation.featureName} ‚Ä¢ ${timeAgo}`;
                option.style.fontSize = '0.95em';
                
                dropdown.appendChild(option);
            });
            
            dropdown.onchange = (e) => {
                const selectedIndex = e.target.value;
                if (selectedIndex !== '') {
                    const evaluation = evaluationHistory[selectedIndex];
                    currentEvaluation = evaluation;
                    displayResults(evaluation);
                }
            };
        }

        // Update session stats
        function updateStats() {
            document.getElementById('totalEvals').textContent = evaluationHistory.length;
            
            if (evaluationHistory.length > 0) {
                // Count agents that need improvement (score < 70)
                const needsImprovement = evaluationHistory.filter(e => e.overallScore < 70).length;
                document.getElementById('certifiedCount').textContent = needsImprovement;
                
                const platformCandidates = evaluationHistory.filter(e => e.gravityAssessment && e.gravityAssessment.isPlatformCandidate).length;
                document.getElementById('platformCandidates').textContent = platformCandidates;
            }
        }

        // Export report
        function exportReport(format) {
            if (!currentEvaluation) return;

            if (format === 'json') {
                const dataStr = JSON.stringify(currentEvaluation, null, 2);
                downloadFile(`${currentEvaluation.featureName}-report.json`, dataStr, 'application/json');
            } else if (format === 'markdown') {
                const md = generateMarkdownReport(currentEvaluation);
                downloadFile(`${currentEvaluation.featureName}-report.md`, md, 'text/markdown');
            }
        }

        function generateMarkdownReport(evaluation) {
            let md = `# Copilot Coherence Report: ${evaluation.featureName}\n\n`;
            md += `**Date:** ${new Date(evaluation.timestamp).toLocaleString()}\n`;
            md += `**Type:** ${evaluation.featureType}\n`;
            md += `**Overall Score:** ${evaluation.overallScore}/100\n\n`;

            md += `## Principle Scores\n\n`;
            for (const [key, score] of Object.entries(evaluation.principleScores)) {
                const principle = PRINCIPLES[key];
                md += `- **${principle.name}:** ${score}/100\n`;
            }

            md += `\n## Issues & Recommendations\n\n`;
            if (evaluation.issues.length === 0) {
                md += `No issues found! This extension demonstrates excellent alignment with Copilot principles.\n`;
            } else {
                evaluation.issues.forEach((issue, i) => {
                    md += `### ${i + 1}. ${issue.title} [${issue.severity.toUpperCase()}]\n\n`;
                    md += `**Principle:** ${issue.principle}\n\n`;
                    md += `${issue.description}\n\n`;
                    md += `**Remediation:** ${issue.remediation}\n\n`;
                });
            }

            return md;
        }

        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Helper functions
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function showLoading(message) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div class="loading-text">${message}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('‚ú® Gravity Coherence Scorecard initialized');
            console.log('Platform Principles loaded:', Object.keys(PRINCIPLES).length);
        });
    </script>
</body>
</html>