<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declarative Agent Coherence & Gravity Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Segoe UI Web (West European)', 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', sans-serif;
            background: #faf9f8;
            color: #201f1e;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Top Banner */
        .sidebar {
            background: linear-gradient(white, white) padding-box, linear-gradient(90deg, #A78BFA, #FBBF24, #10B981, #60A5FA) border-box;
            border: 1.5px solid transparent;
            color: #4C1D95;
            padding: 20px 30px;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.08);
            flex-shrink: 0;
        }

        .sidebar h1 {
            font-size: 1.75em;
            margin-bottom: 4px;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar .tagline {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 18px;
            text-align: center;
            font-weight: 500;
        }

        .principle-section {
            margin-bottom: 12px;
        }

        .principle-section h3 {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            opacity: 0.7;
            margin-bottom: 8px;
            font-weight: 700;
            text-align: center;
        }

        .principles-grid {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            gap: 6px;
            margin-bottom: 10px;
        }

        .principle-item {
            padding: 4px 4px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #E9D5FF;
            text-align: center;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.05);
            min-width: 0;
        }

        .principle-item:hover {
            background: #FAF5FF;
            border-color: #C4B5FD;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.12);
        }

        .principle-item.active {
            background: #F3E8FF;
            border-color: #A78BFA;
        }

        .principle-item .name {
            font-weight: 700;
            font-size: 0.85em;
            margin-bottom: 3px;
            color: #5B21B6;
        }

        .principle-item .description {
            font-size: 0.72em;
            opacity: 0.75;
            line-height: 1.2;
            color: #6D28D9;
        }

        .stats-summary {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid #E9D5FF;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .stats-summary h3 {
            display: none;
        }

        .stat-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-row .label {
            opacity: 0.7;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            color: #5B21B6;
        }

        .stat-row .value {
            font-weight: 700;
            font-size: 1.8em;
            color: #7C3AED;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border-radius: 50%;
            border: 2px solid #A78BFA;
            background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
        }

        .header {
            padding: 12px 30px;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, #A78BFA, #FBBF24, #10B981, #60A5FA) 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-left p {
            font-size: 0.9em;
            color: #6b7280;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #A78BFA 0%, #8B5CF6 100%);
            color: white;
            font-family: 'Segoe UI', 'Segoe UI Web', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.35);
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #f9fafb;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-areas: "left right";
            gap: 30px;
            align-items: start;
            width: 100%;
        }

        /* Input Panel */
        .input-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            grid-area: left;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-info {
            background: #F3E9FF;
            color: #6D28D9;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95em;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #A78BFA;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.15);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
        }

        .form-hint {
            font-size: 0.8em;
            color: #6b7280;
            margin-top: 6px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .principle-weights-list {
            margin-top: 15px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.85em;
        }

        .principle-weights-list h4 {
            font-size: 0.9em;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .weight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 6px;
            border: 1px solid #e5e7eb;
        }

        .weight-item:last-child {
            margin-bottom: 0;
        }

        .weight-item-name {
            font-weight: 500;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weight-item-value {
            font-weight: 700;
            color: #5B21B6;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .weight-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .weight-badge.fixed {
            background: #fee2e2;
            color: #991b1b;
        }

        .weight-badge.variable {
            background: #dbeafe;
            color: #1e40af;
        }

        .weight-min-req {
            font-size: 0.8em;
            color: #6b7280;
            font-weight: normal;
        }

        .quick-templates {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .template-chip {
            padding: 4px 10px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-chip:hover {
            background: #F3E8FF;
            border-color: #C4B5FD;
            color: #5B21B6;
        }

        /* Domain Profile Styles */
        .domain-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }

        .domain-badge.legal {
            background: #dbeafe;
            color: #1e40af;
        }

        .domain-badge.sales {
            background: #dcfce7;
            color: #166534;
        }

        .domain-badge.healthcare {
            background: #fce7f3;
            color: #9f1239;
        }

        .domain-badge.creative {
            background: #fef3c7;
            color: #92400e;
        }

        .domain-badge.finance {
            background: #e0e7ff;
            color: #3730a3;
        }

        .principle-weight-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }

        .weight-critical {
            background: #dc2626;
            box-shadow: 0 0 4px rgba(220, 38, 38, 0.5);
        }

        .weight-high {
            background: #f59e0b;
        }

        .weight-normal {
            background: #10b981;
        }

        .weight-low {
            background: #9ca3af;
        }

        /* Live Feedback */
        .live-feedback {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.85em;
        }

        .live-feedback-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-feedback-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .feedback-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 4px;
        }

        .feedback-item.success {
            background: #d1fae5;
            color: #065f46;
        }

        .feedback-item.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .feedback-item.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .feedback-icon {
            font-size: 1em;
            flex-shrink: 0;
        }

        .principle-status-icon {
            font-size: 1em;
            margin-left: 4px;
        }

        .live-score-preview {
            background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%);
            padding: 10px;
            border-radius: 6px;
            margin-top: 12px;
            text-align: center;
            font-weight: 600;
            color: #5B21B6;
        }

        /* Results Panel */
        .results-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .score-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            position: relative;
        }

        .score-circle .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5em;
            font-weight: 700;
        }

        .score-label {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .score-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .score-status.excellent {
            background: #d1fae5;
            color: #065f46;
        }

        .score-status.good {
            background: #E0E7FF;
            color: #4C1D95;
        }

        .score-status.needs-work {
            background: #fef3c7;
            color: #92400e;
        }

        .score-status.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .principle-scores {
            margin-top: 20px;
        }

        .principle-score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .principle-score-item:last-child {
            border-bottom: none;
        }

        .principle-score-item .name {
            font-size: 0.85em;
            color: #374151;
            font-weight: 600;
            flex: 1;
        }

        .principle-icon {
            font-size: 1.8em;
            min-width: 40px;
            text-align: right;
        }

        .principle-icon.pass {
            color: #10b981;
        }

        .principle-icon.fail {
            color: #ef4444;
        }

        /* Issues Panel */
        .issues-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .issue-item {
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #fafafa;
        }

        .issue-item.critical {
            border-left-color: #dc2626;
            background: #fef2f2;
        }

        .issue-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .issue-item.info {
            border-left-color: #8B5CF6;
            background: #FAF5FF;
        }

        .issue-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .issue-icon {
            font-size: 1.2em;
        }

        .issue-title {
            font-weight: 600;
            font-size: 0.95em;
            color: #1f2937;
        }

        .issue-description {
            font-size: 0.85em;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .issue-remediation {
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.8em;
            color: #059669;
            border: 1px solid #d1fae5;
        }

        .issue-remediation strong {
            display: block;
            margin-bottom: 4px;
            color: #047857;
        }

        /* Platform Gravity - now inline */
        .platform-gravity-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f3f4f6;
        }

        .platform-gravity-section h3 {
            font-size: 0.9em;
            margin-bottom: 15px;
            color: #6b7280;
            text-align: left;
        }

        .gravity-score-circle {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            position: relative;
        }

        .gravity-score-circle svg {
            transform: rotate(-90deg);
        }

        .gravity-score-circle .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: 700;
            color: #7C3AED;
        }

        .gravity-score-label {
            text-align: center;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #6b7280;
        }

        .gravity-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75em;
            font-weight: 600;
            background: linear-gradient(135deg, #E9D5FF 0%, #DDD6FE 100%);
            color: #5B21B6;
            margin-bottom: 15px;
        }

        .gravity-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .gravity-metric {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .gravity-metric-label {
            font-size: 0.82em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4C1D95;
        }

        .gravity-metric-bar {
            position: relative;
            width: 100%;
            height: 3px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: visible;
            margin-top: 6px;
        }

        .gravity-metric-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: #7C3AED;
            border-radius: 2px;
            transition: width 0.6s ease-out;
        }

        .gravity-metric-value {
            position: absolute;
            right: 0;
            top: -18px;
            font-weight: 700;
            font-size: 0.7em;
            color: #6b7280;
        }

        .platform-recommendation {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.85em;
            line-height: 1.5;
            border: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .platform-recommendation strong {
            display: block;
            margin-bottom: 6px;
            font-size: 0.95em;
            color: #374151;
        }

        .capability-matches {
            background: #F5F5F5;
            border-left: 4px solid #9CA3AF;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #4B5563;
        }

        .capability-matches strong {
            display: block;
            margin-bottom: 10px;
            color: #374151;
        }

        .capability-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
        }

        .capability-item:last-child {
            border-bottom: none;
        }

        /* History Panel */
        .history-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Right Sidebar Container */
        .right-sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            grid-area: right;
            width: 400px;
        }

        .history-panel .card {
            flex-shrink: 0;
        }

        .results-panel .card {
            flex-shrink: 0;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
        }

        .history-list::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 3px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: #C4B5FD;
            border-radius: 3px;
        }

        .history-list::-webkit-scrollbar-thumb:hover {
            background: #A78BFA;
        }

        .history-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }

        .history-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .history-item-name {
            font-weight: 600;
            font-size: 0.9em;
            color: #1f2937;
        }

        .history-item-score {
            font-weight: 700;
            font-size: 0.85em;
        }

        .history-item-meta {
            font-size: 0.75em;
            color: #6b7280;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.2em;
            margin-bottom: 8px;
            color: #6b7280;
        }

        .empty-state p {
            font-size: 0.9em;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 300px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #A78BFA;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1em;
            color: #374151;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .right-sidebar {
                max-height: none;
            }
            
            .principles-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .principles-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.4s ease-out;
        }

        /* Export Panel */
        .export-options {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .export-btn {
            flex: 1;
            padding: 8px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #e5e7eb;
        }

        /* Logic Trace */
        .logic-trace-section {
            margin-top: 20px;
            border-top: 2px solid #f3f4f6;
            padding-top: 20px;
        }

        .logic-trace-toggle {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%);
            border: 2px solid #C4B5FD;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #5B21B6;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logic-trace-toggle:hover {
            background: linear-gradient(135deg, #E9D5FF 0%, #DDD6FE 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
        }

        .logic-trace-content {
            display: none;
            margin-top: 15px;
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            color: #e2e8f0;
            line-height: 1.8;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .logic-trace-content.visible {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .trace-header {
            color: #a78bfa;
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 15px;
            border-bottom: 1px solid #475569;
            padding-bottom: 10px;
        }

        .trace-step {
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 3px solid #475569;
        }

        .trace-step-label {
            color: #94a3b8;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .trace-step-content {
            color: #cbd5e1;
            padding-left: 15px;
        }

        .trace-highlight {
            color: #fbbf24;
            font-weight: 600;
        }

        .trace-success {
            color: #10b981;
            font-weight: 600;
        }

        .trace-warning {
            color: #f59e0b;
            font-weight: 600;
        }

        .trace-info {
            color: #60a5fa;
            font-weight: 600;
        }

        .trace-conclusion {
            margin-top: 15px;
            padding: 12px;
            background: #0f172a;
            border-radius: 6px;
            border-left: 4px solid #a78bfa;
        }

        .trace-conclusion-label {
            color: #a78bfa;
            font-weight: 700;
            margin-bottom: 6px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>‚ú® Declarative Agent Coherence & Gravity Dashboard</h1>
            <p class="tagline">Evaluate agents against platform principles & strategic fit</p>

            <div class="stats-summary">
                <div class="stat-row">
                    <span class="value" id="totalEvals">0</span>
                    <span class="label">Evaluations</span>
                </div>
                <div class="stat-row">
                    <span class="value" id="certifiedCount">0</span>
                    <span class="label">Ecosystem Mismatch</span>
                </div>
                <div class="stat-row">
                    <span class="value" id="platformCandidates">0</span>
                    <span class="label">Platform Candidates</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-area">
                <div class="content-grid">
                    <!-- Input Panel -->
                    <div class="input-panel">
                        <!-- Agent Specification Card -->
                        <div class="card">
                            <div class="card-header">
                                <h3>Choose Agent to Evaluate</h3>
                            </div>

                            <div class="quick-templates">
                                <div class="template-chip" onclick="loadAgentProfile('finance')">üí∞ Finance</div>
                                <div class="template-chip" onclick="loadAgentProfile('legal')">‚öñÔ∏è Legal</div>
                                <div class="template-chip" onclick="loadAgentProfile('sales')">üíº Sales</div>
                                <div class="template-chip" onclick="loadAgentProfile('academic')">üéì Academic</div>
                                <div class="template-chip" onclick="loadAgentProfile('analyst')">üìä Analyst</div>
                                <div class="template-chip" onclick="loadAgentProfile('projectmanager')">üìã Project Manager</div>
                                <div class="template-chip" onclick="clearForm()" style="cursor: pointer;">üîÑ</div>
                            </div>

                            <div class="form-group">
                                <label>Agent Name & Details</label>
                                <div class="form-hint">Provide agent name, instructions, manifest, code, behavior description, and sample interactions</div>
                                <textarea id="featureDescription" placeholder="Agent Name: [Your agent name]&#10;&#10;Description: [Your agent's functionality, behavior, data handling, and user interactions...]" style="min-height: 120px;"></textarea>
                                
                                <!-- Live Feedback Panel -->
                                <div id="liveFeedback" class="live-feedback" style="display: none;">
                                    <div class="live-feedback-header">
                                        <span>‚ö°</span>
                                        <span>Live Principle Check</span>
                                    </div>
                                    <div id="liveFeedbackList" class="live-feedback-list"></div>
                                    <div id="liveScorePreview" class="live-score-preview" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Coherence Principles Card -->
                        <div class="card" style="margin-top: 15px; background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #A78BFA, #FBBF24, #10B981, #60A5FA) border-box; border: 1.5px solid transparent; border-radius: 12px;">
                            <div class="card-header">
                                <h3>Coherence Principles</h3>
                            </div>
                            <p style="font-size: 0.85em; color: #6b7280; margin-bottom: 15px; padding: 0 20px;"><strong>üëâ Drag sliders to adjust weights</strong> - Configure principle weights for platform alignment evaluation</p>
                            
                            <div style="padding: 0 20px 20px 20px;">
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                        <label style="margin: 0; flex: 0 0 auto;">üé® UX Signature (Consistent design language) - <span style="color: #9ca3af;">Fixed</span></label>
                                        <input type="range" id="slider-ux" min="50" max="100" value="100" disabled style="flex: 1; opacity: 0.5;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                        <label style="margin: 0; flex: 0 0 auto;">üîÑ Handoff Integrity (Intent preservation) - <span style="color: #9ca3af;">Fixed</span></label>
                                        <input type="range" id="slider-handoff" min="50" max="100" value="100" disabled style="flex: 1; opacity: 0.5;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                        <label style="margin: 0; flex: 0 0 auto;">üìä Grounding Fidelity (Data accuracy) - <span style="color: #10b981;">Variable</span></label>
                                        <input type="range" id="slider-grounding" min="50" max="100" value="70" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                        <label style="margin: 0; flex: 0 0 auto;">üëÅÔ∏è Transparency (Clear agent identity) - <span style="color: #9ca3af;">Fixed</span></label>
                                        <input type="range" id="slider-transparency" min="50" max="100" value="100" disabled style="flex: 1; opacity: 0.5;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                        <label style="margin: 0; flex: 0 0 auto;">üîí Privacy First (Data minimization) - <span style="color: #9ca3af;">Fixed</span></label>
                                        <input type="range" id="slider-privacy" min="50" max="100" value="100" disabled style="flex: 1; opacity: 0.5;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                        <label style="margin: 0; flex: 0 0 auto;">‚ö° Error Recovery (Graceful degradation) - <span style="color: #10b981;">Variable</span></label>
                                        <input type="range" id="slider-error" min="50" max="100" value="70" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                        <label style="margin: 0; flex: 0 0 auto;">üéØ Steerability (Real-time adaptability) - <span style="color: #10b981;">Variable</span></label>
                                        <input type="range" id="slider-steerability" min="50" max="100" value="70" style="flex: 1;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gravity Principles Card -->
                        <div class="card" style="margin-top: 10px; background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #A78BFA, #FBBF24, #10B981, #60A5FA) border-box; border: 1.5px solid transparent; border-radius: 12px;">
                            <div class="card-header">
                                <h3>Platform Gravity</h3>
                            </div>
                            <p style="font-size: 0.85em; color: #6b7280; margin-bottom: 15px; padding: 0 20px;">Strategic fit principles detected automatically</p>
                            
                            <div style="padding: 0 20px 20px 20px;">
                                <div style="font-size: 0.85em; color: #374151; line-height: 1.8;">
                                    <div style="padding: 8px 0; border-bottom: 1px solid #f3f4f6;">üåç Universal Need</div>
                                    <div style="padding: 8px 0; border-bottom: 1px solid #f3f4f6;">‚öôÔ∏è Complexity Burden</div>
                                    <div style="padding: 8px 0; border-bottom: 1px solid #f3f4f6;">üîó Interoperability Value</div>
                                    <div style="padding: 8px 0; border-bottom: 1px solid #f3f4f6;">üéØ Steerability Support</div>
                                    <div style="padding: 8px 0;">üíæ Memory & Context</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar: Results + History -->
                    <div class="right-sidebar" style="background: linear-gradient(white, white) padding-box, linear-gradient(135deg, #A78BFA, #FBBF24, #10B981, #60A5FA) border-box; border: 1.5px solid transparent; border-radius: 12px;">
                        <!-- Results Panel -->
                        <div class="results-panel">
                            <!-- Assessment Scores Card -->
                            <div class="card score-card" id="scoreCard" style="display: none;">
                                <h3 id="scoreCardTitle" style="font-size: 1.05em; font-weight: 600; color: #1f2937; margin-bottom: 20px; text-align: center;">Assessment Scores</h3>
                                
                                <div style="display: flex; gap: 40px; justify-content: center; align-items: center;">
                                    <!-- Coherence Score -->
                                    <div style="text-align: center;">
                                        <div style="font-size: 3em; margin-bottom: 10px; font-weight: 400; opacity: 0.9;" id="scoreValue">--</div>
                                        <div style="font-size: 0.9em; font-weight: 600; color: #6b7280;">Coherence</div>
                                        <div style="font-size: 0.75em; color: #9ca3af; margin-top: 5px;" id="coherenceLabel">Platform Alignment</div>
                                    </div>

                                    <!-- Platform Gravity Score -->
                                    <div style="text-align: center;">
                                        <div style="font-size: 3em; margin-bottom: 10px; font-weight: 400; opacity: 0.9;" id="gravityValue">--</div>
                                        <div style="font-size: 0.9em; font-weight: 600; color: #6b7280;">Platform Gravity</div>
                                        <div style="font-size: 0.75em; color: #9ca3af; margin-top: 5px;" id="gravityLabel">Strategic Fit</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Principle Breakdown Card -->
                            <div class="card" id="principleCard" style="display: none;">
                                <div class="principle-scores" id="principleScores"></div>
                            </div>
                        </div>

                        <!-- History Panel -->
                        <div class="history-panel">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Evaluation History</h3>
                                </div>
                                <div class="history-list" id="historyList">
                                    <div class="empty-state">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                        </svg>
                                        <h3>No evaluations yet</h3>
                                        <p>Start by evaluating your first agent</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Platform Principles Schema
        const PRINCIPLES = {
            'ux-signature': {
                name: 'UX Signature',
                weight: 0.20,
                checks: [
                    { id: 'progressive-disclosure', name: 'Progressive Disclosure', weight: 0.3 },
                    { id: 'consistent-typography', name: 'Consistent Typography', weight: 0.2 },
                    { id: 'copilot-tone', name: 'Copilot-appropriate Tone', weight: 0.3 },
                    { id: 'visual-hierarchy', name: 'Clear Visual Hierarchy', weight: 0.2 }
                ]
            },
            'handoff-integrity': {
                name: 'Handoff Integrity',
                weight: 0.20,
                checks: [
                    { id: 'intent-preservation', name: 'Intent Preservation', weight: 0.4 },
                    { id: 'context-continuity', name: 'Context Continuity', weight: 0.3 },
                    { id: 'privacy-protection', name: 'Privacy During Handoff', weight: 0.3 }
                ]
            },
            'grounding-fidelity': {
                name: 'Grounding Fidelity',
                weight: 0.20,
                checks: [
                    { id: 'data-usage', name: 'Accurate Data Usage', weight: 0.4 },
                    { id: 'no-hallucination', name: 'No Hallucinations', weight: 0.4 },
                    { id: 'source-citation', name: 'Source Citation', weight: 0.2 }
                ]
            },
            'transparency': {
                name: 'Transparency',
                weight: 0.1,
                checks: [
                    { id: 'agent-identity', name: 'Clear Agent Identity', weight: 0.4 },
                    { id: 'capability-disclosure', name: 'Capability Disclosure', weight: 0.3 },
                    { id: 'limitation-clarity', name: 'Limitation Clarity', weight: 0.3 }
                ]
            },
            'privacy': {
                name: 'Privacy First',
                weight: 0.1,
                checks: [
                    { id: 'data-minimization', name: 'Data Minimization', weight: 0.4 },
                    { id: 'jit-consent', name: 'Just-in-Time Consent', weight: 0.3 },
                    { id: 'retention-policy', name: 'Clear Retention Policy', weight: 0.3 }
                ]
            },
            'error-recovery': {
                name: 'Error Recovery',
                weight: 0.05,
                checks: [
                    { id: 'graceful-degradation', name: 'Graceful Degradation', weight: 0.4 },
                    { id: 'clear-errors', name: 'Clear Error Messages', weight: 0.3 },
                    { id: 'fallback-options', name: 'Fallback Options', weight: 0.3 }
                ]
            },
            'platform-gravity': {
                name: 'Platform Gravity',
                weight: 0, // Not included in coherence score
                checks: [
                    { id: 'ubiquity', name: 'Universal Need', weight: 0.25 },
                    { id: 'complexity-burden', name: 'Complexity Burden', weight: 0.25 },
                    { id: 'interoperability', name: 'Interoperability Value', weight: 0.20 },
                    { id: 'steerability-gravity', name: 'Steerability Support', weight: 0.15 },
                    { id: 'memory-context', name: 'Memory & Context', weight: 0.15 }
                ]
            },
            'steerability': {
                name: 'Steerability',
                weight: 0.15,
                checks: [
                    { id: 'state-continuity', name: 'State Continuity', weight: 0.35 },
                    { id: 'steering-frequency', name: 'Steering Frequency', weight: 0.35 },
                    { id: 'conversational-adaptability', name: 'Conversational Adaptability', weight: 0.3 }
                ]
            }
        };

        // Domain-Specific Principle Profiles
        const DOMAIN_PROFILES = {
            general: {
                name: 'General Purpose',
                weights: {
                    'ux-signature': 0.20,
                    'handoff-integrity': 0.20,
                    'grounding-fidelity': 0.20,
                    'transparency': 0.10,
                    'privacy': 0.10,
                    'error-recovery': 0.05,
                    'steerability': 0.15
                },
                description: 'Balanced evaluation for general-purpose agents'
            },
            legal: {
                name: 'Legal (High Accuracy)',
                emoji: '‚öñÔ∏è',
                weights: {
                    'grounding-fidelity': 0.35,      // ‚¨ÜÔ∏è Accuracy critical
                    'transparency': 0.20,            // ‚¨ÜÔ∏è Explainability
                    'privacy': 0.15,                 // ‚¨ÜÔ∏è Confidentiality
                    'handoff-integrity': 0.10,
                    'error-recovery': 0.10,
                    'ux-signature': 0.05,            // ‚¨áÔ∏è Less critical
                    'steerability': 0.05             // ‚¨áÔ∏è Less flexible
                },
                thresholds: {
                    'grounding-fidelity': 90,        // Minimum 90% accuracy
                    'transparency': 85,
                    'privacy': 90
                },
                description: 'Prioritizes accuracy, citations, and explainability. Latency trade-offs acceptable.',
                recommendations: [
                    'Add source citations for all claims',
                    'Include confidence scores',
                    'Implement audit trail logging',
                    'Use read-only data access patterns'
                ]
            },
            sales: {
                name: 'Sales (Low Latency)',
                emoji: 'üíº',
                weights: {
                    'ux-signature': 0.30,            // ‚¨ÜÔ∏è User experience critical
                    'steerability': 0.25,            // ‚¨ÜÔ∏è Conversational flexibility
                    'handoff-integrity': 0.15,
                    'grounding-fidelity': 0.12,      // ‚¨áÔ∏è Some approximation OK
                    'transparency': 0.08,
                    'privacy': 0.05,
                    'error-recovery': 0.05
                },
                thresholds: {
                    'ux-signature': 85,
                    'steerability': 80
                },
                performanceTarget: '< 2s response time',
                description: 'Optimizes for responsiveness and user experience. Tolerates approximate answers.',
                recommendations: [
                    'Implement response streaming',
                    'Cache common queries',
                    'Use fast approximate retrieval',
                    'Prioritize conversation flow over perfection'
                ]
            },
            health: {
                name: 'Health (High Privacy)',
                emoji: 'üè•',
                weights: {
                    'privacy': 0.35,                 // ‚¨ÜÔ∏è HIPAA compliance
                    'transparency': 0.25,            // ‚¨ÜÔ∏è Medical reasoning
                    'grounding-fidelity': 0.20,      // ‚¨ÜÔ∏è Clinical accuracy
                    'error-recovery': 0.10,
                    'handoff-integrity': 0.05,
                    'ux-signature': 0.03,
                    'steerability': 0.02
                },
                thresholds: {
                    'privacy': 95,                   // Near-perfect privacy required
                    'transparency': 85,
                    'grounding-fidelity': 88
                },
                requiredDisclaimer: 'I am an AI assistant, not a medical professional. Always consult your doctor.',
                description: 'HIPAA-compliant with mandatory disclaimers. Privacy and accuracy paramount.',
                recommendations: [
                    'Add medical disclaimer to every response',
                    'Implement end-to-end encryption',
                    'Use zero-retention for PHI',
                    'Require 2FA for sensitive operations',
                    'Log all data access for audit'
                ]
            },
            academic: {
                name: 'Academic (Research Focus)',
                emoji: 'üéì',
                weights: {
                    'grounding-fidelity': 0.35,      // ‚¨ÜÔ∏è Research accuracy
                    'transparency': 0.25,            // ‚¨ÜÔ∏è Source attribution
                    'steerability': 0.15,            // Academic exploration
                    'ux-signature': 0.10,
                    'handoff-integrity': 0.08,
                    'privacy': 0.05,
                    'error-recovery': 0.02
                },
                thresholds: {
                    'grounding-fidelity': 90,        // Academic rigor required
                    'transparency': 88
                },
                description: 'Emphasizes research accuracy, citations, and academic rigor. Peer-review standards.',
                recommendations: [
                    'Provide complete citations in academic format',
                    'Include confidence intervals for data',
                    'Link to peer-reviewed sources',
                    'Support multiple citation styles (APA, MLA, Chicago)',
                    'Flag preliminary or unverified research'
                ]
            },
            analyst: {
                name: 'Analyst (Data Driven)',
                emoji: 'üìä',
                weights: {
                    'grounding-fidelity': 0.30,      // ‚¨ÜÔ∏è Data accuracy
                    'transparency': 0.25,            // ‚¨ÜÔ∏è Methodology disclosure
                    'ux-signature': 0.20,            // Clear data visualization
                    'steerability': 0.12,
                    'handoff-integrity': 0.08,
                    'privacy': 0.03,
                    'error-recovery': 0.02
                },
                thresholds: {
                    'grounding-fidelity': 85,        // Data integrity critical
                    'transparency': 80,
                    'ux-signature': 75
                },
                description: 'Optimizes for data accuracy, analytical rigor, and clear visual communication.',
                recommendations: [
                    'Show data sources and methodology',
                    'Include statistical confidence levels',
                    'Use clear charts and visualizations',
                    'Provide downloadable data tables',
                    'Document assumptions and limitations'
                ]
            },
            projectmanager: {
                name: 'Project Manager (Coordination)',
                emoji: 'üìã',
                weights: {
                    'handoff-integrity': 0.35,       // ‚¨ÜÔ∏è Context preservation critical
                    'steerability': 0.25,            // ‚¨ÜÔ∏è Adaptive planning
                    'ux-signature': 0.20,            // Clear communication
                    'transparency': 0.10,
                    'grounding-fidelity': 0.05,
                    'privacy': 0.03,
                    'error-recovery': 0.02
                },
                thresholds: {
                    'handoff-integrity': 90,         // Seamless coordination
                    'steerability': 85,
                    'ux-signature': 80
                },
                description: 'Prioritizes coordination, context handoffs, and adaptive project management.',
                recommendations: [
                    'Maintain detailed task context across sessions',
                    'Support multiple project views (Gantt, Kanban)',
                    'Enable seamless delegation and handoffs',
                    'Track dependencies and blockers',
                    'Provide status summaries and progress updates'
                ]
            },
            finance: {
                name: 'Finance (High Compliance)',
                emoji: 'üí∞',
                weights: {
                    'transparency': 0.30,            // ‚¨ÜÔ∏è Regulatory disclosure
                    'grounding-fidelity': 0.25,      // ‚¨ÜÔ∏è Accuracy for analysis
                    'privacy': 0.20,                 // ‚¨ÜÔ∏è Financial data security
                    'error-recovery': 0.10,
                    'handoff-integrity': 0.08,
                    'ux-signature': 0.05,
                    'steerability': 0.02
                },
                thresholds: {
                    'transparency': 90,              // Must disclose limitations
                    'grounding-fidelity': 85,
                    'privacy': 88
                },
                requiredDisclaimer: 'For informational purposes only, not financial advice. Consult a licensed advisor.',
                description: 'Compliance-first with mandatory disclaimers. No stock recommendations.',
                recommendations: [
                    'Add financial disclaimer to all responses',
                    'Never provide specific stock picks',
                    'Link to authoritative sources (SEC, FINRA)',
                    'Implement read-only financial data access',
                    'Require 2FA for account access'
                ]
            }
        };

        // Platform Capabilities Registry
        const PLATFORM_CAPABILITIES = [
            { name: 'Authentication', keywords: ['auth', 'login', 'sso', 'identity', 'signin'] },
            { name: 'Payment Processing', keywords: ['payment', 'checkout', 'billing', 'transaction', 'credit card'] },
            { name: 'Document Intelligence', keywords: ['ocr', 'pdf parse', 'document extract', 'receipt scan', 'text recognition'] },
            { name: 'Search & Retrieval', keywords: ['search', 'query', 'retrieve', 'find', 'lookup'] },
            { name: 'Calendar Integration', keywords: ['calendar', 'schedule', 'appointment', 'meeting', 'availability'] },
            { name: 'Email Integration', keywords: ['email', 'inbox', 'send mail', 'message'] },
            { name: 'File Storage', keywords: ['file upload', 'storage', 'cloud storage', 'save file'] },
            { name: 'User Preferences', keywords: ['preference', 'settings', 'remember', 'user profile'] },
            { name: 'Notifications', keywords: ['notify', 'alert', 'push notification', 'reminder'] },
            { name: 'Translation', keywords: ['translate', 'language', 'multilingual'] },
            { name: 'Voice Synthesis', keywords: ['text to speech', 'tts', 'voice', 'audio generation'] },
            { name: 'Image Generation', keywords: ['image gen', 'create image', 'dall-e', 'picture'] },
            { name: 'Data Encryption', keywords: ['encrypt', 'secure', 'cipher', 'crypto'] }
        ];

        // Feature Templates
        const TEMPLATES = {
            travel: {
                name: 'SmartTravel Booking Agent',
                type: 'declarative',
                instructions: `You are SmartTravel, an AI travel assistant. Always introduce yourself clearly. Request only necessary permissions with clear explanations. Present options with transparent trade-offs. Respect user privacy and data minimization principles.`,
                manifest: `{"schema_version": "v2.1",
  "name": "SmartTravel",
  "description": "AI travel booking assistant",
  "instructions": "Help users plan trips with personalized recommendations",
  "capabilities": {
    "conversation_starters": [
      "Plan a trip to Paris",
      "Find budget-friendly flights",
      "Show me weekend getaways"
    ]
  },
  "actions": [
    {"name": "searchFlights", "description": "Search for flight options"},
    {"name": "checkCalendar", "description": "Check user availability", "requires_consent": true}
  ]
}`,
                apiActions: `async function searchFlights(destination, dates) {
  // Always request consent before calendar access
  const calendarConsent = await requestPermission('Calendar.Read', 
    'I\'ll check your calendar to avoid conflicts');
  
  if (!calendarConsent) {
    // Graceful fallback: manual date entry
    return await searchWithManualDates(destination);
  }
  
  const availableDates = await graph.calendar.getFreeSlots();
  return await travelAPI.search({destination, dates: availableDates});
}`,
                description: `A travel booking agent that helps users plan trips based on their preferences and budget.

User Interaction Flow:
1. Agent introduces itself: "I'm SmartTravel, your AI travel assistant"
2. Asks for destination and dates conversationally
3. Requests calendar access with clear justification: "I'll check your calendar to avoid conflicts"
4. Shows 3-5 personalized options with clear trade-offs (price vs. convenience)
5. Uses consistent Copilot UI patterns (cards, progressive disclosure)
6. Provides clear booking steps and confirmation

Data Handling:
- Requests only necessary data (destination, dates, budget)
- Explains why each permission is needed
- Does not store payment information
- Clears temporary data after booking

Privacy:
- Just-in-time consent for calendar access
- Option to search without location data
- Clear data retention policy (30 days)`,
                trace: `User: Help me plan a trip to Paris
Agent: I'm SmartTravel, your AI travel assistant! üåç I can help you find the best options for Paris.

To give you personalized recommendations, I'd like to:
‚Ä¢ Check your calendar for available dates
‚Ä¢ Use your location to find the best departure airport

Is that okay?

User: Yes, that's fine

Agent: Great! I found you're free June 15-22. Here are 3 options:

[Shows 3 flight options with clear pricing, airlines, and trade-offs]
Option 1: Budget-friendly ($450) - 1 stop
Option 2: Balanced ($650) - Direct flight
Option 3: Premium ($890) - Direct + extra legroom

Which interests you?`
            },
            shopping: {
                name: 'PersonalShopper AI',
                type: 'declarative',
                instructions: `You are a shopping assistant that helps find products. Use browsing history to personalize recommendations. Show product comparisons.`,
                manifest: `{"schema_version": "v2.1",
  "name": "PersonalShopper",
  "description": "AI shopping assistant",
  "capabilities": {
    "conversation_starters": [
      "Find me a laptop for design work",
      "Show budget-friendly options"
    ]
  },
  "actions": [
    {"name": "searchProducts", "description": "Search for products"},
    {"name": "trackPrices", "description": "Track price changes"}
  ]
}`,
                apiActions: `async function searchProducts(query, prefs) {
  // Check if user has browsing history enabled
  const useHistory = prefs.useHistory || true;
  
  if (useHistory) {
    return await productAPI.searchPersonalized(query, prefs);
  }
  
  return await productAPI.searchGeneric(query);
}`,
                description: `A shopping assistant that helps users find products matching their needs.

Features:
- Product recommendations based on browsing history
- Price tracking and deal alerts
- Comparison tables

UX Patterns:
- Shows multiple product options
- Progressive disclosure for details
- Card-based layout

Data Usage:
- Uses browsing history for personalization
- Tracks price changes
- Stores user preferences`,
                trace: `User: I need a new laptop for design work
Agent: Sure! Let me find you some options.

Based on "design work," here are laptops with:
‚Ä¢ High-resolution displays
‚Ä¢ Good specs
‚Ä¢ Various price points

User: Around $2000

Agent: Here are 3 options:
[Shows comparison table]

Option 1: Dell XPS 15 - $1899
Option 2: MacBook Pro 14" - $1999
Option 3: Lenovo ThinkPad X1 - $1850`
            },
            health: {
                name: 'WellnessCoach AI',
                type: 'declarative',
                instructions: `You are a wellness and fitness coach. Provide personalized fitness plans and nutrition guidance. Track user progress and send motivational reminders.`,
                manifest: `{"schema_version": "v2.1",
  "name": "WellnessCoach",
  "description": "AI wellness and fitness coach",
  "capabilities": {
    "conversation_starters": [
      "Help me start exercising",
      "Create a fitness plan"
    ]
  },
  "actions": [
    {"name": "createFitnessPlan", "description": "Generate personalized fitness recommendations"},
    {"name": "trackProgress", "description": "Track wellness goals"}
  ]
}`,
                apiActions: `async function trackProgress(userId) {
  // Get user's health data
  const healthData = await healthAPI.getProgress(userId);
  return healthData;
}`,
                description: `A health and wellness coaching agent that provides fitness and nutrition guidance.

Features:
- Personalized fitness plans
- Nutrition recommendations
- Progress tracking
- Daily motivational messages

UX Approach:
- Supportive tone
- Goal-setting
- Daily check-ins
- Achievement celebrations

Data Handling:
- Stores user progress
- Tracks exercise history
- Records nutrition logs`,
                trace: `User: Help me start exercising
Agent: Great! Let's get you moving! üí™

Tell me about your current activity level?
User: Pretty sedentary, desk job

Agent: Perfect! I'll create a custom plan for you.

Week 1: 30-min cardio, 5x/week
Week 2: Add strength training
Week 3: Increase intensity

I'll track your progress and send daily reminders at 7am.`
            },
            finance: {
                name: 'FinanceAdvisor Pro',
                type: 'declarative',
                instructions: `You are a financial advisor AI. Help users with investment decisions, budgeting, and portfolio management. Provide stock recommendations based on market analysis.`,
                manifest: `{"schema_version": "v2.1",
  "name": "FinanceAdvisor",
  "description": "AI financial advisor",
  "capabilities": {
    "conversation_starters": [
      "Analyze my portfolio",
      "Recommend stocks"
    ]
  },
  "actions": [
    {"name": "calculateBudget", "description": "Budget calculator"},
    {"name": "viewAccounts", "description": "View account balances"},
    {"name": "recommendStocks", "description": "Provide investment recommendations"}
  ]
}`,
                apiActions: `async function viewAccounts(userId) {
  // Access financial data
  return await financialAPI.getAccounts(userId);
}`,
                description: `A financial advisor agent that helps users manage investments and budgets.

Features:
- Portfolio analysis
- Stock recommendations
- Budget tracking
- Market insights

Capabilities:
- Analyzes user's financial accounts
- Provides personalized investment advice
- Tracks spending patterns
- Sends market alerts

Data Access:
- Views account balances
- Analyzes transaction history
- Monitors investment performance`,
                trace: `User: Should I invest in stocks?
Agent: Absolutely! Based on your profile, I recommend:

üìà Top Picks:
1. TechCorp - Strong growth potential
2. BioPharm Inc - Undervalued
3. Energy Solutions - Stable returns

I've analyzed your accounts and you have $15,000 available for investment. I suggest:
- 60% in growth stocks
- 30% in index funds
- 10% in crypto

Want me to create automatic buy orders?`
            }
        };

        // State Management
        let evaluationHistory = [];
        let currentEvaluation = null;
        let liveCheckTimeout = null;

        // Live Validation Functions
        function checkPrincipleInText(principle, text) {
            const lowerText = text.toLowerCase();
            const checks = [];

            switch(principle) {
                case 'transparency':
                    if (lowerText.includes('i\'m') || lowerText.includes('i am')) {
                        checks.push({ pass: true, message: '‚úì Agent introduces itself' });
                    } else if (text.length > 50) {
                        checks.push({ pass: false, message: '‚ö† Consider: "I\'m [AgentName], your..."' });
                    }
                    break;

                case 'privacy':
                    if (lowerText.includes('consent') || lowerText.includes('permission') || lowerText.includes('is that okay')) {
                        checks.push({ pass: true, message: '‚úì Requests consent' });
                    } else if (lowerText.includes('data') || lowerText.includes('access')) {
                        checks.push({ pass: false, message: '‚ö† Add just-in-time consent prompt' });
                    }

                    if (lowerText.includes('minimization') || lowerText.includes('only necessary')) {
                        checks.push({ pass: true, message: '‚úì Data minimization mentioned' });
                    }
                    break;

                case 'grounding-fidelity':
                    if (lowerText.includes('citation') || lowerText.includes('source') || lowerText.includes('reference')) {
                        checks.push({ pass: true, message: '‚úì Mentions sources/citations' });
                    } else if (text.length > 100) {
                        checks.push({ pass: false, message: '‚ö† Consider adding source citations' });
                    }
                    break;

                case 'error-recovery':
                    if (lowerText.includes('fallback') || lowerText.includes('graceful') || lowerText.includes('error')) {
                        checks.push({ pass: true, message: '‚úì Error handling mentioned' });
                    } else if (text.length > 100) {
                        checks.push({ pass: false, message: '‚ö† Add error recovery strategy' });
                    }
                    break;

                case 'ux-signature':
                    if (lowerText.includes('progressive') || lowerText.includes('cards') || lowerText.includes('copilot')) {
                        checks.push({ pass: true, message: '‚úì Copilot UX patterns mentioned' });
                    }
                    break;
            }

            return checks;
        }

        function performLiveCheck() {
            const description = document.getElementById('featureDescription').value;
            const combinedText = description;

            if (combinedText.trim().length < 20) {
                document.getElementById('liveFeedback').style.display = 'none';
                updatePrincipleIndicators({});
                return;
            }

            document.getElementById('liveFeedback').style.display = 'block';

            const feedback = [];
            const principleStatus = {};

            // Check each principle
            ['transparency', 'privacy', 'grounding-fidelity', 'error-recovery', 'ux-signature'].forEach(principle => {
                const checks = checkPrincipleInText(principle, combinedText);
                checks.forEach(check => {
                    feedback.push({
                        type: check.pass ? 'success' : 'warning',
                        message: check.message
                    });
                });

                // Determine principle status
                const passCount = checks.filter(c => c.pass).length;
                const totalCount = checks.length;
                if (totalCount === 0) {
                    principleStatus[principle] = 'neutral';
                } else if (passCount === totalCount) {
                    principleStatus[principle] = 'pass';
                } else if (passCount > 0) {
                    principleStatus[principle] = 'partial';
                } else {
                    principleStatus[principle] = 'fail';
                }
            });

            // Render feedback
            const feedbackList = document.getElementById('liveFeedbackList');
            feedbackList.innerHTML = '';

            if (feedback.length === 0) {
                feedbackList.innerHTML = '<div class="feedback-item" style="color: #6b7280;">Keep writing to see principle checks...</div>';
            } else {
                feedback.slice(0, 5).forEach(item => {
                    const div = document.createElement('div');
                    div.className = `feedback-item ${item.type}`;
                    div.innerHTML = `<span class="feedback-icon">${item.type === 'success' ? '‚úì' : '‚ö†'}</span><span>${item.message}</span>`;
                    feedbackList.appendChild(div);
                });
            }

            // Show estimated score
            const passCount = feedback.filter(f => f.type === 'success').length;
            const totalCount = feedback.length;
            if (totalCount > 0) {
                const estimatedScore = Math.round(50 + (passCount / totalCount) * 40);
                document.getElementById('liveScorePreview').style.display = 'block';
                document.getElementById('liveScorePreview').textContent = `Estimated Score: ${estimatedScore}/100`;
            }

            // Update principle indicators in top banner
            updatePrincipleIndicators(principleStatus);
        }

        function updatePrincipleIndicators(status) {
            document.querySelectorAll('.principle-item').forEach(item => {
                const principle = item.dataset.principle;
                const nameElement = item.querySelector('.name');
                
                // Remove existing status icons
                const existingIcon = nameElement.querySelector('.principle-status-icon');
                if (existingIcon) {
                    existingIcon.remove();
                }

                // Add new status icon
                if (status[principle]) {
                    const icon = document.createElement('span');
                    icon.className = 'principle-status-icon';
                    switch(status[principle]) {
                        case 'pass':
                            icon.textContent = '‚úì';
                            icon.style.color = '#10b981';
                            break;
                        case 'partial':
                            icon.textContent = '‚óã';
                            icon.style.color = '#f59e0b';
                            break;
                        case 'fail':
                            icon.textContent = '‚óã';
                            icon.style.color = '#dc2626';
                            break;
                    }
                    nameElement.appendChild(icon);
                }
            });
        }

        function onDescriptionChange() {
            // Clear hidden data when user types
            const textarea = document.getElementById('featureDescription');
            if (textarea.value.trim().length > 0) {
                textarea.removeAttribute('data-hidden-content');
            }
            
            // Debounce the live check
            clearTimeout(liveCheckTimeout);
            liveCheckTimeout = setTimeout(performLiveCheck, 500);
        }

        // Update slider labels when values change
        document.addEventListener('DOMContentLoaded', function() {
            const sliders = ['grounding', 'error', 'steerability', 'gravity'];
            sliders.forEach(id => {
                const slider = document.getElementById(`slider-${id}`);
                const label = document.getElementById(`label-${id}`);
                if (slider && label) {
                    slider.addEventListener('input', function() {
                        label.textContent = `(Variable: ${this.value}%)`;
                    });
                }
            });
        });

        // Toggle Logic Trace visibility
        function toggleLogicTrace() {
            const content = document.getElementById('logicTraceContent');
            const icon = document.getElementById('traceToggleIcon');
            const text = document.getElementById('traceToggleText');
            
            if (content.classList.contains('visible')) {
                content.classList.remove('visible');
                icon.textContent = 'üîç';
                text.textContent = 'View Logic Trace';
            } else {
                content.classList.add('visible');
                icon.textContent = 'üîº';
                text.textContent = 'Hide Logic Trace';
            }
        }

        // Load agent profile and trigger evaluation
        function loadAgentProfile(agentKey) {
            const profile = DOMAIN_PROFILES[agentKey];
            if (!profile) return;
            
            // Update sliders based on domain profile
            // Fixed principles stay at 100%
            document.getElementById('slider-ux').value = 100;
            document.getElementById('slider-handoff').value = 100;
            document.getElementById('slider-transparency').value = 100;
            document.getElementById('slider-privacy').value = 100;
            
            // Variable principles - set based on domain (convert 0-1 scale to 50-100)
            const groundingWeight = profile.weights['grounding-fidelity'] || 0.20;
            const errorWeight = profile.weights['error-recovery'] || 0.05;
            const steerabilityWeight = profile.weights['steerability'] || 0.15;
            
            // Map weights to slider values (higher weight = higher slider value)
            document.getElementById('slider-grounding').value = Math.round(50 + (groundingWeight * 100));
            document.getElementById('slider-error').value = Math.round(50 + (errorWeight * 200));
            document.getElementById('slider-steerability').value = Math.round(50 + (steerabilityWeight * 150));
            
            // Agent-specific examples
            const agentExamples = {
                health: {
                    name: 'WellnessCoach AI',
                    type: 'declarative',
                    instructions: 'You are a wellness coach AI. Always include medical disclaimer: "I am an AI assistant, not a medical professional. Always consult your doctor." Request explicit consent before accessing health data. Provide evidence-based fitness and nutrition guidance.',
                    manifest: `{"schema_version": "v2.1",
  "name": "WellnessCoach",
  "description": "AI wellness and fitness coach with privacy-first design",
  "capabilities": {
    "conversation_starters": [
      "Help me start exercising",
      "Create a personalized fitness plan"
    ]
  },
  "actions": [
    {"name": "createFitnessPlan", "description": "Generate personalized fitness plan", "requires_consent": true},
    {"name": "trackProgress", "description": "Track wellness goals with encrypted storage"}
  ]
}`,
                    apiActions: `async function trackProgress(userId) {
  // Request explicit consent for health data
  const consent = await requestPermission('HealthData.Read', 
    'I need access to your health data to track progress');
  
  if (!consent) {
    return { message: 'Manual tracking available without data access' };
  }
  
  // Use encrypted storage for PHI
  const healthData = await encryptedHealthAPI.getProgress(userId);
  return healthData;
}`,
                    description: `A health and wellness coaching agent that provides personalized fitness plans and nutrition guidance.

Key Privacy Features:
- HIPAA-compliant design with end-to-end encryption
- Medical disclaimer on every response
- Explicit consent required before accessing health data
- Zero-retention policy for PHI (Personal Health Information)
- 2FA required for sensitive operations

User Interaction:
- Supportive, motivational tone
- Evidence-based recommendations
- Clear explanation of data usage
- Graceful fallback if consent denied`,
                    trace: `User: Help me start exercising
Agent: I'm WellnessCoach, your AI fitness assistant! üí™

‚ö†Ô∏è Important: I am an AI assistant, not a medical professional. Always consult your doctor before starting a new exercise program.

To create a personalized plan, I'd like to access:
‚Ä¢ Your activity history
‚Ä¢ Health metrics (with encryption)

Is that okay?

User: Yes

Agent: Great! Based on your profile, here's Week 1:
‚Ä¢ 30-min cardio, 5x/week
‚Ä¢ Start with walking/jogging
‚Ä¢ Progress tracking with encrypted storage

I'll send daily reminders at 7am. Ready to start?`
                },
                finance: {
                    name: 'FinanceAdvisor AI',
                    type: 'declarative',
                    instructions: 'You are a financial information assistant. Always include disclaimer: "For informational purposes only, not financial advice. Consult a licensed advisor." Never provide specific stock picks. Focus on financial education and budgeting tools.',
                    manifest: `{"schema_version": "v2.1",
  "name": "FinanceAdvisor",
  "description": "AI financial education and budgeting assistant",
  "capabilities": {
    "conversation_starters": [
      "Help me create a budget",
      "Explain investment basics"
    ]
  },
  "actions": [
    {"name": "createBudget", "description": "Create personalized budget plan"},
    {"name": "explainConcept", "description": "Explain financial concepts with sources"}
  ]
}`,
                    apiActions: `async function createBudget(userInput) {
  // Educational tool - no account access needed
  const budgetPlan = await financialEducationAPI.generateBudget({
    income: userInput.income,
    expenses: userInput.expenses,
    goals: userInput.goals
  });
  
  // Include disclaimer
  budgetPlan.disclaimer = 'For informational purposes only, not financial advice.';
  return budgetPlan;
}`,
                    description: `A financial education assistant that helps with budgeting and understanding personal finance concepts.

Compliance Features:
- Mandatory disclaimer on all financial information
- No specific investment recommendations
- Read-only access to financial data
- Links to authoritative sources (SEC, FINRA)
- 2FA required for account access

User Interaction:
- Educational focus
- Clear explanations of concepts
- Budget planning tools
- Always cites reliable sources`,
                    trace: `User: Should I invest in stocks?
Agent: I'm FinanceAdvisor, here to help with financial education! üí∞

‚ö†Ô∏è Disclaimer: For informational purposes only, not financial advice. Consult a licensed advisor.

Let me explain investment basics:

Stock investing involves:
‚Ä¢ Market risk and volatility
‚Ä¢ Long-term growth potential
‚Ä¢ Diversification strategies

Source: SEC Investor Education

Would you like to learn about different investment types or create a savings plan?`
                },
                legal: {
                    name: 'LegalResearch AI',
                    type: 'declarative',
                    instructions: 'You are a legal research assistant. Always include disclaimer: "This is not legal advice. Consult a licensed attorney." Provide accurate citations for all legal information. Focus on research and information gathering, never direct legal advice.',
                    manifest: `{"schema_version": "v2.1",
  "name": "LegalResearch",
  "description": "AI legal research assistant with citation tracking",
  "capabilities": {
    "conversation_starters": [
      "Research case law on contract disputes",
      "Find relevant statutes"
    ]
  },
  "actions": [
    {"name": "searchCaseLaw", "description": "Search legal databases with citations"},
    {"name": "summarizeStatute", "description": "Summarize statutes with source links"}
  ]
}`,
                    apiActions: `async function searchCaseLaw(query) {
  // Research tool with full citation tracking
  const results = await legalDatabaseAPI.search(query);
  
  // Format with proper citations
  return results.map(case => ({
    citation: case.bluebookCitation,
    summary: case.summary,
    sourceLink: case.officialSource,
    confidence: case.relevanceScore
  }));
}`,
                    description: `A legal research assistant that helps find case law, statutes, and legal information with proper citations.

Key Features:
- Proper legal citations (Bluebook format)
- Source attribution for all information
- Confidence scores for search results
- Audit trail logging
- Read-only access to legal databases

User Interaction:
- Clear disclaimer on every response
- Detailed citations
- Never provides legal advice
- Explains research methodology`,
                    trace: `User: What are the elements of a valid contract?
Agent: I'm LegalResearch, your legal research assistant. ‚öñÔ∏è

‚ö†Ô∏è Important: This is not legal advice. Consult a licensed attorney.

Based on legal research:

Elements of a Valid Contract:
1. Offer and Acceptance
2. Consideration
3. Legal Capacity
4. Legal Purpose

Source: Restatement (Second) of Contracts ¬ß 17
Confidence: 95%

Would you like case law examples or more detail on any element?`
                },
                sales: {
                    name: 'SalesAssist AI',
                    type: 'declarative',
                    instructions: 'You are a sales support assistant. Prioritize fast, conversational responses. Help with product information, CRM updates, and customer inquiries. Be friendly and efficient.',
                    manifest: `{"schema_version": "v2.1",
  "name": "SalesAssist",
  "description": "AI sales support with fast response optimization",
  "capabilities": {
    "conversation_starters": [
      "Help me prepare for a sales call",
      "Update CRM with meeting notes"
    ]
  },
  "actions": [
    {"name": "searchProducts", "description": "Fast product search with caching"},
    {"name": "updateCRM", "description": "Update customer records"}
  ]
}`,
                    apiActions: `async function searchProducts(query) {
  // Optimized for speed with caching
  const cachedResult = await cache.get(query);
  if (cachedResult) return cachedResult;
  
  // Fast approximate search
  const results = await productAPI.fastSearch(query, { 
    timeout: 1000,
    approximateOK: true 
  });
  
  cache.set(query, results, { ttl: 3600 });
  return results;
}`,
                    description: `A sales support assistant optimized for fast, conversational interactions.

Performance Features:
- Response streaming for immediate feedback
- Cached common queries (<1s response)
- Approximate answers when speed matters
- Progressive disclosure of details

User Interaction:
- Friendly, conversational tone
- Quick product lookups
- CRM integration
- Meeting preparation assistance`,
                    trace: `User: Quick - what's the pricing for our Enterprise plan?
Agent: SalesAssist here! üíº

Enterprise Plan:
‚Ä¢ $299/user/month (annual)
‚Ä¢ $349/user/month (monthly)
‚Ä¢ Includes: All features + dedicated support

Want me to send you the full pricing sheet or help prepare a proposal?

User: Prepare proposal

Agent: On it! I'll pull together:
‚úì Pricing breakdown
‚úì Feature comparison
‚úì ROI calculator

Ready in 30 seconds!`
                },
                academic: {
                    name: 'AcademicResearch AI',
                    type: 'declarative',
                    instructions: 'You are an academic research assistant. Provide rigorous citations in academic format (APA, MLA, Chicago). Link to peer-reviewed sources. Include confidence intervals for data. Flag preliminary or unverified research.',
                    manifest: `{"schema_version": "v2.1",
  "name": "AcademicResearch",
  "description": "AI academic research assistant with citation management",
  "capabilities": {
    "conversation_starters": [
      "Help me find peer-reviewed sources",
      "Summarize recent research on a topic"
    ]
  },
  "actions": [
    {"name": "searchScholar", "description": "Search academic databases"},
    {"name": "formatCitation", "description": "Format citations in multiple styles"}
  ]
}`,
                    apiActions: `async function searchScholar(query, citationStyle = 'APA') {
  // Search peer-reviewed sources
  const results = await academicAPI.searchPeerReviewed(query);
  
  return results.map(paper => ({
    citation: formatCitation(paper, citationStyle),
    abstract: paper.abstract,
    doi: paper.doi,
    peerReviewStatus: paper.status,
    citationCount: paper.citations
  }));
}`,
                    description: `An academic research assistant that helps find and cite scholarly sources with proper academic rigor.

Academic Features:
- Peer-reviewed source verification
- Multiple citation formats (APA, MLA, Chicago)
- Confidence intervals for data
- Flags preliminary research
- DOI and persistent links

User Interaction:
- Scholarly tone
- Detailed methodology
- Source quality assessment
- Citation management`,
                    trace: `User: Find research on climate change impacts
Agent: I'm AcademicResearch, your scholarly assistant. üéì

Searching peer-reviewed sources...

Found 847 papers (2020-2024). Top 3:

1. Smith et al. (2023). "Global temperature trends"
   Nature Climate Change, 13(4), 234-245.
   DOI: 10.1038/s41558-023-01234-5
   Citations: 156 | Status: Peer-reviewed

2. Johnson & Lee (2024). "Ocean acidification rates"
   Science, 383(6680), 445-449.
   [Preliminary - not yet peer-reviewed]

Need citations in APA, MLA, or Chicago format?`
                },
                analyst: {
                    name: 'DataAnalyst AI',
                    type: 'declarative',
                    instructions: 'You are a data analysis assistant. Always show data sources and methodology. Include statistical confidence levels. Provide clear visualizations. Document assumptions and limitations.',
                    manifest: `{"schema_version": "v2.1",
  "name": "DataAnalyst",
  "description": "AI data analysis assistant with visualization tools",
  "capabilities": {
    "conversation_starters": [
      "Analyze sales trends",
      "Create data visualization"
    ]
  },
  "actions": [
    {"name": "analyzeData", "description": "Statistical analysis with confidence levels"},
    {"name": "createChart", "description": "Generate data visualizations"}
  ]
}`,
                    apiActions: `async function analyzeData(dataset, analysisType) {
  // Perform statistical analysis
  const analysis = await analyticsAPI.analyze(dataset, {
    type: analysisType,
    confidenceLevel: 0.95
  });
  
  return {
    results: analysis.results,
    confidence: analysis.confidence,
    methodology: analysis.method,
    assumptions: analysis.assumptions,
    dataSource: dataset.source
  };
}`,
                    description: `A data analysis assistant that provides rigorous analytical insights with clear visualizations.

Analytical Features:
- Statistical confidence levels (95% default)
- Documented methodology
- Clear data source attribution
- Assumption documentation
- Downloadable data tables

User Interaction:
- Data-driven insights
- Visual clarity
- Methodological transparency
- Limitation awareness`,
                    trace: `User: Analyze Q4 sales trends
Agent: I'm DataAnalyst, your data insights assistant! üìä

Analyzing Q4 sales data...

Results:
‚Ä¢ 23% increase vs Q3 (confidence: 95%)
‚Ä¢ Peak: Week of Dec 12 ($2.3M)
‚Ä¢ Top product: Enterprise licenses

Methodology: Time-series analysis with seasonal adjustment
Data Source: SalesDB 2024-Q4
Assumptions: Excluded returns, included pre-orders

[Chart showing weekly trend with confidence bands]

Want to drill down into any segment?`
                },
                projectmanager: {
                    name: 'ProjectCoordinator AI',
                    type: 'declarative',
                    instructions: 'You are a project management assistant. Maintain detailed context across sessions. Support multiple views (Gantt, Kanban). Enable seamless delegation. Track dependencies and blockers. Provide clear status summaries.',
                    manifest: `{"schema_version": "v2.1",
  "name": "ProjectCoordinator",
  "description": "AI project management with context preservation",
  "capabilities": {
    "conversation_starters": [
      "Show project status",
      "Update task dependencies"
    ]
  },
  "actions": [
    {"name": "updateTask", "description": "Update task with full context preservation"},
    {"name": "generateStatusReport", "description": "Create comprehensive status summary"}
  ]
}`,
                    apiActions: `async function updateTask(taskId, updates, context) {
  // Preserve full context for handoffs
  const task = await projectAPI.getTask(taskId);
  
  const updatedTask = await projectAPI.update(taskId, {
    ...updates,
    previousContext: task.context,
    handoffNotes: context.handoffNotes,
    dependencies: task.dependencies
  });
  
  // Notify dependent tasks
  await notifyDependencies(updatedTask);
  return updatedTask;
}`,
                    description: `A project management assistant that excels at coordination, context handoffs, and adaptive planning.

Coordination Features:
- Full context preservation across sessions
- Multiple project views (Gantt, Kanban, Timeline)
- Dependency tracking with blocker alerts
- Seamless task delegation with handoff notes
- Automated status summaries

User Interaction:
- Clear communication
- Proactive updates
- Context-aware responses
- Team coordination`,
                    trace: `User: What's the status of the website redesign?
Agent: I'm ProjectCoordinator, your project assistant! üìã

Website Redesign Project - Status Update:

‚úÖ Completed (3 tasks):
‚Ä¢ Design mockups (Sarah, Dec 15)
‚Ä¢ Content audit (Mike, Dec 18)

üîÑ In Progress (2 tasks):
‚Ä¢ Frontend dev (Alex, due Dec 22)
‚Ä¢ SEO optimization (Lisa, due Dec 20)

üö´ Blockers:
‚Ä¢ Design approval needed from stakeholder

Next Milestone: Beta launch (Jan 5)
At Risk: No - on track

Need me to update anything or send delegation notes?`
                }
            };
            
            const example = agentExamples[agentKey];
            if (example) {
                // Combine agent name and details in the textarea
                const combinedInput = `Agent Name: ${example.name}\n\nAGENT INSTRUCTIONS:\n${example.instructions || ''}\n\nMANIFEST:\n${example.manifest || ''}\n\nAPI ACTIONS:\n${example.apiActions || ''}\n\nDESCRIPTION:\n${example.description}\n\nSAMPLE INTERACTION:\n${example.trace || ''}`;
                
                // Store in hidden data attribute, keep placeholder visible
                const textarea = document.getElementById('featureDescription');
                textarea.setAttribute('data-hidden-content', combinedInput);
                // Don't set textarea.value so placeholder remains visible
                
                // Trigger evaluation immediately
                setTimeout(() => {
                    evaluateFeature();
                }, 500);
            }
        }

        // Load a template
        function loadTemplate(templateKey) {
            const template = TEMPLATES[templateKey];
            document.getElementById('featureName').value = template.name;
            
            // Combine all inputs into one field
            const combinedInput = `AGENT INSTRUCTIONS:\n${template.instructions || ''}\n\nMANIFEST:\n${template.manifest || ''}\n\nAPI ACTIONS:\n${template.apiActions || ''}\n\nDESCRIPTION:\n${template.description}\n\nSAMPLE INTERACTION:\n${template.trace || ''}`;
            document.getElementById('featureDescription').value = combinedInput;
            
            // Trigger live check after loading template
            performLiveCheck();
        }

        // Initialize event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('featureDescription').addEventListener('input', onDescriptionChange);
            
            // Initialize slider event listeners
            const sliders = ['grounding', 'error', 'steerability', 'gravity'];
            sliders.forEach(id => {
                const slider = document.getElementById(`slider-${id}`);
                const label = document.getElementById(`label-${id}`);
                if (slider && label) {
                    slider.addEventListener('input', function() {
                        label.textContent = `(Variable: ${this.value}%)`;
                    });
                }
            });
        });

        // Clear form
        function clearForm() {
            const textarea = document.getElementById('featureDescription');
            textarea.value = '';
            textarea.removeAttribute('data-hidden-content');
            document.getElementById('scoreCard').style.display = 'none';
            document.getElementById('principleCard').style.display = 'none';
            document.getElementById('liveFeedback').style.display = 'none';
            updatePrincipleIndicators({});
        }

        // Evaluate Feature (Simulated LLM Judge)
        async function evaluateFeature() {
            const textarea = document.getElementById('featureDescription');
            // Use hidden data if available (from agent profile), otherwise use visible text
            const fullText = (textarea.getAttribute('data-hidden-content') || textarea.value).trim();
            
            if (!fullText) {
                alert('Please provide agent details');
                return;
            }
            
            // Extract agent name from first line if it starts with "Agent Name:"
            const lines = fullText.split('\n');
            let featureName = 'Unnamed Agent';
            let description = fullText;
            if (lines[0] && lines[0].startsWith('Agent Name:')) {
                featureName = lines[0].replace('Agent Name:', '').trim();
            }

            try {
                // Show loading
                showLoading('Evaluating against platform principles...');

                // Use general domain profile (sliders will override during scoring)
                const domainProfile = DOMAIN_PROFILES.general;

                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 2000));

                console.log('Running evaluation with:', { featureName, description: description.substring(0, 100) });

                // Run evaluation - pass fullText as both description and trace
                const evaluation = runEvaluation(featureName, 'declarative', fullText, fullText, domainProfile);
                currentEvaluation = evaluation;

                // Add to history
                evaluationHistory.unshift(evaluation);
                updateHistory();
                updateStats();

                // Display results
                displayResults(evaluation);
            } catch (error) {
                console.error('Evaluation error:', error);
                console.error('Error stack:', error.stack);
                alert('An error occurred during evaluation. Please check the console for details.');
            } finally {
                hideLoading();
            }
        }

        // Platform Gravity Assessment
        function assessPlatformGravity(text) {
            const lowerText = text.toLowerCase();
            
            // Check for matches with existing platform capabilities
            const capabilityMatches = [];
            PLATFORM_CAPABILITIES.forEach(capability => {
                const matches = capability.keywords.filter(keyword => lowerText.includes(keyword));
                if (matches.length > 0) {
                    capabilityMatches.push({
                        capability: capability.name,
                        keywords: matches
                    });
                }
            });

            // Ubiquity Score (Universal Need)
            let ubiquityScore = 50;
            const universalKeywords = ['all', 'every', 'universal', 'common', 'standard', 'typical', 'most', 'many agents', 'multiple teams'];
            universalKeywords.forEach(keyword => {
                if (lowerText.includes(keyword)) ubiquityScore += 10;
            });
            if (lowerText.includes('specific') || lowerText.includes('niche') || lowerText.includes('specialized')) {
                ubiquityScore -= 20;
            }
            ubiquityScore = Math.min(100, Math.max(0, ubiquityScore));

            // Complexity Burden Score
            let complexityScore = 40;
            const complexityKeywords = ['security', 'compliance', 'encrypt', 'authenticate', 'regulate', 'complex logic', 'state management', 'scale', 'infrastructure'];
            complexityKeywords.forEach(keyword => {
                if (lowerText.includes(keyword)) complexityScore += 12;
            });
            if (lowerText.includes('simple') || lowerText.includes('straightforward') || lowerText.includes('basic')) {
                complexityScore -= 15;
            }
            complexityScore = Math.min(100, Math.max(0, complexityScore));

            // Interoperability Score
            let interopScore = 45;
            const interopKeywords = ['api', 'share', 'reuse', 'integrate', 'connect', 'cross-agent', 'other agents', 'multiple features'];
            interopKeywords.forEach(keyword => {
                if (lowerText.includes(keyword)) interopScore += 12;
            });
            if (lowerText.includes('standalone') || lowerText.includes('isolated') || lowerText.includes('independent')) {
                interopScore -= 15;
            }
            interopScore = Math.min(100, Math.max(0, interopScore));

            // Overall Gravity Score
            const gravityScore = Math.round(
                ubiquityScore * 0.35 + 
                complexityScore * 0.35 + 
                interopScore * 0.3
            );

            // Determine recommendation
            let recommendation = '';
            let label = '';
            if (gravityScore >= 75) {
                label = 'High Gravity - Platform Candidate';
                recommendation = 'This capability should be considered for platform-level implementation. Multiple agents would benefit from a shared, well-maintained solution.';
            } else if (gravityScore >= 50) {
                label = 'Medium Gravity - Monitor';
                recommendation = 'This capability shows some platform potential. Monitor for similar requests from other teams before promoting to platform level.';
            } else {
                label = 'Low Gravity - Feature Level';
                recommendation = 'This capability is appropriately scoped as a feature-level implementation. It serves a specialized use case.';
            }

            return {
                score: gravityScore,
                label,
                recommendation,
                ubiquity: ubiquityScore,
                complexity: complexityScore,
                interoperability: interopScore,
                capabilityMatches
            };
        }

        // Generate Logic Trace
        function generateLogicTrace(data) {
            const { featureName, description, combinedText, principleScores, gravityAssessment, overallScore, issues } = data;
            
            // Step 1: Evidence Retrieval
            const triggeredPrinciples = [];
            for (const [key, score] of Object.entries(principleScores)) {
                if (key !== 'platform-gravity' && score < 100) {
                    triggeredPrinciples.push(PRINCIPLES[key].name);
                }
            }

            // Step 2: Cross-Agent Intersection
            const capabilityOverlaps = gravityAssessment.capabilityMatches.map(match => {
                return `${match.capability} (matched: ${match.keywords.join(', ')})`;
            });

            // Step 3: Confidence calculation
            const criticalIssues = issues.filter(i => i.severity === 'critical').length;
            const warningIssues = issues.filter(i => i.severity === 'warning').length;
            const confidence = Math.round(100 - (criticalIssues * 15) - (warningIssues * 5));

            // Step 4: Strategic recommendation
            let strategicRec = '';
            if (gravityAssessment.score >= 75) {
                strategicRec = 'PROMOTE TO PLATFORM - Multiple agents would benefit from shared implementation.';
            } else if (gravityAssessment.score >= 50) {
                strategicRec = 'MONITOR - Shows platform potential. Track adoption patterns before promoting.';
            } else {
                strategicRec = 'KEEP AS FEATURE - Appropriately scoped for specialized use case.';
            }

            return {
                triggeredPrinciples,
                capabilityOverlaps,
                confidence,
                strategicRec,
                gravityScore: gravityAssessment.score,
                coherenceScore: overallScore,
                criticalIssues,
                warningIssues
            };
        }

        // Detect Agent Personality: Probabilistic (Sales/Creative) vs. Deterministic (Legal/Compliance)
        function detectAgentPersonality(featureType, text) {
            const lowerText = text.toLowerCase();
            
            // Deterministic indicators
            const deterministicKeywords = ['legal', 'compliance', 'regulate', 'audit', 'verification', 'citation', 'precise', 'accurate', 'deterministic', 'grounding'];
            const deterministicCount = deterministicKeywords.filter(k => lowerText.includes(k)).length;
            
            // Probabilistic indicators
            const probabilisticKeywords = ['sales', 'creative', 'conversational', 'brainstorm', 'ideate', 'riff', 'explore', 'sugges', 'proactive', 'steer'];
            const probabilisticCount = probabilisticKeywords.filter(k => lowerText.includes(k)).length;
            
            if (deterministicCount > probabilisticCount) {
                return 'deterministic';
            } else if (probabilisticCount > deterministicCount) {
                return 'probabilistic';
            }
            
            return 'balanced'; // Default
        }

        // Simulated Evaluation Engine
        function runEvaluation(featureName, featureType, description, trace, domainProfile = DOMAIN_PROFILES.general) {
            const lowerDesc = description.toLowerCase();
            const lowerTrace = trace.toLowerCase();
            const combinedText = lowerDesc + ' ' + lowerTrace;

            const principleScores = {};
            const issues = [];

            // UX Signature Evaluation
            let uxScore = 70;
            if (combinedText.includes('progressive') || combinedText.includes('show more') || combinedText.includes('initially')) {
                uxScore += 10;
            }
            if (combinedText.includes('copilot') || combinedText.includes('sidebar') || combinedText.includes('non-intrusive')) {
                uxScore += 10;
            }
            if (combinedText.includes('consistent') || combinedText.includes('design language') || combinedText.includes('card')) {
                uxScore += 5;
            }
            if (combinedText.includes('wall of text') || combinedText.includes('popup') || combinedText.includes('aggressive')) {
                uxScore -= 20;
                issues.push({
                    severity: 'warning',
                    principle: 'UX Signature',
                    title: 'Potentially Intrusive Patterns Detected',
                    description: 'The feature may use UI patterns that disrupt user flow (popups, aggressive CTAs).',
                    remediation: 'Use progressive disclosure and Copilot sidebar patterns. Avoid modal dialogs unless critical.'
                });
            }
            principleScores['ux-signature'] = Math.min(100, uxScore);

            // Handoff Integrity
            let handoffScore = 75;
            if (combinedText.includes('intent') || combinedText.includes('context') || combinedText.includes('continuity')) {
                handoffScore += 15;
            }
            if (combinedText.includes('handoff') || combinedText.includes('transfer') || combinedText.includes('preserv')) {
                handoffScore += 10;
            }
            if (!combinedText.includes('privacy') && !combinedText.includes('data protection')) {
                handoffScore -= 15;
                issues.push({
                    severity: 'warning',
                    principle: 'Handoff Integrity',
                    title: 'Privacy During Handoff Not Addressed',
                    description: 'No mention of how user data is protected when transferring between agents.',
                    remediation: 'Specify how context is preserved while maintaining privacy. Use encrypted handoff tokens.'
                });
            }
            principleScores['handoff-integrity'] = Math.min(100, handoffScore);

            // Grounding Fidelity
            let groundingScore = 70;
            if (combinedText.includes('data') && (combinedText.includes('accurate') || combinedText.includes('source'))) {
                groundingScore += 15;
            }
            if (combinedText.includes('citation') || combinedText.includes('reference') || combinedText.includes('evidence')) {
                groundingScore += 10;
            }
            if (!combinedText.includes('hallucin') && combinedText.length > 200) {
                groundingScore += 5;
            }
            if (combinedText.includes('makes up') || combinedText.includes('fabricat')) {
                groundingScore -= 25;
                issues.push({
                    severity: 'critical',
                    principle: 'Grounding Fidelity',
                    title: 'Risk of Hallucination Detected',
                    description: 'Feature may generate information not grounded in provided data.',
                    remediation: 'Implement strict grounding constraints. Cite sources for all factual claims. Use retrieval-augmented generation (RAG).'
                });
            }
            principleScores['grounding-fidelity'] = Math.min(100, groundingScore);

            // Transparency
            let transparencyScore = 65;
            if (combinedText.includes('i\'m') || combinedText.includes('i am') || combinedText.includes('agent')) {
                transparencyScore += 15;
            }
            if (combinedText.includes('capability') || combinedText.includes('limitation') || combinedText.includes('can\'t')) {
                transparencyScore += 15;
            }
            if (combinedText.includes('disclaimer') || combinedText.includes('not a professional') || combinedText.includes('not medical')) {
                transparencyScore += 10;
            }
            if (!combinedText.includes('i\'m') && !combinedText.includes('agent') && !combinedText.includes('assistant')) {
                issues.push({
                    severity: 'critical',
                    principle: 'Transparency',
                    title: 'Agent Identity Not Disclosed',
                    description: 'The feature does not clearly identify itself as an AI agent. Users may confuse it for human support.',
                    remediation: 'Start interactions with: "I\'m [AgentName], your AI assistant for [purpose]." Make AI identity unmistakable.'
                });
                transparencyScore -= 20;
            }
            principleScores['transparency'] = Math.min(100, transparencyScore);

            // Privacy
            let privacyScore = 60;
            if (combinedText.includes('data minimization') || combinedText.includes('only necessary')) {
                privacyScore += 15;
            }
            if (combinedText.includes('consent') || combinedText.includes('permission') || combinedText.includes('is that okay')) {
                privacyScore += 15;
            }
            if (combinedText.includes('retention') || combinedText.includes('delete') || combinedText.includes('clear data')) {
                privacyScore += 10;
            }
            if (combinedText.includes('collects all') || combinedText.includes('tracks everything')) {
                privacyScore -= 25;
                issues.push({
                    severity: 'critical',
                    principle: 'Privacy First',
                    title: 'Excessive Data Collection',
                    description: 'Feature appears to collect more data than necessary for its function.',
                    remediation: 'Apply data minimization principle. Collect only what\'s essential. Request just-in-time consent with clear explanations.'
                });
            }
            if (!combinedText.includes('consent') && !combinedText.includes('permission')) {
                issues.push({
                    severity: 'warning',
                    principle: 'Privacy First',
                    title: 'No Explicit Consent Mechanism',
                    description: 'The feature doesn\'t clearly ask for user permission before accessing sensitive data.',
                    remediation: 'Implement just-in-time consent requests. Explain why each permission is needed before asking.'
                });
                privacyScore -= 10;
            }
            principleScores['privacy'] = Math.min(100, privacyScore);

            // Error Recovery
            let errorScore = 70;
            if (combinedText.includes('fallback') || combinedText.includes('backup') || combinedText.includes('alternative')) {
                errorScore += 15;
            }
            if (combinedText.includes('graceful') || combinedText.includes('degradation')) {
                errorScore += 10;
            }
            if (combinedText.includes('error message') || combinedText.includes('clear error')) {
                errorScore += 5;
            }
            if (combinedText.includes('crash') || combinedText.includes('breaks')) {
                errorScore -= 20;
                issues.push({
                    severity: 'warning',
                    principle: 'Error Recovery',
                    title: 'Poor Error Handling',
                    description: 'Feature may not handle errors gracefully, potentially breaking user experience.',
                    remediation: 'Implement graceful degradation. Provide clear, actionable error messages. Always offer fallback options.'
                });
            }
            principleScores['error-recovery'] = Math.min(100, errorScore);

            // Steerability Evaluation (Context-Aware: Vertical vs. Horizontal)
            let steerabilityScore = 60;
            const agentPersonality = detectAgentPersonality(featureType, combinedText);
            
            // State Continuity
            if (combinedText.includes('remember') || combinedText.includes('context') || combinedText.includes('session') || combinedText.includes('continuity')) {
                steerabilityScore += 15;
            }
            
            // Steering Frequency & Real-time Adaptability
            if (combinedText.includes('adapt') || combinedText.includes('adjust') || combinedText.includes('refine') || combinedText.includes('steer')) {
                steerabilityScore += 12;
            }
            if (combinedText.includes('real-time') || combinedText.includes('live') || combinedText.includes('immediate feedback')) {
                steerabilityScore += 8;
            }
            
            // Conversational Adaptability
            if (combinedText.includes('conversational') || combinedText.includes('riff') || combinedText.includes('back-and-forth') || combinedText.includes('iterative')) {
                steerabilityScore += 10;
            }
            
            // Context-Aware Scoring: Different agents need different steerability levels
            if (agentPersonality === 'probabilistic') {
                // Sales/Creative agents NEED high steerability
                if (steerabilityScore < 75) {
                    issues.push({
                        severity: 'warning',
                        principle: 'Steerability',
                        title: 'Probabilistic Agent Needs Higher Steerability',
                        description: 'Sales/Creative agents require real-time steering, state continuity, and conversational adaptability to maintain user engagement.',
                        remediation: 'Implement state persistence across conversation turns. Add mid-flight correction capabilities. Optimize for <200ms latency to maintain conversational flow.'
                    });
                }
            } else if (agentPersonality === 'deterministic') {
                // Legal/Compliance agents need LESS steerability (more precision)
                if (steerabilityScore > 60) {
                    // This is actually fine - deterministic agents can have steerability, just not required
                    issues.push({
                        severity: 'info',
                        principle: 'Steerability',
                        title: 'Deterministic Agent: Precision Over Steering',
                        description: 'Legal/Compliance agents prioritize deep grounding and verifiable citations over real-time steerability. High latency (30s+) is acceptable for accuracy.',
                        remediation: 'Consider: Does this agent need real-time steering, or would a "verification-first" pipeline better serve its mission? Balance steerability with grounding fidelity.'
                    });
                }
            }
            
            // Missing steerability indicators
            if (!combinedText.includes('remember') && !combinedText.includes('context') && !combinedText.includes('adapt')) {
                issues.push({
                    severity: 'info',
                    principle: 'Steerability',
                    title: 'Limited Steerability Indicators',
                    description: 'No clear indication of how the agent maintains state or adapts to user steering during conversations.',
                    remediation: 'Add state continuity mechanisms: remember user preferences, conversational tone, and strategy across multi-turn interactions. Implement configurable steering frequency based on agent personality.'
                });
            }
            
            principleScores['steerability'] = Math.min(100, steerabilityScore);

            // Platform Gravity Assessment (not included in coherence score)
            const gravityAssessment = assessPlatformGravity(combinedText);
            principleScores['platform-gravity'] = gravityAssessment.score;

            // Calculate weighted overall score using domain profile weights
            let overallScore = 0;
            for (const [key, score] of Object.entries(principleScores)) {
                // Use domain profile weight if available, otherwise use default
                const weight = domainProfile.weights[key] || PRINCIPLES[key].weight;
                overallScore += score * weight;
            }

            // Add quality bonuses
            if (description.length > 500) overallScore += 2; // Detailed description
            if (trace.length > 200) overallScore += 2; // Interaction trace provided
            if (combinedText.includes('example:') || combinedText.includes('for instance:')) overallScore += 1;

            overallScore = Math.min(100, Math.round(overallScore));

            // Generate additional suggestions if score is high
            if (overallScore >= 85 && issues.length === 0) {
                issues.push({
                    severity: 'info',
                    principle: 'General',
                    title: 'Excellent Copilot Alignment! üéâ',
                    description: 'This extension demonstrates strong adherence to Copilot platform principles and is highly coherent with the platform.',
                    remediation: 'Continue monitoring real-world usage. Collect user feedback on clarity and helpfulness.'
                });
            }

            // Generate logic trace
            const logicTrace = generateLogicTrace({
                featureName,
                description,
                combinedText,
                principleScores,
                gravityAssessment,
                overallScore,
                issues
            });

            return {
                featureName,
                featureType,
                overallScore,
                principleScores,
                issues,
                gravityAssessment,
                logicTrace,
                agentPersonality: detectAgentPersonality(featureType, combinedText),
                timestamp: new Date().toISOString(),
                description: description.substring(0, 200)
            };
        }

        // Display Logic Trace
        function displayLogicTrace(trace, featureName) {
            const traceContent = document.getElementById('logicTraceContent');
            
            traceContent.innerHTML = `
                <div class="trace-header">[Logic Trace: Project 'Gravity']</div>
                
                <div class="trace-step">
                    <div class="trace-step-label">Step 1: Parsed Feature Spec</div>
                    <div class="trace-step-content">"${featureName}"</div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 2: Evidence Retrieval (Grounding)</div>
                    <div class="trace-step-content">
                        Scanning Principle Registry...<br>
                        ${trace.triggeredPrinciples.length > 0 ? 
                            `<span class="trace-highlight">Triggered:</span> ${trace.triggeredPrinciples.slice(0, 3).map(p => `'${p}'`).join(', ')}` : 
                            '<span class="trace-success">All principles satisfied ‚úì</span>'
                        }
                    </div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 3: Cross-Agent Intersection (Redundancy Check)</div>
                    <div class="trace-step-content">
                        ${trace.capabilityOverlaps.length > 0 ? 
                            `<span class="trace-warning">Found ${trace.capabilityOverlaps.length} existing platform capability overlap(s):</span><br>${trace.capabilityOverlaps.map(o => `‚Ä¢ ${o}`).join('<br>')}` : 
                            '<span class="trace-info">No redundancy detected with existing platform capabilities.</span>'
                        }
                    </div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 4: Analyzed Coherence</div>
                    <div class="trace-step-content">
                        Coherence Score: <span class="trace-highlight">${trace.coherenceScore}/100</span><br>
                        ${trace.criticalIssues > 0 ? `<span class="trace-warning">Critical issues detected: ${trace.criticalIssues}</span><br>` : ''}
                        ${trace.warningIssues > 0 ? `<span class="trace-info">Warnings: ${trace.warningIssues}</span>` : ''}
                        ${trace.criticalIssues === 0 && trace.warningIssues === 0 ? '<span class="trace-success">No major issues detected ‚úì</span>' : ''}
                    </div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 5: Calculated Gravity (Strategic Reasoning)</div>
                    <div class="trace-step-content">
                        Platform Gravity Score: <span class="trace-highlight">${trace.gravityScore}/100</span><br>
                        ${trace.gravityScore >= 75 ? 
                            '<span class="trace-success">High demand potential across ecosystem</span>' : 
                            trace.gravityScore >= 50 ? 
                            '<span class="trace-info">Moderate platform potential - monitor adoption</span>' : 
                            '<span class="trace-info">Domain-specific scope - appropriate as feature</span>'
                        }
                    </div>
                </div>

                <div class="trace-step">
                    <div class="trace-step-label">Step 6: Human-In-The-Loop Assessment</div>
                    <div class="trace-step-content">
                        <span class="trace-info">Confidence:</span> <span class="trace-highlight">${trace.confidence}%</span><br>
                        ${trace.confidence < 80 ? 
                            '<span class="trace-warning">‚ö† Human review recommended for final decision</span>' : 
                            '<span class="trace-success">High confidence - automated recommendation reliable</span>'
                        }
                    </div>
                </div>

                <div class="trace-conclusion">
                    <div class="trace-conclusion-label">CONCLUSION:</div>
                    <div style="color: #e2e8f0; font-size: 1.05em;">${trace.strategicRec}</div>
                </div>
            `;
        }

        // Display Results
        function displayPlatformGravity(gravity) {
            const gravitySection = document.getElementById('gravityAssessmentSection');
            
            gravitySection.innerHTML = `
                <div class="platform-gravity-section">
                    <h3>üöÄ Platform Gravity Assessment</h3>
                    
                    <div class="gravity-metrics">
                        <div class="gravity-metric">
                            <div class="gravity-metric-label">Ubiquity</div>
                            <div class="gravity-metric-bar">
                                <div class="gravity-metric-fill" style="width: ${gravity.ubiquity}%"></div>
                                <div class="gravity-metric-value">${gravity.ubiquity}</div>
                            </div>
                        </div>
                        <div class="gravity-metric">
                            <div class="gravity-metric-label">Complexity</div>
                            <div class="gravity-metric-bar">
                                <div class="gravity-metric-fill" style="width: ${gravity.complexity}%"></div>
                                <div class="gravity-metric-value">${gravity.complexity}</div>
                            </div>
                        </div>
                        <div class="gravity-metric">
                            <div class="gravity-metric-label">Interop</div>
                            <div class="gravity-metric-bar">
                                <div class="gravity-metric-fill" style="width: ${gravity.interoperability}%"></div>
                                <div class="gravity-metric-value">${gravity.interoperability}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="platform-recommendation">
                        <strong>üí° Recommendation:</strong>
                        ${gravity.recommendation}
                    </div>
                    
                    ${gravity.capabilityMatches.length > 0 ? `
                        <div class="capability-matches">
                            <strong>‚ö†Ô∏è Existing Platform Capabilities Detected:</strong>
                            ${gravity.capabilityMatches.map(match => `
                                <div class="capability-item">
                                    <strong>${match.capability}</strong> - Consider using instead of reimplementing
                                    <div style="font-size: 0.9em; opacity: 0.8; margin-top: 4px;">Matched: ${match.keywords.join(', ')}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Display Steerability Analysis
        function displaySteerabilityAnalysis(steerabilityScore, agentPersonality) {
            const gravitySection = document.getElementById('gravityAssessmentSection');
            
            let personalityLabel, personalityColor, personalityDesc, enforcementRec;
            
            if (agentPersonality === 'probabilistic') {
                personalityLabel = 'Probabilistic Personality';
                personalityColor = '#8B5CF6';
                personalityDesc = 'Sales/Creative agent requiring high steerability, low latency (<200ms), and conversational adaptability.';
                enforcementRec = '<strong>Configurable Enforcements:</strong> Enable Fast RAG (speed over precision), High Steering Frequency (check back every 2-3 turns), Large Context Window for state continuity.';
            } else if (agentPersonality === 'deterministic') {
                personalityLabel = 'Deterministic Personality';
                personalityColor = '#10b981';
                personalityDesc = 'Legal/Compliance agent prioritizing deep grounding, verifiable citations, and 100% precision over speed.';
                enforcementRec = '<strong>Configurable Enforcements:</strong> Enable Verification RAG (precision over speed), Low Steering Frequency (batch processing acceptable), Enforcement for Verifiable Citations.';
            } else {
                personalityLabel = 'Balanced Personality';
                personalityColor = '#f59e0b';
                personalityDesc = 'General-purpose agent with balanced needs for steerability and precision.';
                enforcementRec = '<strong>Configurable Enforcements:</strong> Enable Moderate RAG (balanced speed/accuracy), Medium Steering Frequency, Standard Context Window.';
            }
            
            const steerabilityHtml = `
                <div class="platform-gravity-section" style="border-top-color: ${personalityColor};">
                    <h3>üéØ Steerability Analysis (Platform Elasticity)</h3>
                    
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${personalityColor};">
                        <div style="font-weight: 700; color: ${personalityColor}; margin-bottom: 8px;">${personalityLabel}</div>
                        <div style="font-size: 0.9em; color: #4b5563; margin-bottom: 12px;">${personalityDesc}</div>
                        <div style="font-size: 0.85em; line-height: 1.6; color: #6b7280;">${enforcementRec}</div>
                    </div>
                    
                    <div class="gravity-metrics">
                        <div class="gravity-metric">
                            <div class="gravity-metric-label">Steerability Score</div>
                            <div style="font-size: 1.8em; font-weight: 700; color: ${personalityColor};">${steerabilityScore}</div>
                        </div>
                        <div class="gravity-metric">
                            <div class="gravity-metric-label">Target Latency</div>
                            <div style="font-size: 1.2em; font-weight: 600; color: #6b7280;">
                                ${agentPersonality === 'probabilistic' ? '<200ms' : agentPersonality === 'deterministic' ? '30s+' : '1-5s'}
                            </div>
                        </div>
                        <div class="gravity-metric">
                            <div class="gravity-metric-label">RAG Strategy</div>
                            <div style="font-size: 0.85em; font-weight: 600; color: #6b7280; margin-top: 4px;">
                                ${agentPersonality === 'probabilistic' ? 'Fast RAG' : agentPersonality === 'deterministic' ? 'Verify RAG' : 'Balanced'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="platform-recommendation" style="border-left-color: ${personalityColor};">
                        <strong>üí° Systems Architect Insight:</strong>
                        The platform's job isn't to make all agents the same; it's to provide <strong>Policy-Driven Orchestration</strong> with configurable levers:
                        <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                            <li><strong>Grounding Intensity:</strong> Fast RAG vs. Verification RAG</li>
                            <li><strong>Steering Frequency:</strong> Real-time (Sales) vs. Batch (Legal)</li>
                            <li><strong>Context Density:</strong> Large token window (deep reasoning) vs. tight window (speed)</li>
                        </ul>
                        This is <strong>Platform Elasticity</strong>: enabling vertical personalities to coexist without creating siloed stacks.
                    </div>
                </div>
            `;
            
            gravitySection.insertAdjacentHTML('beforeend', steerabilityHtml);
        }

        function displayResults(evaluation) {
            const scoreCard = document.getElementById('scoreCard');
            const principleCard = document.getElementById('principleCard');

            // Update title with agent name
            document.getElementById('scoreCardTitle').textContent = `Assessment Score for "${evaluation.featureName}"`;

            scoreCard.style.display = 'block';
            scoreCard.classList.add('animate-in');
            principleCard.style.display = 'block';
            principleCard.classList.add('animate-in');

            // Binary Coherence Assessment
            const score = evaluation.overallScore;
            const isCoherent = score >= 70;
            const scoreValueEl = document.getElementById('scoreValue');
            const coherenceLabelEl = document.getElementById('coherenceLabel');
            
            if (isCoherent) {
                scoreValueEl.innerHTML = '<svg width="70" height="70" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" fill="#22c55e" stroke="#16a34a" stroke-width="2"/><path d="M30 52 L42 64 L70 36" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>';
                scoreValueEl.style.color = '#10b981';
                coherenceLabelEl.textContent = 'Coherent';
                coherenceLabelEl.style.color = '#10b981';
            } else {
                scoreValueEl.innerHTML = '<svg width="70" height="70" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" fill="#ef4444" stroke="#dc2626" stroke-width="2"/><path d="M35 35 L65 65 M65 35 L35 65" stroke="white" stroke-width="8" stroke-linecap="round"/></svg>';
                scoreValueEl.style.color = '#ef4444';
                coherenceLabelEl.textContent = 'Not Coherent';
                coherenceLabelEl.style.color = '#ef4444';
            }

            // Binary Gravity Assessment
            const gravityScore = evaluation.gravityAssessment.score;
            const isPlatformCandidate = gravityScore >= 65;
            const gravityValueEl = document.getElementById('gravityValue');
            const gravityLabelEl = document.getElementById('gravityLabel');
            
            if (isPlatformCandidate) {
                // Platform level - show yellow warning triangle
                gravityValueEl.innerHTML = '<svg width="70" height="70" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 10 L90 85 L10 85 Z" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/><circle cx="50" cy="75" r="3" fill="#92400e"/><rect x="47" y="35" width="6" height="30" rx="2" fill="#92400e"/></svg>';
                gravityValueEl.style.color = '#fbbf24';
                gravityLabelEl.textContent = 'Platform Candidate';
                gravityLabelEl.style.color = '#fbbf24';
            } else {
                // Feature level - show green checkmark
                gravityValueEl.innerHTML = '<svg width="70" height="70" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" fill="#22c55e" stroke="#16a34a" stroke-width="2"/><path d="M30 52 L42 64 L70 36" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>';
                gravityValueEl.style.color = '#10b981';
                gravityLabelEl.textContent = 'Feature Level';
                gravityLabelEl.style.color = '#10b981';
            }

            // Display principle scores
            const principleScoresEl = document.getElementById('principleScores');
            principleScoresEl.innerHTML = '<h3 style="font-size: 0.9em; margin-bottom: 12px; color: #6b7280; text-align: left;">Principle Breakdown</h3>';

            // Get threshold from sliders (convert 50-100 range to 0-100 percentage)
            const getThreshold = (principleKey) => {
                const sliderMap = {
                    'ux-signature': 'ux',
                    'handoff-integrity': 'handoff',
                    'grounding-fidelity': 'grounding',
                    'transparency': 'transparency',
                    'privacy': 'privacy',
                    'error-recovery': 'error',
                    'steerability': 'steerability'
                };
                const sliderId = sliderMap[principleKey];
                if (!sliderId) return 70; // default
                const sliderValue = parseInt(document.getElementById(`slider-${sliderId}`).value);
                return sliderValue; // Already in 0-100 range
            };
            
            // Coherence Principles
            for (const [key, score] of Object.entries(evaluation.principleScores)) {
                const principle = PRINCIPLES[key];
                if (key === 'platform-gravity') continue; // Skip platform gravity in main loop
                
                const threshold = getThreshold(key);
                const isPassing = score >= threshold;
                const icon = isPassing 
                    ? '<svg width="24" height="24" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M30 52 L42 64 L70 36" stroke="#10b981" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>'
                    : '<svg width="24" height="24" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M35 35 L65 65 M65 35 L35 65" stroke="#ef4444" stroke-width="8" stroke-linecap="round"/></svg>';
                const iconClass = isPassing ? 'pass' : 'fail';

                const item = document.createElement('div');
                item.className = 'principle-score-item';
                item.innerHTML = `
                    <span class="name">${principle.name}</span>
                    <div class="principle-icon ${iconClass}">${icon}</div>
                `;
                principleScoresEl.appendChild(item);
            }

            // Add Platform Gravity Breakdown
            const gravitySection = document.createElement('div');
            gravitySection.style.cssText = 'margin-top: 20px; padding-top: 20px; border-top: 2px solid #f3f4f6;';
            gravitySection.innerHTML = '<h3 style="font-size: 0.9em; margin-bottom: 12px; color: #7C3AED; font-weight: 600; text-align: left;">Platform Gravity Factors</h3>';
            
            const gravity = evaluation.gravityAssessment;
            const gravityMetrics = [
                { label: 'Universal Need', value: gravity.ubiquity },
                { label: 'Complexity Burden', value: gravity.complexity },
                { label: 'Interoperability', value: gravity.interoperability },
                { label: 'Steerability Support', value: gravity.steerability || 70 },
                { label: 'Memory & Context', value: gravity.memory || 70 }
            ];
            
            // Use fixed 70% threshold for gravity factors (no user adjustment)
            const gravityThreshold = 70;
            
            gravityMetrics.forEach(metric => {
                const isPassing = metric.value >= gravityThreshold;
                const icon = isPassing 
                    ? '<svg width="24" height="24" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M30 52 L42 64 L70 36" stroke="#10b981" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>'
                    : '<svg width="24" height="24" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M35 35 L65 65 M65 35 L35 65" stroke="#ef4444" stroke-width="8" stroke-linecap="round"/></svg>';
                const iconClass = isPassing ? 'pass' : 'fail';
                
                const item = document.createElement('div');
                item.className = 'principle-score-item';
                item.innerHTML = `
                    <span class="name">${metric.label}</span>
                    <div class="principle-icon ${iconClass}">${icon}</div>
                `;
                gravitySection.appendChild(item);
            });
            
            principleScoresEl.appendChild(gravitySection);

            // Scroll to results
            scoreCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Update history list
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (evaluationHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <h3>No evaluations yet</h3>
                        <p>Start by evaluating your first feature</p>
                    </div>
                `;
                return;
            }

            evaluationHistory.slice(0, 10).forEach((evaluation, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                // Binary assessment
                const isCoherent = evaluation.overallScore >= 70;
                const scoreIcon = isCoherent ? '‚úÖ' : '‚ùå';
                const scoreColor = isCoherent ? '#10b981' : '#ef4444';

                const timeAgo = getTimeAgo(new Date(evaluation.timestamp));

                item.innerHTML = `
                    <div class="history-item-header">
                        <span class="history-item-name">${evaluation.featureName}</span>
                        <span class="history-item-score" style="color: ${scoreColor}; font-size: 1.3em;">${scoreIcon}</span>
                    </div>
                    <div class="history-item-meta">${evaluation.featureType} ‚Ä¢ ${timeAgo}</div>
                `;

                item.onclick = () => {
                    currentEvaluation = evaluation;
                    displayResults(evaluation);
                };

                historyList.appendChild(item);
            });
        }

        // Update session stats
        function updateStats() {
            document.getElementById('totalEvals').textContent = evaluationHistory.length;
            
            if (evaluationHistory.length > 0) {
                // Count agents that need improvement (score < 70)
                const needsImprovement = evaluationHistory.filter(e => e.overallScore < 70).length;
                document.getElementById('certifiedCount').textContent = needsImprovement;
                
                const platformCandidates = evaluationHistory.filter(e => e.gravityAssessment && e.gravityAssessment.score >= 65).length;
                document.getElementById('platformCandidates').textContent = platformCandidates;
            }
        }

        // Export report
        function exportReport(format) {
            if (!currentEvaluation) return;

            if (format === 'json') {
                const dataStr = JSON.stringify(currentEvaluation, null, 2);
                downloadFile(`${currentEvaluation.featureName}-report.json`, dataStr, 'application/json');
            } else if (format === 'markdown') {
                const md = generateMarkdownReport(currentEvaluation);
                downloadFile(`${currentEvaluation.featureName}-report.md`, md, 'text/markdown');
            }
        }

        function generateMarkdownReport(evaluation) {
            let md = `# Copilot Coherence Report: ${evaluation.featureName}\n\n`;
            md += `**Date:** ${new Date(evaluation.timestamp).toLocaleString()}\n`;
            md += `**Type:** ${evaluation.featureType}\n`;
            md += `**Overall Score:** ${evaluation.overallScore}/100\n\n`;

            md += `## Principle Scores\n\n`;
            for (const [key, score] of Object.entries(evaluation.principleScores)) {
                const principle = PRINCIPLES[key];
                md += `- **${principle.name}:** ${score}/100\n`;
            }

            md += `\n## Issues & Recommendations\n\n`;
            if (evaluation.issues.length === 0) {
                md += `No issues found! This extension demonstrates excellent alignment with Copilot principles.\n`;
            } else {
                evaluation.issues.forEach((issue, i) => {
                    md += `### ${i + 1}. ${issue.title} [${issue.severity.toUpperCase()}]\n\n`;
                    md += `**Principle:** ${issue.principle}\n\n`;
                    md += `${issue.description}\n\n`;
                    md += `**Remediation:** ${issue.remediation}\n\n`;
                });
            }

            return md;
        }

        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Helper functions
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function showLoading(message) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div class="loading-text">${message}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('‚ú® Gravity Coherence Scorecard initialized');
            console.log('Platform Principles loaded:', Object.keys(PRINCIPLES).length);
        });
    </script>
</body>
</html>